├── controller
│   ├── PriceController.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.controller;
│   │     
│   │     import com.retailmanagement.dto.request.UpsertPriceRequest;
│   │     import com.retailmanagement.dto.response.ApiResponse;
│   │     import com.retailmanagement.dto.response.VariantPriceResponse;
│   │     import com.retailmanagement.entity.PriceHistory;
│   │     import com.retailmanagement.service.PricingService;
│   │     import org.springframework.web.bind.annotation.*;
│   │     
│   │     import java.util.List;
│   │     
│   │     @RestController
│   │     @RequestMapping("/api/prices")
│   │     public class PriceController {
│   │     
│   │         private final PricingService pricingService;
│   │     
│   │         public PriceController(PricingService pricingService) {
│   │             this.pricingService = pricingService;
│   │         }
│   │     
│   │         // Tạo/đổi giá variant + ghi history
│   │         @PostMapping("/variants/{variantId}")
│   │         public ApiResponse<PriceHistory> setVariantPrice(@PathVariable Integer variantId,
│   │                                                          @RequestBody UpsertPriceRequest req) {
│   │             // nếu bạn có auth: lấy userId từ SecurityContext, tạm set null/0
│   │             PriceHistory ph = pricingService.setVariantPrice(variantId, req, 0);
│   │             return ApiResponse.success(ph);
│   │         }
│   │     
│   │         // Danh sách giá theo sản phẩm (kèm finalPrice sau promo)
│   │         @GetMapping("/products/{productId}")
│   │         public ApiResponse<List<VariantPriceResponse>> listByProduct(@PathVariable Integer productId) {
│   │             return ApiResponse.success(pricingService.listCurrentPricesByProduct(productId));
│   │         }
│   │     
│   │         // Sửa bản ghi giá hiện tại
│   │         @PutMapping("/history/{id}")
│   │         public ApiResponse<PriceHistory> updateLatest(@PathVariable Long id, @RequestBody UpsertPriceRequest req) {
│   │             return ApiResponse.success(pricingService.updateLatestHistory(id, req));
│   │         }
│   │     
│   │         // Xóa bản ghi giá hiện tại và rollback
│   │         @DeleteMapping("/history/{id}")
│   │         public ApiResponse<String> deleteLatest(@PathVariable Long id) {
│   │             pricingService.deleteLatestAndRollback(id);
│   │             return ApiResponse.success("OK");
│   │         }
│   │     
│   │         // Giá hiện tại sau khuyến mãi theo variant
│   │         @GetMapping("/variants/{variantId}/effective")
│   │         public ApiResponse<VariantPriceResponse> getEffective(@PathVariable Integer variantId) {
│   │             return ApiResponse.success(pricingService.getEffectivePrice(variantId));
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   └── PromotionController.java
│       ---- CODE ----
│         package com.retailmanagement.controller;
│         
│         import com.retailmanagement.dto.request.PromotionRequest;
│         import com.retailmanagement.dto.response.ApiResponse;
│         import com.retailmanagement.entity.Promotion;
│         import com.retailmanagement.service.PromotionService;
│         import org.springframework.web.bind.annotation.*;
│         
│         import java.util.List;
│         
│         @RestController
│         @RequestMapping("/api/promotions")
│         public class PromotionController {
│         
│             private final PromotionService promotionService;
│         
│             public PromotionController(PromotionService promotionService) {
│                 this.promotionService = promotionService;
│             }
│         
│             @PostMapping
│             public ApiResponse<Promotion> create(@RequestBody PromotionRequest req) {
│                 // nếu có auth: lấy userId thật
│                 return ApiResponse.success(promotionService.create(req, 0));
│             }
│         
│             @GetMapping
│             public ApiResponse<List<Promotion>> list(@RequestParam(required = false) Boolean activeOnly) {
│                 return ApiResponse.success(promotionService.list(activeOnly));
│             }
│         
│             @PutMapping("/{id}")
│             public ApiResponse<Promotion> update(@PathVariable Integer id, @RequestBody PromotionRequest req) {
│                 return ApiResponse.success(promotionService.update(id, req));
│             }
│         
│             @DeleteMapping("/{id}")
│             public ApiResponse<String> delete(@PathVariable Integer id) {
│                 promotionService.delete(id);
│                 return ApiResponse.success("OK");
│             }
│         }
│         
│       ---- END ----
├── dto
│   ├── request
│   │   ├── PromotionRequest.java
│   │   │   ---- CODE ----
│   │   │     package com.retailmanagement.dto.request;
│   │   │     
│   │   │     import lombok.Getter;
│   │   │     import lombok.Setter;
│   │   │     
│   │   │     import java.math.BigDecimal;
│   │   │     import java.time.LocalDateTime;
│   │   │     import java.util.List;
│   │   │     
│   │   │     @Getter
│   │   │     @Setter
│   │   │     public class PromotionRequest {
│   │   │     
│   │   │         private String code;
│   │   │         private String name;
│   │   │         private String description;
│   │   │     
│   │   │         // PERCENT / AMOUNT
│   │   │         private String discountType;
│   │   │         private BigDecimal discountValue;
│   │   │     
│   │   │         private LocalDateTime startDate;
│   │   │         private LocalDateTime endDate;
│   │   │     
│   │   │         // ALL / PRODUCT / VARIANT
│   │   │         private String scope;
│   │   │         private List<Integer> productIds;
│   │   │         private List<Integer> variantIds;
│   │   │     
│   │   │         private Integer priority = 0;
│   │   │         private Boolean stackable = false;
│   │   │         private Boolean isActive = true;
│   │   │     }
│   │   │     
│   │   │   ---- END ----
│   │   └── UpsertPriceRequest.java
│   │       ---- CODE ----
│   │         package com.retailmanagement.dto.request;
│   │         
│   │         import java.math.BigDecimal;
│   │         import lombok.Getter;
│   │         import lombok.Setter;
│   │         
│   │         @Getter
│   │         @Setter
│   │         public class UpsertPriceRequest {
│   │         
│   │             private String currencyCode;   // null -> dùng DEFAULT_CURRENCY
│   │             private BigDecimal price;
│   │             private BigDecimal costPrice;
│   │             private String reason;          // MANUAL / PROMO ...
│   │         }
│   │         
│   │       ---- END ----
│   └── response
│       ├── ApiResponse.java
│       │   ---- CODE ----
│       │     package com.retailmanagement.dto.response;
│       │     
│       │     import lombok.AllArgsConstructor;
│       │     import lombok.Data;
│       │     import lombok.NoArgsConstructor;
│       │     
│       │     @Data
│       │     @NoArgsConstructor
│       │     @AllArgsConstructor
│       │     public class ApiResponse<T> {
│       │     
│       │         private boolean success;
│       │         private String message;
│       │         private T data;
│       │     
│       │         public static <T> ApiResponse<T> success(T data) {
│       │             return new ApiResponse<>(true, "Success", data);
│       │         }
│       │     
│       │         public static <T> ApiResponse<T> success(String message, T data) {
│       │             return new ApiResponse<>(true, message, data);
│       │         }
│       │     
│       │         public static <T> ApiResponse<T> error(String message) {
│       │             return new ApiResponse<>(false, message, null);
│       │         }
│       │     
│       │         public static <T> ApiResponse<T> error(String message, T data) {
│       │             return new ApiResponse<>(false, message, data);
│       │         }
│       │     }
│       │     
│       │   ---- END ----
│       └── VariantPriceResponse.java
│           ---- CODE ----
│             package com.retailmanagement.dto.response;
│             
│             import lombok.Data;
│             
│             import java.math.BigDecimal;
│             
│             @Data
│             public class VariantPriceResponse {
│             
│                 private Integer variantId;
│                 private Integer productId;
│                 private String variantName;
│                 private String sku;
│             
│                 private String currencyCode;
│                 private BigDecimal price;
│                 private BigDecimal costPrice;
│             
│                 // promo
│                 private String promotionCode;
│                 private BigDecimal finalPrice;
│             }
│             
│           ---- END ----
├── entity
│   ├── PriceHistory.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import jakarta.validation.constraints.NotNull;
│   │     import jakarta.validation.constraints.Size;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.ColumnDefault;
│   │     import org.hibernate.annotations.Nationalized;
│   │     import org.hibernate.annotations.OnDelete;
│   │     import org.hibernate.annotations.OnDeleteAction;
│   │     
│   │     import java.math.BigDecimal;
│   │     import java.time.Instant;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @Entity
│   │     @Table(name = "price_history")
│   │     public class PriceHistory {
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         @Column(name = "id", nullable = false)
│   │         private Long id;
│   │     
│   │         @NotNull
│   │         @ManyToOne(fetch = FetchType.LAZY, optional = false)
│   │         @OnDelete(action = OnDeleteAction.CASCADE)
│   │         @JoinColumn(name = "variant_id", nullable = false)
│   │         private ProductVariant variant;
│   │     
│   │         @Size(max = 3)
│   │         @NotNull
│   │         @ColumnDefault("'VND'")
│   │         @Column(name = "currency_code", nullable = false, length = 3)
│   │         private String currencyCode;
│   │     
│   │         @NotNull
│   │         @Column(name = "price", nullable = false, precision = 12, scale = 2)
│   │         private BigDecimal price;
│   │     
│   │         @Column(name = "cost_price", precision = 12, scale = 2)
│   │         private BigDecimal costPrice;
│   │     
│   │         @Size(max = 200)
│   │         @Nationalized
│   │         @Column(name = "reason", length = 200)
│   │         private String reason;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "effective_from", nullable = false)
│   │         private Instant effectiveFrom;
│   │     
│   │         @Column(name = "effective_to")
│   │         private Instant effectiveTo;
│   │     
│   │         @ManyToOne(fetch = FetchType.LAZY)
│   │         @OnDelete(action = OnDeleteAction.SET_NULL)
│   │         @JoinColumn(name = "created_by")
│   │         private User createdBy;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "created_at", nullable = false)
│   │         private Instant createdAt;
│   │     
│   │     }
│   │   ---- END ----
│   ├── Product.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.Column;
│   │     import jakarta.persistence.Entity;
│   │     import jakarta.persistence.GeneratedValue;
│   │     import jakarta.persistence.GenerationType;
│   │     import jakarta.persistence.Id;
│   │     import jakarta.persistence.Table;
│   │     import lombok.Getter;
│   │     import lombok.NoArgsConstructor;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.CreationTimestamp;
│   │     import org.hibernate.annotations.UpdateTimestamp;
│   │     
│   │     import java.time.LocalDateTime;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @NoArgsConstructor
│   │     @Entity
│   │     @Table(name = "products")
│   │     public class Product {
│   │     
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         private Integer id;
│   │     
│   │         @Column(nullable = false, length = 200)
│   │         private String name;
│   │     
│   │         @Column(nullable = false, unique = true, length = 100)
│   │         private String sku;
│   │     
│   │         @Column(columnDefinition = "NVARCHAR(MAX)")
│   │         private String description;
│   │     
│   │         @Column(name = "is_visible", nullable = false)
│   │         private Boolean isVisible = true;
│   │     
│   │         @CreationTimestamp
│   │         @Column(name = "created_at", updatable = false)
│   │         private LocalDateTime createdAt;
│   │     
│   │         @UpdateTimestamp
│   │         @Column(name = "updated_at")
│   │         private LocalDateTime updatedAt;
│   │     }
│   │     
│   │   ---- END ----
│   ├── ProductVariant.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import jakarta.validation.constraints.NotNull;
│   │     import jakarta.validation.constraints.Size;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.ColumnDefault;
│   │     import org.hibernate.annotations.Nationalized;
│   │     import org.hibernate.annotations.OnDelete;
│   │     import org.hibernate.annotations.OnDeleteAction;
│   │     
│   │     import java.math.BigDecimal;
│   │     import java.time.Instant;
│   │     import java.util.LinkedHashSet;
│   │     import java.util.Set;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @Entity
│   │     @Table(name = "product_variants")
│   │     public class ProductVariant {
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         @Column(name = "id", nullable = false)
│   │         private Integer id;
│   │     
│   │         @NotNull
│   │         @ManyToOne(fetch = FetchType.LAZY, optional = false)
│   │         @OnDelete(action = OnDeleteAction.CASCADE)
│   │         @JoinColumn(name = "product_id", nullable = false)
│   │         private Product product;
│   │     
│   │         @Size(max = 150)
│   │         @NotNull
│   │         @Nationalized
│   │         @Column(name = "variant_name", nullable = false, length = 150)
│   │         private String variantName;
│   │     
│   │         @Size(max = 100)
│   │         @NotNull
│   │         @Nationalized
│   │         @Column(name = "sku", nullable = false, length = 100)
│   │         private String sku;
│   │     
│   │         @Size(max = 100)
│   │         @Nationalized
│   │         @Column(name = "barcode", length = 100)
│   │         private String barcode;
│   │     
│   │         @Size(max = 3)
│   │         @NotNull
│   │         @ColumnDefault("'VND'")
│   │         @Column(name = "currency_code", nullable = false, length = 3)
│   │         private String currencyCode;
│   │     
│   │         @NotNull
│   │         @Column(name = "price", nullable = false, precision = 12, scale = 2)
│   │         private BigDecimal price;
│   │     
│   │         @Column(name = "cost_price", precision = 12, scale = 2)
│   │         private BigDecimal costPrice;
│   │     
│   │         @Nationalized
│   │         @Lob
│   │         @Column(name = "price_tiers_json")
│   │         private String priceTiersJson;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("0")
│   │         @Column(name = "stock_quantity", nullable = false)
│   │         private Integer stockQuantity;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("0")
│   │         @Column(name = "reserved_qty", nullable = false)
│   │         private Integer reservedQty;
│   │     
│   │         @Nationalized
│   │         @Lob
│   │         @Column(name = "attributes_json")
│   │         private String attributesJson;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("1")
│   │         @Column(name = "is_active", nullable = false)
│   │         private Boolean isActive = false;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "created_at", nullable = false)
│   │         private Instant createdAt;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "updated_at", nullable = false)
│   │         private Instant updatedAt;
│   │     
│   │         @Column(name = "deleted_at")
│   │         private Instant deletedAt;
│   │     
│   │         @OneToMany(mappedBy = "variant")
│   │         private Set<Image> images = new LinkedHashSet<>();
│   │     
│   │         @OneToMany(mappedBy = "variant")
│   │         private Set<OrderItem> orderItems = new LinkedHashSet<>();
│   │     
│   │         @OneToMany(mappedBy = "variant")
│   │         private Set<PriceHistory> priceHistories = new LinkedHashSet<>();
│   │     
│   │         @OneToMany(mappedBy = "variant")
│   │         private Set<StockTransaction> stockTransactions = new LinkedHashSet<>();
│   │     
│   │     }
│   │   ---- END ----
│   ├── Promotion.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import lombok.*;
│   │     
│   │     import java.math.BigDecimal;
│   │     import java.time.LocalDateTime;
│   │     
│   │     @Entity
│   │     @Table(name = "promotions")
│   │     @Data
│   │     @Builder
│   │     @NoArgsConstructor
│   │     @AllArgsConstructor
│   │     public class Promotion {
│   │     
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         private Integer id;
│   │     
│   │         @Column(nullable = false, unique = true, length = 50)
│   │         private String code;
│   │     
│   │         @Column(nullable = false, length = 150)
│   │         private String name;
│   │     
│   │         @Column(length = 500)
│   │         private String description;
│   │     
│   │         @Column(name = "discount_type", nullable = false, length = 20)
│   │         private String discountType; // PERCENT / AMOUNT
│   │     
│   │         @Column(name = "discount_value", nullable = false, precision = 12, scale = 2)
│   │         private BigDecimal discountValue;
│   │     
│   │         @Column(name = "min_order_amount", precision = 15, scale = 2)
│   │         private BigDecimal minOrderAmount;
│   │     
│   │         @Column(name = "applicability_json", columnDefinition = "NVARCHAR(MAX)")
│   │         private String applicabilityJson;
│   │     
│   │         @Column(name = "rules_json", columnDefinition = "NVARCHAR(MAX)")
│   │         private String rulesJson;
│   │     
│   │         @Builder.Default
│   │         @Column(nullable = false)
│   │         private Integer priority = 0;
│   │     
│   │         @Builder.Default
│   │         @Column(nullable = false)
│   │         private Boolean stackable = false;
│   │     
│   │         @Column(name = "start_date", nullable = false)
│   │         private LocalDateTime startDate;
│   │     
│   │         @Column(name = "end_date", nullable = false)
│   │         private LocalDateTime endDate;
│   │     
│   │         @Builder.Default
│   │         @Column(name = "is_active", nullable = false)
│   │         private Boolean isActive = true;
│   │     
│   │         @Column(name = "created_by")
│   │         private Integer createdBy;
│   │     
│   │         @Column(name = "created_at", nullable = false)
│   │         private LocalDateTime createdAt;
│   │     }
│   │     
│   │   ---- END ----
│   └── User.java
│       ---- CODE ----
│         package com.retailmanagement.entity;
│         
│         import jakarta.persistence.*;
│         import lombok.*;
│         
│         import java.time.LocalDateTime;
│         
│         @Getter
│         @Setter
│         @NoArgsConstructor
│         @AllArgsConstructor
│         @Builder
│         @Entity
│         @Table(name = "users", schema = "dbo")
│         public class User {
│         
│             @Id
│             @GeneratedValue(strategy = GenerationType.IDENTITY)
│             private Integer id;
│         
│             @Column(nullable = false, unique = true, length = 50)
│             private String username;
│         
│             @Column(nullable = false, unique = true, length = 100)
│             private String email;
│         
│             @Column(name = "password_hash", nullable = false, length = 255)
│             private String passwordHash;
│         
│             /**
│              * Role hợp lệ: ADMIN, SALES, INVENTORY, CUSTOMER
│              */
│             @Column(nullable = false, length = 30)
│             private String role;
│         
│             @Column(name = "is_active", nullable = false)
│             private Boolean isActive;
│         
│             @Column(name = "created_at", nullable = false)
│             private LocalDateTime createdAt;
│         
│             @Column(name = "updated_at", nullable = false)
│             private LocalDateTime updatedAt;
│         
│             @PrePersist
│             public void prePersist() {
│                 LocalDateTime now = LocalDateTime.now();
│                 if (createdAt == null) createdAt = now;
│                 if (updatedAt == null) updatedAt = now;
│                 if (isActive == null) isActive = true;
│         
│                 // mặc định theo schema
│                 if (role == null || role.isBlank()) role = "CUSTOMER";
│             }
│         
│             @PreUpdate
│             public void preUpdate() {
│                 updatedAt = LocalDateTime.now();
│             }
│         }
│         
│       ---- END ----
├── repository
│   ├── PriceHistoryRepository.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.repository;
│   │     
│   │     import com.retailmanagement.entity.PriceHistory;
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     
│   │     import java.util.List;
│   │     import java.util.Optional;
│   │     
│   │     public interface PriceHistoryRepository extends JpaRepository<PriceHistory, Long> {
│   │         List<PriceHistory> findByVariant_IdOrderByEffectiveFromDesc(Integer variantId);
│   │         Optional<PriceHistory> findFirstByVariant_IdAndEffectiveToIsNullOrderByEffectiveFromDesc(Integer variantId);
│   │     }
│   │     
│   │   ---- END ----
│   ├── ProductRepository.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.repository;
│   │     
│   │     import com.retailmanagement.entity.Product;
│   │     import org.springframework.data.domain.Page;
│   │     import org.springframework.data.domain.Pageable;
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     import org.springframework.data.jpa.repository.Query;
│   │     import org.springframework.data.repository.query.Param;
│   │     import org.springframework.stereotype.Repository;
│   │     
│   │     @Repository
│   │     public interface ProductRepository extends JpaRepository<Product, Integer> {
│   │     
│   │         // SỬA: Dùng Native Query (SQL thuần) để tránh lỗi cú pháp của Hibernate 7
│   │         // Cấu trúc: SELECT ... FROM tên_bảng ...
│   │         @Query(value = "SELECT p.* FROM products p " +
│   │                 "INNER JOIN product_categories pc ON p.id = pc.product_id " +
│   │                 "WHERE pc.category_id = :categoryId",
│   │                 countQuery = "SELECT count(*) FROM products p " +
│   │                         "INNER JOIN product_categories pc ON p.id = pc.product_id " +
│   │                         "WHERE pc.category_id = :categoryId",
│   │                 nativeQuery = true)
│   │         Page<Product> findByCategoryId(@Param("categoryId") Integer categoryId, Pageable pageable);
│   │     }
│   │   ---- END ----
│   ├── ProductVariantRepository.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.repository;
│   │     
│   │     import com.retailmanagement.entity.ProductVariant;
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     
│   │     import java.util.List;
│   │     
│   │     public interface ProductVariantRepository extends JpaRepository<ProductVariant, Integer> {
│   │         List<ProductVariant> findByProduct_Id(Integer productId);
│   │     }
│   │     
│   │   ---- END ----
│   ├── PromotionRepository.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.repository;
│   │     
│   │     import com.retailmanagement.entity.Promotion;
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     
│   │     import java.time.LocalDateTime;
│   │     import java.util.List;
│   │     import java.util.Optional;
│   │     
│   │     public interface PromotionRepository extends JpaRepository<Promotion, Integer> {
│   │         Optional<Promotion> findByCode(String code);
│   │     
│   │         List<Promotion> findByIsActiveTrueAndStartDateLessThanEqualAndEndDateGreaterThanEqual(
│   │                 LocalDateTime at1, LocalDateTime at2
│   │         );
│   │     
│   │         List<Promotion> findByIsActiveTrueAndStartDateLessThanEqualAndEndDateGreaterThanEqualAndIdNot(
│   │                 LocalDateTime at1, LocalDateTime at2, Integer idNot
│   │         );
│   │     }
│   │     
│   │   ---- END ----
│   └── UserRepository.java
│       ---- CODE ----
│         package com.retailmanagement.repository;
│         
│         import com.retailmanagement.entity.User;
│         import org.springframework.data.jpa.repository.JpaRepository;
│         
│         import java.util.Optional;
│         
│         public interface UserRepository extends JpaRepository<User, Integer> {
│         
│             boolean existsByUsername(String username);
│             boolean existsByEmail(String email);
│         
│             boolean existsByUsernameAndIdNot(String username, Integer id);
│             boolean existsByEmailAndIdNot(String email, Integer id);
│         
│             Optional<User> findByUsername(String username);
│             Optional<User> findByEmail(String email);
│         
│             // login bằng username hoặc email
│             Optional<User> findByUsernameOrEmail(String username, String email);
│         }
│         
│       ---- END ----
└── service
    ├── PricingService.java
    │   ---- CODE ----
    │     package com.retailmanagement.service;
    │     
    │     import com.retailmanagement.dto.request.UpsertPriceRequest;
    │     import com.retailmanagement.dto.response.VariantPriceResponse;
    │     import com.retailmanagement.entity.PriceHistory;
    │     import com.retailmanagement.entity.ProductVariant;
    │     import com.retailmanagement.entity.Promotion;
    │     import com.retailmanagement.entity.User;
    │     import com.retailmanagement.repository.PriceHistoryRepository;
    │     import com.retailmanagement.repository.ProductVariantRepository;
    │     import com.retailmanagement.repository.UserRepository;
    │     import org.springframework.stereotype.Service;
    │     import org.springframework.transaction.annotation.Transactional;
    │     
    │     import java.math.BigDecimal;
    │     import java.time.Instant;
    │     import java.time.LocalDateTime;
    │     import java.util.List;
    │     import java.util.NoSuchElementException;
    │     
    │     @Service
    │     public class PricingService {
    │     
    │         private final ProductVariantRepository variantRepo;
    │         private final PriceHistoryRepository priceHistoryRepo;
    │         private final SettingService settingService;
    │         private final PromotionService promotionService;
    │         private final UserRepository userRepository;
    │     
    │         public PricingService(ProductVariantRepository variantRepo,
    │                               PriceHistoryRepository priceHistoryRepo,
    │                               SettingService settingService,
    │                               PromotionService promotionService, UserRepository userRepository) {
    │             this.variantRepo = variantRepo;
    │             this.priceHistoryRepo = priceHistoryRepo;
    │             this.settingService = settingService;
    │             this.promotionService = promotionService;
    │             this.userRepository = userRepository;
    │         }
    │     
    │         // 1) Tạo/đổi giá (và tạo history)
    │         @Transactional
    │         public PriceHistory setVariantPrice(Integer variantId, UpsertPriceRequest req, Integer userId) {
    │             ProductVariant v = variantRepo.findById(variantId)
    │                     .orElseThrow(() -> new NoSuchElementException("Variant not found"));
    │     
    │             User user = userRepository.findById(userId)
    │                     .orElseThrow(() -> new RuntimeException("User not found"));
    │     
    │             if (req.getPrice() == null || req.getPrice().compareTo(BigDecimal.ZERO) < 0) {
    │                 throw new IllegalArgumentException("price phải >= 0");
    │             }
    │     
    │             String currency = (req.getCurrencyCode() == null || req.getCurrencyCode().isBlank())
    │                     ? settingService.getDefaultCurrency()
    │                     : req.getCurrencyCode().trim().toUpperCase();
    │     
    │             Instant now = Instant.now();
    │     
    │             // close current history
    │             priceHistoryRepo.findFirstByVariant_IdAndEffectiveToIsNullOrderByEffectiveFromDesc(variantId)
    │                     .ifPresent(cur -> {
    │                         cur.setEffectiveTo(now);
    │                         priceHistoryRepo.save(cur);
    │                     });
    │     
    │             // create new history
    │             PriceHistory ph = new PriceHistory();
    │             ph.setVariant(v);
    │             ph.setCurrencyCode(currency);
    │             ph.setPrice(req.getPrice());
    │             ph.setCostPrice(req.getCostPrice());
    │             ph.setReason(req.getReason() == null ? "MANUAL" : req.getReason());
    │             ph.setEffectiveFrom(now);
    │             ph.setEffectiveTo(null);
    │             ph.setCreatedBy(user);
    │             ph.setCreatedAt(now);
    │             priceHistoryRepo.save(ph);
    │     
    │             // update current price on variant
    │             v.setCurrencyCode(currency);
    │             v.setPrice(req.getPrice());
    │             v.setCostPrice(req.getCostPrice());
    │             v.setUpdatedAt(now);
    │             variantRepo.save(v);
    │     
    │             return ph;
    │         }
    │     
    │         // 2) Danh sách giá theo sản phẩm (current)
    │         public List<VariantPriceResponse> listCurrentPricesByProduct(Integer productId) {
    │             List<ProductVariant> variants = variantRepo.findByProduct_Id(productId);
    │             LocalDateTime now = LocalDateTime.now();
    │     
    │             return variants.stream().map(v -> {
    │                 VariantPriceResponse r = new VariantPriceResponse();
    │                 r.setVariantId(v.getId());
    │                 r.setProductId(v.getProduct().getId());
    │                 r.setVariantName(v.getVariantName());
    │                 r.setSku(v.getSku());
    │                 r.setCurrencyCode(v.getCurrencyCode());
    │                 r.setPrice(v.getPrice());
    │                 r.setCostPrice(v.getCostPrice());
    │     
    │                 Promotion best = promotionService.findBestPromotionForVariant(v, now);
    │                 if (best != null) {
    │                     r.setPromotionCode(best.getCode());
    │                     r.setFinalPrice(promotionService.applyDiscount(v.getPrice(), best.getDiscountType(), best.getDiscountValue()));
    │                 } else {
    │                     r.setFinalPrice(v.getPrice());
    │                 }
    │                 return r;
    │             }).toList();
    │         }
    │     
    │         // 3) Chỉnh sửa giá: chỉ cho phép chỉnh sửa record mới nhất (effective_to = null)
    │         @Transactional
    │         public PriceHistory updateLatestHistory(Long priceHistoryId, UpsertPriceRequest req) {
    │             PriceHistory ph = priceHistoryRepo.findById(priceHistoryId)
    │                     .orElseThrow(() -> new NoSuchElementException("Price history not found"));
    │     
    │             if (ph.getEffectiveTo() != null) {
    │                 throw new IllegalArgumentException("Chỉ được sửa bản ghi giá hiện tại (effective_to = null)");
    │             }
    │     
    │             if (req.getPrice() == null || req.getPrice().compareTo(BigDecimal.ZERO) < 0) {
    │                 throw new IllegalArgumentException("price phải >= 0");
    │             }
    │     
    │             String currency = (req.getCurrencyCode() == null || req.getCurrencyCode().isBlank())
    │                     ? ph.getCurrencyCode()
    │                     : req.getCurrencyCode().trim().toUpperCase();
    │     
    │             ph.setCurrencyCode(currency);
    │             ph.setPrice(req.getPrice());
    │             ph.setCostPrice(req.getCostPrice());
    │             ph.setReason(req.getReason() == null ? ph.getReason() : req.getReason());
    │             priceHistoryRepo.save(ph);
    │     
    │             // sync variant current price
    │             ProductVariant v = ph.getVariant();
    │             v.setCurrencyCode(currency);
    │             v.setPrice(req.getPrice());
    │             v.setCostPrice(req.getCostPrice());
    │             v.setUpdatedAt(Instant.now());
    │             variantRepo.save(v);
    │     
    │             return ph;
    │         }
    │     
    │         // 4) Xóa giá: chỉ cho phép xóa bản ghi mới nhất và rollback về bản trước
    │         @Transactional
    │         public void deleteLatestAndRollback(Long priceHistoryId) {
    │             PriceHistory current = priceHistoryRepo.findById(priceHistoryId)
    │                     .orElseThrow(() -> new NoSuchElementException("Price history not found"));
    │     
    │             if (current.getEffectiveTo() != null) {
    │                 throw new IllegalArgumentException("Chỉ được xóa bản ghi giá hiện tại (effective_to = null)");
    │             }
    │     
    │             Integer variantId = current.getVariant().getId();
    │     
    │             priceHistoryRepo.delete(current);
    │     
    │             // rollback: lấy bản mới nhất còn lại
    │             List<PriceHistory> histories = priceHistoryRepo.findByVariant_IdOrderByEffectiveFromDesc(variantId);
    │             if (histories.isEmpty()) {
    │                 throw new IllegalStateException("Không còn lịch sử giá để rollback");
    │             }
    │     
    │             PriceHistory latest = histories.get(0);
    │             latest.setEffectiveTo(null);
    │             priceHistoryRepo.save(latest);
    │     
    │             ProductVariant v = latest.getVariant();
    │             v.setCurrencyCode(latest.getCurrencyCode());
    │             v.setPrice(latest.getPrice());
    │             v.setCostPrice(latest.getCostPrice());
    │             v.setUpdatedAt(Instant.now());
    │             variantRepo.save(v);
    │         }
    │     
    │         // 5) Giá hiện tại sau khuyến mãi theo variant
    │         public VariantPriceResponse getEffectivePrice(Integer variantId) {
    │             ProductVariant v = variantRepo.findById(variantId)
    │                     .orElseThrow(() -> new NoSuchElementException("Variant not found"));
    │     
    │             LocalDateTime now = LocalDateTime.now();
    │             Promotion best = promotionService.findBestPromotionForVariant(v, now);
    │     
    │             VariantPriceResponse r = new VariantPriceResponse();
    │             r.setVariantId(v.getId());
    │             r.setProductId(v.getProduct().getId());
    │             r.setVariantName(v.getVariantName());
    │             r.setSku(v.getSku());
    │             r.setCurrencyCode(v.getCurrencyCode());
    │             r.setPrice(v.getPrice());
    │             r.setCostPrice(v.getCostPrice());
    │     
    │             if (best != null) {
    │                 r.setPromotionCode(best.getCode());
    │                 r.setFinalPrice(promotionService.applyDiscount(v.getPrice(), best.getDiscountType(), best.getDiscountValue()));
    │             } else {
    │                 r.setFinalPrice(v.getPrice());
    │             }
    │             return r;
    │         }
    │     }
    │     
    │   ---- END ----
    └── PromotionService.java
        ---- CODE ----
          package com.retailmanagement.service;
          
          import com.fasterxml.jackson.databind.ObjectMapper;
          import com.retailmanagement.dto.request.PromotionRequest;
          import com.retailmanagement.entity.ProductVariant;
          import com.retailmanagement.entity.Promotion;
          import com.retailmanagement.repository.ProductVariantRepository;
          import com.retailmanagement.repository.PromotionRepository;
          import org.springframework.stereotype.Service;
          import org.springframework.transaction.annotation.Transactional;
          
          import java.math.BigDecimal;
          import java.time.LocalDateTime;
          import java.util.*;
          import java.util.stream.Collectors;
          
          @Service
          public class PromotionService {
          
              private final PromotionRepository promoRepo;
              private final ProductVariantRepository variantRepo;
              private final ObjectMapper objectMapper = new ObjectMapper();
          
              public PromotionService(PromotionRepository promoRepo, ProductVariantRepository variantRepo) {
                  this.promoRepo = promoRepo;
                  this.variantRepo = variantRepo;
              }
          
              // JSON format: {"scope":"ALL"} or {"product_ids":[1,2]} or {"variant_ids":[10,11]}
              public static class Applicability {
                  public String scope;
                  public List<Integer> product_ids;
                  public List<Integer> variant_ids;
              }
          
              private String buildApplicabilityJson(PromotionRequest req) {
                  try {
                      Applicability a = new Applicability();
                      String scope = (req.getScope() == null) ? "ALL" : req.getScope().trim().toUpperCase();
                      a.scope = scope;
                      a.product_ids = req.getProductIds();
                      a.variant_ids = req.getVariantIds();
                      return objectMapper.writeValueAsString(a);
                  } catch (Exception e) {
                      throw new IllegalArgumentException("applicabilityJson không hợp lệ");
                  }
              }
          
              private Applicability parseApplicability(String json) {
                  try {
                      if (json == null || json.isBlank()) {
                          Applicability a = new Applicability();
                          a.scope = "ALL";
                          return a;
                      }
                      return objectMapper.readValue(json, Applicability.class);
                  } catch (Exception e) {
                      Applicability a = new Applicability();
                      a.scope = "ALL";
                      return a;
                  }
              }
          
              private boolean dateOverlap(LocalDateTime s1, LocalDateTime e1, LocalDateTime s2, LocalDateTime e2) {
                  return !s1.isAfter(e2) && !e1.isBefore(s2);
              }
          
              private boolean applicabilityOverlap(Applicability a, Applicability b, Integer newVariantId, Integer newProductId) {
                  String sa = (a.scope == null) ? "ALL" : a.scope.toUpperCase();
                  String sb = (b.scope == null) ? "ALL" : b.scope.toUpperCase();
          
                  if ("ALL".equals(sa) || "ALL".equals(sb)) return true;
          
                  Set<Integer> aProducts = a.product_ids == null ? Set.of() : new HashSet<>(a.product_ids);
                  Set<Integer> bProducts = b.product_ids == null ? Set.of() : new HashSet<>(b.product_ids);
          
                  Set<Integer> aVariants = a.variant_ids == null ? Set.of() : new HashSet<>(a.variant_ids);
                  Set<Integer> bVariants = b.variant_ids == null ? Set.of() : new HashSet<>(b.variant_ids);
          
                  // PRODUCT vs PRODUCT
                  if (!aProducts.isEmpty() && !bProducts.isEmpty()) {
                      return !Collections.disjoint(aProducts, bProducts);
                  }
          
                  // VARIANT vs VARIANT
                  if (!aVariants.isEmpty() && !bVariants.isEmpty()) {
                      return !Collections.disjoint(aVariants, bVariants);
                  }
          
                  // PRODUCT vs VARIANT => map variant->product
                  if (!aProducts.isEmpty() && !bVariants.isEmpty()) {
                      List<ProductVariant> vs = variantRepo.findAllById(bVariants);
                      Set<Integer> bVariantProducts = vs.stream().map(v -> v.getProduct().getId()).collect(Collectors.toSet());
                      return !Collections.disjoint(aProducts, bVariantProducts);
                  }
          
                  if (!bProducts.isEmpty() && !aVariants.isEmpty()) {
                      List<ProductVariant> vs = variantRepo.findAllById(aVariants);
                      Set<Integer> aVariantProducts = vs.stream().map(v -> v.getProduct().getId()).collect(Collectors.toSet());
                      return !Collections.disjoint(bProducts, aVariantProducts);
                  }
          
                  return false;
              }
          
              private void assertNoDuplicatePromotion(Promotion draft, Integer ignoreId) {
                  LocalDateTime s = draft.getStartDate();
                  LocalDateTime e = draft.getEndDate();
          
                  List<Promotion> candidates = (ignoreId == null)
                          ? promoRepo.findByIsActiveTrueAndStartDateLessThanEqualAndEndDateGreaterThanEqual(e, s)
                          : promoRepo.findByIsActiveTrueAndStartDateLessThanEqualAndEndDateGreaterThanEqualAndIdNot(e, s, ignoreId);
          
                  Applicability newApp = parseApplicability(draft.getApplicabilityJson());
          
                  List<String> conflicts = new ArrayList<>();
                  for (Promotion p : candidates) {
                      if (!dateOverlap(p.getStartDate(), p.getEndDate(), s, e)) continue;
          
                      Applicability oldApp = parseApplicability(p.getApplicabilityJson());
                      if (applicabilityOverlap(newApp, oldApp, null, null)) {
                          conflicts.add(p.getCode());
                      }
                  }
          
                  if (!conflicts.isEmpty()) {
                      throw new IllegalArgumentException("Trùng khuyến mãi theo thời gian/phạm vi với: " + String.join(", ", conflicts));
                  }
              }
          
              @Transactional
              public Promotion create(PromotionRequest req, Integer createdBy) {
                  if (req.getCode() == null || req.getCode().isBlank()) throw new IllegalArgumentException("code không được rỗng");
                  if (req.getName() == null || req.getName().isBlank()) throw new IllegalArgumentException("name không được rỗng");
                  if (req.getStartDate() == null || req.getEndDate() == null) throw new IllegalArgumentException("startDate/endDate bắt buộc");
                  if (!req.getStartDate().isBefore(req.getEndDate())) throw new IllegalArgumentException("startDate phải < endDate");
          
                  promoRepo.findByCode(req.getCode().trim().toUpperCase()).ifPresent(x -> {
                      throw new IllegalArgumentException("Promo code đã tồn tại");
                  });
          
                  Promotion p = new Promotion();
                  p.setCode(req.getCode().trim().toUpperCase());
                  p.setName(req.getName().trim());
                  p.setDescription(req.getDescription());
                  p.setDiscountType(req.getDiscountType() == null ? "PERCENT" : req.getDiscountType().trim().toUpperCase());
                  p.setDiscountValue(req.getDiscountValue());
                  p.setStartDate(req.getStartDate());
                  p.setEndDate(req.getEndDate());
                  p.setPriority(req.getPriority() == null ? 0 : req.getPriority());
                  p.setStackable(req.getStackable() != null && req.getStackable());
                  p.setIsActive(req.getIsActive() == null || req.getIsActive());
                  p.setApplicabilityJson(buildApplicabilityJson(req));
                  p.setCreatedBy(createdBy);
                  p.setCreatedAt(LocalDateTime.now());
          
                  assertNoDuplicatePromotion(p, null);
          
                  return promoRepo.save(p);
              }
          
              public List<Promotion> list(Boolean activeOnly) {
                  List<Promotion> all = promoRepo.findAll();
                  if (activeOnly != null && activeOnly) {
                      return all.stream().filter(Promotion::getIsActive).toList();
                  }
                  return all;
              }
          
              @Transactional
              public Promotion update(Integer id, PromotionRequest req) {
                  Promotion p = promoRepo.findById(id).orElseThrow(() -> new NoSuchElementException("Promotion not found"));
          
                  if (req.getName() != null) p.setName(req.getName().trim());
                  if (req.getDescription() != null) p.setDescription(req.getDescription());
                  if (req.getDiscountType() != null) p.setDiscountType(req.getDiscountType().trim().toUpperCase());
                  if (req.getDiscountValue() != null) p.setDiscountValue(req.getDiscountValue());
                  if (req.getStartDate() != null) p.setStartDate(req.getStartDate());
                  if (req.getEndDate() != null) p.setEndDate(req.getEndDate());
                  if (req.getPriority() != null) p.setPriority(req.getPriority());
                  if (req.getStackable() != null) p.setStackable(req.getStackable());
                  if (req.getIsActive() != null) p.setIsActive(req.getIsActive());
          
                  // cập nhật phạm vi áp dụng nếu có gửi scope/productIds/variantIds
                  if (req.getScope() != null || req.getProductIds() != null || req.getVariantIds() != null) {
                      p.setApplicabilityJson(buildApplicabilityJson(req));
                  }
          
                  if (!p.getStartDate().isBefore(p.getEndDate())) throw new IllegalArgumentException("startDate phải < endDate");
                  assertNoDuplicatePromotion(p, p.getId());
          
                  return promoRepo.save(p);
              }
          
              @Transactional
              public void delete(Integer id) {
                  Promotion p = promoRepo.findById(id).orElseThrow(() -> new NoSuchElementException("Promotion not found"));
                  // soft delete theo schema: is_active
                  p.setIsActive(false);
                  promoRepo.save(p);
              }
          
              public Promotion findBestPromotionForVariant(ProductVariant v, LocalDateTime at) {
                  List<Promotion> active = promoRepo
                          .findByIsActiveTrueAndStartDateLessThanEqualAndEndDateGreaterThanEqual(at, at);
          
                  BigDecimal base = v.getPrice();
                  Promotion best = null;
                  BigDecimal bestFinal = base;
          
                  for (Promotion p : active) {
                      Applicability app = parseApplicability(p.getApplicabilityJson());
                      if (!isApplicable(app, v)) continue;
          
                      BigDecimal finalPrice = applyDiscount(base, p.getDiscountType(), p.getDiscountValue());
                      if (finalPrice.compareTo(bestFinal) < 0) {
                          bestFinal = finalPrice;
                          best = p;
                      } else if (finalPrice.compareTo(bestFinal) == 0 && best != null) {
                          if (p.getPriority() > best.getPriority()) best = p;
                      }
                  }
                  return best;
              }
          
              public boolean isApplicable(Applicability app, ProductVariant v) {
                  String scope = (app.scope == null) ? "ALL" : app.scope.toUpperCase();
                  if ("ALL".equals(scope)) return true;
          
                  Integer productId = v.getProduct().getId();
                  Integer variantId = v.getId();
          
                  if (app.product_ids != null && app.product_ids.contains(productId)) return true;
                  if (app.variant_ids != null && app.variant_ids.contains(variantId)) return true;
          
                  return false;
              }
          
              public BigDecimal applyDiscount(BigDecimal base, String type, BigDecimal value) {
                  if (base == null) return BigDecimal.ZERO;
                  if (value == null) return base;
          
                  String t = (type == null) ? "PERCENT" : type.toUpperCase();
                  if ("AMOUNT".equals(t)) {
                      BigDecimal r = base.subtract(value);
                      return r.compareTo(BigDecimal.ZERO) < 0 ? BigDecimal.ZERO : r;
                  }
          
                  // PERCENT
                  BigDecimal pct = value;
                  if (pct.compareTo(BigDecimal.ZERO) < 0) pct = BigDecimal.ZERO;
                  if (pct.compareTo(new BigDecimal("100")) > 0) pct = new BigDecimal("100");
          
                  BigDecimal discount = base.multiply(pct).divide(new BigDecimal("100"));
                  BigDecimal r = base.subtract(discount);
                  return r.compareTo(BigDecimal.ZERO) < 0 ? BigDecimal.ZERO : r;
              }
          }
          
        ---- END ----
