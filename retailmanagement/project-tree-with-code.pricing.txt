based on the project-tree-with-code.pricing below, add full features: show promotion price on product listing, calculate final price after promotions & combos, add promotion priority mechanism, display promotion details, CRUD promotions, create & edit price tables by customer group, show prices by customer group, apply promotions per customer group, and always output correct final price after all promotions applied.
â”œâ”€â”€ audit
â”‚   â”œâ”€â”€ Audit.java
â”‚   â”‚   package com.retailmanagement.audit;
â”‚   â”‚   
â”‚   â”‚   import java.lang.annotation.*;
â”‚   â”‚   
â”‚   â”‚   @Target(ElementType.METHOD)
â”‚   â”‚   @Retention(RetentionPolicy.RUNTIME)
â”‚   â”‚   @Documented
â”‚   â”‚   public @interface Audit {
â”‚   â”‚   
â”‚   â”‚       AuditModule module();
â”‚   â”‚       AuditAction action();
â”‚   â”‚       TargetType targetType();
â”‚   â”‚   }
â”‚   â”œâ”€â”€ AuditAction.java
â”‚   â”‚   package com.retailmanagement.audit;
â”‚   â”‚   
â”‚   â”‚   public enum AuditAction {
â”‚   â”‚       CREATE,
â”‚   â”‚       UPDATE,
â”‚   â”‚       CHANGE_ROLE,
â”‚   â”‚       CHANGE_PASSWORD,
â”‚   â”‚       DELETE,
â”‚   â”‚       LOGIN,
â”‚   â”‚       LOGOUT
â”‚   â”‚   }
â”‚   â”œâ”€â”€ AuditModule.java
â”‚   â”‚   package com.retailmanagement.audit;
â”‚   â”‚   
â”‚   â”‚   public enum AuditModule {
â”‚   â”‚       USER,
â”‚   â”‚       PRODUCT,
â”‚   â”‚       CUSTOMER,
â”‚   â”‚       ORDER
â”‚   â”‚   }
â”‚   â””â”€â”€ TargetType.java
â”‚       package com.retailmanagement.audit;
â”‚       
â”‚       public enum TargetType {
â”‚           USER,
â”‚           PRODUCT,
â”‚           CUSTOMER,
â”‚           ORDER
â”‚       }
â”œâ”€â”€ controller
â”‚   â”œâ”€â”€ PriceController.java
â”‚   â”‚   package com.retailmanagement.controller;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.dto.request.UpsertPriceRequest;
â”‚   â”‚   import com.retailmanagement.dto.response.ApiResponse;
â”‚   â”‚   import com.retailmanagement.dto.response.VariantPriceResponse;
â”‚   â”‚   import com.retailmanagement.entity.PriceHistory;
â”‚   â”‚   import com.retailmanagement.service.PricingService;
â”‚   â”‚   import org.springframework.web.bind.annotation.*;
â”‚   â”‚   
â”‚   â”‚   import java.util.List;
â”‚   â”‚   
â”‚   â”‚   @RestController
â”‚   â”‚   @RequestMapping("/api/prices")
â”‚   â”‚   public class PriceController {
â”‚   â”‚   
â”‚   â”‚       private final PricingService pricingService;
â”‚   â”‚   
â”‚   â”‚       public PriceController(PricingService pricingService) {
â”‚   â”‚           this.pricingService = pricingService;
â”‚   â”‚       }
â”‚   â”‚   
â”‚   â”‚       @PostMapping("/variants/{variantId}")
â”‚   â”‚       public ApiResponse<PriceHistory> setVariantPrice(@PathVariable Integer variantId,
â”‚   â”‚                                                        @RequestBody UpsertPriceRequest req) {
â”‚   â”‚           PriceHistory ph = pricingService.setVariantPrice(variantId, req, 0);
â”‚   â”‚           return ApiResponse.success(ph);
â”‚   â”‚       }
â”‚   â”‚   
â”‚   â”‚       @GetMapping("/products/{productId}")
â”‚   â”‚       public ApiResponse<List<VariantPriceResponse>> listByProduct(@PathVariable Integer productId) {
â”‚   â”‚           return ApiResponse.success(pricingService.listCurrentPricesByProduct(productId));
â”‚   â”‚       }
â”‚   â”‚   
â”‚   â”‚       @PutMapping("/history/{id}")
â”‚   â”‚       public ApiResponse<PriceHistory> updateLatest(@PathVariable Long id, @RequestBody UpsertPriceRequest req) {
â”‚   â”‚           return ApiResponse.success(pricingService.updateLatestHistory(id, req));
â”‚   â”‚       }
â”‚   â”‚   
â”‚   â”‚       @DeleteMapping("/history/{id}")
â”‚   â”‚       public ApiResponse<String> deleteLatest(@PathVariable Long id) {
â”‚   â”‚           pricingService.deleteLatestAndRollback(id);
â”‚   â”‚           return ApiResponse.success("OK");
â”‚   â”‚       }
â”‚   â”‚   
â”‚   â”‚       @GetMapping("/variants/{variantId}/effective")
â”‚   â”‚       public ApiResponse<VariantPriceResponse> getEffective(@PathVariable Integer variantId) {
â”‚   â”‚           return ApiResponse.success(pricingService.getEffectivePrice(variantId));
â”‚   â”‚       }
â”‚   â”‚   }
â”‚   â”œâ”€â”€ ProductController.java
â”‚   â”‚   package com.retailmanagement.controller;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.dto.request.ProductRequest;
â”‚   â”‚   import com.retailmanagement.dto.response.ProductResponse;
â”‚   â”‚   import com.retailmanagement.service.ProductService;
â”‚   â”‚   import lombok.RequiredArgsConstructor;
â”‚   â”‚   import org.springframework.data.domain.Page;
â”‚   â”‚   import org.springframework.http.ResponseEntity;
â”‚   â”‚   import org.springframework.web.bind.annotation.*;
â”‚   â”‚   import java.io.IOException;
â”‚   â”‚   
â”‚   â”‚   @RestController
â”‚   â”‚   @RequestMapping("/api/products")
â”‚   â”‚   @RequiredArgsConstructor
â”‚   â”‚   public class ProductController {
â”‚   â”‚   
â”‚   â”‚       private final ProductService productService;
â”‚   â”‚   
â”‚   â”‚       @GetMapping
â”‚   â”‚       public ResponseEntity<Page<ProductResponse>> getProducts(
â”‚   â”‚               @RequestParam(defaultValue = "0") int page,
â”‚   â”‚               @RequestParam(required = false) Integer categoryId,
â”‚   â”‚               @RequestParam(required = false) String keyword,
â”‚   â”‚               @RequestParam(required = false) String sortBy
â”‚   â”‚       ) {
â”‚   â”‚           return ResponseEntity.ok(productService.getProducts(page, categoryId, keyword, sortBy));
â”‚   â”‚       }
â”‚   â”‚   
â”‚   â”‚       @GetMapping("/{id}")
â”‚   â”‚       public ResponseEntity<ProductResponse> getProductDetail(@PathVariable Integer id) {
â”‚   â”‚           return ResponseEntity.ok(productService.getProductById(id));
â”‚   â”‚       }
â”‚   â”‚   
â”‚   â”‚       @PostMapping
â”‚   â”‚       public ResponseEntity<?> createProduct(@ModelAttribute ProductRequest request) throws IOException {
â”‚   â”‚           productService.createProduct(request);
â”‚   â”‚           return ResponseEntity.ok("ThÃªm sáº£n pháº©m thÃ nh cÃ´ng");
â”‚   â”‚       }
â”‚   â”‚   
â”‚   â”‚       @PutMapping("/{id}")
â”‚   â”‚       public ResponseEntity<?> updateProduct(@PathVariable Integer id, @ModelAttribute ProductRequest request) throws IOException {
â”‚   â”‚           productService.updateProduct(id, request);
â”‚   â”‚           return ResponseEntity.ok("Cáº­p nháº­t sáº£n pháº©m thÃ nh cÃ´ng");
â”‚   â”‚       }
â”‚   â”‚   
â”‚   â”‚       @DeleteMapping("/{id}")
â”‚   â”‚       public ResponseEntity<?> deleteProduct(@PathVariable Integer id) {
â”‚   â”‚           productService.softDeleteProduct(id);
â”‚   â”‚           return ResponseEntity.ok("ÄÃ£ áº©n sáº£n pháº©m thÃ nh cÃ´ng (Soft Delete)");
â”‚   â”‚       }
â”‚   â”‚   }
â”‚   â””â”€â”€ PromotionController.java
â”‚       package com.retailmanagement.controller;
â”‚       
â”‚       import com.retailmanagement.dto.request.PromotionRequest;
â”‚       import com.retailmanagement.dto.response.ApiResponse;
â”‚       import com.retailmanagement.entity.Promotion;
â”‚       import com.retailmanagement.service.PromotionService;
â”‚       import org.springframework.web.bind.annotation.*;
â”‚       
â”‚       import java.util.List;
â”‚       
â”‚       @RestController
â”‚       @RequestMapping("/api/promotions")
â”‚       public class PromotionController {
â”‚       
â”‚           private final PromotionService promotionService;
â”‚       
â”‚           public PromotionController(PromotionService promotionService) {
â”‚               this.promotionService = promotionService;
â”‚           }
â”‚       
â”‚           @PostMapping
â”‚           public ApiResponse<Promotion> create(@RequestBody PromotionRequest req) {
â”‚               return ApiResponse.success(promotionService.create(req, 0));
â”‚           }
â”‚       
â”‚           // activeOnly=true => chá»‰ láº¥y khuyáº¿n mÃ£i Ä‘ang hoáº¡t Ä‘á»™ng theo thá»i gian + isActive=true
â”‚           @GetMapping
â”‚           public ApiResponse<List<Promotion>> list(@RequestParam(required = false) Boolean activeOnly) {
â”‚               return ApiResponse.success(promotionService.list(activeOnly));
â”‚           }
â”‚       
â”‚           @PutMapping("/{id}")
â”‚           public ApiResponse<Promotion> update(@PathVariable Integer id, @RequestBody PromotionRequest req) {
â”‚               return ApiResponse.success(promotionService.update(id, req));
â”‚           }
â”‚       
â”‚           @DeleteMapping("/{id}")
â”‚           public ApiResponse<String> delete(@PathVariable Integer id) {
â”‚               promotionService.delete(id);
â”‚               return ApiResponse.success("OK");
â”‚           }
â”‚       }
â”œâ”€â”€ dto
â”‚   â”œâ”€â”€ request
â”‚   â”‚   â”œâ”€â”€ AttributeRequest.java
â”‚   â”‚   â”‚   package com.retailmanagement.dto.request;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚   import lombok.Data;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚   @Data
â”‚   â”‚   â”‚   public class AttributeRequest {
â”‚   â”‚   â”‚       private String name;
â”‚   â”‚   â”‚       private String value;
â”‚   â”‚   â”‚   }
â”‚   â”‚   â”œâ”€â”€ CustomerRequest.java
â”‚   â”‚   â”‚   package com.retailmanagement.dto.request;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚   import com.retailmanagement.entity.CustomerType;
â”‚   â”‚   â”‚   import jakarta.validation.constraints.Email;
â”‚   â”‚   â”‚   import jakarta.validation.constraints.NotBlank;
â”‚   â”‚   â”‚   import jakarta.validation.constraints.*;
â”‚   â”‚   â”‚   import jakarta.validation.constraints.Size;
â”‚   â”‚   â”‚   import lombok.Data;
â”‚   â”‚   â”‚   import lombok.*;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚   import java.time.LocalDate;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚   @Data
â”‚   â”‚   â”‚   @NoArgsConstructor
â”‚   â”‚   â”‚   @AllArgsConstructor
â”‚   â”‚   â”‚   @Builder
â”‚   â”‚   â”‚   public class CustomerRequest {
â”‚   â”‚   â”‚       @NotBlank(message = "KhÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng tÃªn khÃ¡ch hÃ ng")
â”‚   â”‚   â”‚       @Size(max = 200, message = "TÃªn khÃ´ng Ä‘Æ°á»£c vÆ°á»£t quÃ¡ 200 kÃ½ tá»±")
â”‚   â”‚   â”‚       private String fullName;
â”‚   â”‚   â”‚       @Email(message = "Email khÃ´ng há»£p lá»‡")
â”‚   â”‚   â”‚       @Size(max = 200, message = "Email khÃ´ng Ä‘Æ°á»£c vÆ°á»£t quÃ¡ 200 kÃ½ tá»±")
â”‚   â”‚   â”‚       @NotBlank(message = "KhÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng email khÃ¡ch hÃ ng")
â”‚   â”‚   â”‚       private String email;
â”‚   â”‚   â”‚       @Pattern(regexp = "^(0|\\+84)[0-9]{9,10}$", message = "Sá»‘ Ä‘iá»‡n thoáº¡i khÃ´ng há»£p lá»‡")
â”‚   â”‚   â”‚       @NotBlank(message = "KhÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng sá»‘ Ä‘iá»‡n thoáº¡i khÃ¡ch hÃ ng")
â”‚   â”‚   â”‚       private String phone;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       @Past(message = "NgÃ y sinh pháº£i lÃ  ngÃ y trong quÃ¡ khá»©")
â”‚   â”‚   â”‚       private LocalDate birthDate;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       private CustomerType customerType;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       @Size(max = 500, message = "Ghi chÃº khÃ´ng Ä‘Æ°á»£c vÆ°á»£t quÃ¡ 500 kÃ½ tá»±")
â”‚   â”‚   â”‚       private String note;
â”‚   â”‚   â”‚       @Size(max = 500, message = "Äá»‹a chá»‰ khÃ´ng Ä‘Æ°á»£c vÆ°á»£t quÃ¡ 500 kÃ½ tá»±")
â”‚   â”‚   â”‚       private String address; // ThÃªm field address
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       @Size(max = 2000, message = "Ghi chÃº khÃ´ng Ä‘Æ°á»£c vÆ°á»£t quÃ¡ 2000 kÃ½ tá»±")
â”‚   â”‚   â”‚       private String notes; // MATCH vá»›i entity: notes (khÃ´ng pháº£i note)
â”‚   â”‚   â”‚   }
â”‚   â”‚   â”œâ”€â”€ ProductRequest.java
â”‚   â”‚   â”‚   package com.retailmanagement.dto.request;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚   import lombok.Data;
â”‚   â”‚   â”‚   import org.springframework.web.multipart.MultipartFile;
â”‚   â”‚   â”‚   import java.util.List;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚   @Data
â”‚   â”‚   â”‚   public class ProductRequest {
â”‚   â”‚   â”‚       private String name;
â”‚   â”‚   â”‚       private String sku;
â”‚   â”‚   â”‚       private String description;
â”‚   â”‚   â”‚       private Boolean isVisible;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       private Integer categoryId;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       private MultipartFile imageFile;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       private List<Integer> categoryIds;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       private String attributes;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       private List<MultipartFile> galleryImages;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       private List<Long> idsToDelete;
â”‚   â”‚   â”‚   }
â”‚   â”‚   â”œâ”€â”€ PromotionRequest.java
â”‚   â”‚   â”‚   package com.retailmanagement.dto.request;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚   import java.math.BigDecimal;
â”‚   â”‚   â”‚   import java.time.LocalDateTime;
â”‚   â”‚   â”‚   import java.util.List;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚   @Getter
â”‚   â”‚   â”‚   @Setter
â”‚   â”‚   â”‚   public class PromotionRequest {
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       private String code;
â”‚   â”‚   â”‚       private String name;
â”‚   â”‚   â”‚       private String description;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       // PERCENT / AMOUNT
â”‚   â”‚   â”‚       private String discountType;
â”‚   â”‚   â”‚       private BigDecimal discountValue;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       private LocalDateTime startDate;
â”‚   â”‚   â”‚       private LocalDateTime endDate;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       // ALL / PRODUCT / VARIANT
â”‚   â”‚   â”‚       private String scope;
â”‚   â”‚   â”‚       private List<Integer> productIds;
â”‚   â”‚   â”‚       private List<Integer> variantIds;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       private Integer priority = 0;
â”‚   â”‚   â”‚       private Boolean stackable = false;
â”‚   â”‚   â”‚       private Boolean isActive = true;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       // Giá»›i háº¡n sá»‘ láº§n dÃ¹ng (toÃ n há»‡ thá»‘ng). Null = khÃ´ng giá»›i háº¡n
â”‚   â”‚   â”‚       private Integer usageLimit;
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚       // Combo mua X táº·ng Y (vÃ­ dá»¥ mua 2 táº·ng 1 => buyQty=2, getQty=1). Null/0 = khÃ´ng Ã¡p dá»¥ng
â”‚   â”‚   â”‚       private Integer buyQty;
â”‚   â”‚   â”‚       private Integer getQty;
â”‚   â”‚   â”‚   }
â”‚   â”‚   â””â”€â”€ UpsertPriceRequest.java
â”‚   â”‚       package com.retailmanagement.dto.request;
â”‚   â”‚       
â”‚   â”‚       import java.math.BigDecimal;
â”‚   â”‚       import lombok.Getter;
â”‚   â”‚       import lombok.Setter;
â”‚   â”‚       
â”‚   â”‚       @Getter
â”‚   â”‚       @Setter
â”‚   â”‚       public class UpsertPriceRequest {
â”‚   â”‚       
â”‚   â”‚           private String currencyCode;   // null -> dÃ¹ng DEFAULT_CURRENCY
â”‚   â”‚           private BigDecimal price;
â”‚   â”‚           private BigDecimal costPrice;
â”‚   â”‚           private String reason;          // MANUAL / PROMO ...
â”‚   â”‚       }
â”‚   â””â”€â”€ response
â”‚       â”œâ”€â”€ ApiResponse.java
â”‚       â”‚   package com.retailmanagement.dto.response;
â”‚       â”‚   
â”‚       â”‚   import lombok.AllArgsConstructor;
â”‚       â”‚   import lombok.Data;
â”‚       â”‚   import lombok.NoArgsConstructor;
â”‚       â”‚   
â”‚       â”‚   @Data
â”‚       â”‚   @NoArgsConstructor
â”‚       â”‚   @AllArgsConstructor
â”‚       â”‚   public class ApiResponse<T> {
â”‚       â”‚   
â”‚       â”‚       private boolean success;
â”‚       â”‚       private String message;
â”‚       â”‚       private T data;
â”‚       â”‚   
â”‚       â”‚       public static <T> ApiResponse<T> success(T data) {
â”‚       â”‚           return new ApiResponse<>(true, "Success", data);
â”‚       â”‚       }
â”‚       â”‚   
â”‚       â”‚       public static <T> ApiResponse<T> success(String message, T data) {
â”‚       â”‚           return new ApiResponse<>(true, message, data);
â”‚       â”‚       }
â”‚       â”‚   
â”‚       â”‚       public static <T> ApiResponse<T> error(String message) {
â”‚       â”‚           return new ApiResponse<>(false, message, null);
â”‚       â”‚       }
â”‚       â”‚   
â”‚       â”‚       public static <T> ApiResponse<T> error(String message, T data) {
â”‚       â”‚           return new ApiResponse<>(false, message, data);
â”‚       â”‚       }
â”‚       â”‚   }
â”‚       â”œâ”€â”€ CustomerResponse.java
â”‚       â”‚   package com.retailmanagement.dto.response;
â”‚       â”‚   
â”‚       â”‚   
â”‚       â”‚   import com.retailmanagement.entity.*;
â”‚       â”‚   import lombok.*;
â”‚       â”‚   
â”‚       â”‚   import java.math.BigDecimal;
â”‚       â”‚   import java.time.LocalDate;
â”‚       â”‚   import java.time.LocalDateTime;
â”‚       â”‚   
â”‚       â”‚   @Data
â”‚       â”‚   @NoArgsConstructor
â”‚       â”‚   @AllArgsConstructor
â”‚       â”‚   @Builder
â”‚       â”‚   public class CustomerResponse {
â”‚       â”‚       private Integer id; // MATCH vá»›i entity: Integer id (khÃ´ng pháº£i Long customerId)
â”‚       â”‚   
â”‚       â”‚       private String name; // MATCH vá»›i entity: name (khÃ´ng pháº£i fullName)
â”‚       â”‚   
â”‚       â”‚       private String email;
â”‚       â”‚   
â”‚       â”‚       private String phone;
â”‚       â”‚   
â”‚       â”‚       private LocalDate dateOfBirth; // MATCH vá»›i entity: dateOfBirth (khÃ´ng pháº£i birthDate)
â”‚       â”‚   
â”‚       â”‚       private CustomerType customerType;
â”‚       â”‚       private String customerTypeDisplay;
â”‚       â”‚   
â”‚       â”‚       private VipTier vipTier; // ThÃªm vipTier
â”‚       â”‚       private String vipTierDisplay;
â”‚       â”‚       private LocalDateTime lastLoginAt;
â”‚       â”‚       private Integer loyaltyPoints; // ThÃªm loyaltyPoints
â”‚       â”‚       private Integer pointsToNextTier; // Äiá»ƒm cáº§n Ä‘á»ƒ lÃªn háº¡ng
â”‚       â”‚       private Double discountRate; // % giáº£m giÃ¡
â”‚       â”‚   
â”‚       â”‚       private BigDecimal totalSpent; // ThÃªm totalSpent
â”‚       â”‚       private LocalDateTime lastOrderAt; // ThÃªm lastOrderAt
â”‚       â”‚       private String address; // ThÃªm address
â”‚       â”‚       private String notes; // MATCH vá»›i entity: notes (khÃ´ng pháº£i note)
â”‚       â”‚       private String segmentsJson; // ThÃªm segmentsJson
â”‚       â”‚       private Boolean isActive;
â”‚       â”‚       private LocalDateTime createdAt;
â”‚       â”‚       private LocalDateTime updatedAt;
â”‚       â”‚       private String birthdayDisplay; // Format: dd/MM/yyyy
â”‚       â”‚       private Integer birthMonth; // 1-12
â”‚       â”‚       private Integer birthDay; // 1-31
â”‚       â”‚       private Integer age; // Tuá»•i hiá»‡n táº¡i hoáº·c tuá»•i sáº½ Ä‘áº¡t Ä‘Æ°á»£c
â”‚       â”‚       private Long daysUntilBirthday;
â”‚       â”‚   }
â”‚       â”œâ”€â”€ OrderDetailResponse.java
â”‚       â”‚   package com.retailmanagement.dto.response;
â”‚       â”‚   
â”‚       â”‚   import lombok.AllArgsConstructor;
â”‚       â”‚   import lombok.Data;
â”‚       â”‚   
â”‚       â”‚   import java.math.BigDecimal;
â”‚       â”‚   import java.time.Instant;
â”‚       â”‚   import java.util.List;
â”‚       â”‚   
â”‚       â”‚   @Data
â”‚       â”‚   @AllArgsConstructor
â”‚       â”‚   public class OrderDetailResponse {
â”‚       â”‚   
â”‚       â”‚       private Long orderId;
â”‚       â”‚       private String orderNumber;
â”‚       â”‚   
â”‚       â”‚       private String channel;           // âœ… thÃªm
â”‚       â”‚       private String paymentMethod;     // âœ… thÃªm
â”‚       â”‚   
â”‚       â”‚       private String status;
â”‚       â”‚       private String paymentStatus;
â”‚       â”‚   
â”‚       â”‚       private Integer customerId;
â”‚       â”‚       private String customerName;
â”‚       â”‚   
â”‚       â”‚       private Integer staffId;
â”‚       â”‚       private String staffUsername;
â”‚       â”‚   
â”‚       â”‚       private String notes;
â”‚       â”‚   
â”‚       â”‚       private BigDecimal subtotal;
â”‚       â”‚       private BigDecimal discountTotal;
â”‚       â”‚       private BigDecimal taxTotal;
â”‚       â”‚       private BigDecimal shippingFee;
â”‚       â”‚       private BigDecimal totalAmount;
â”‚       â”‚   
â”‚       â”‚   
â”‚       â”‚   
â”‚       â”‚       private Instant createdAt;
â”‚       â”‚       private List<CreateOrderResponse.Item> items;
â”‚       â”‚   }
â”‚       â”œâ”€â”€ ProductResponse.java
â”‚       â”‚   package com.retailmanagement.dto.response;
â”‚       â”‚   
â”‚       â”‚   import lombok.Data;
â”‚       â”‚   
â”‚       â”‚   import java.math.BigDecimal;
â”‚       â”‚   import java.time.LocalDateTime;
â”‚       â”‚   
â”‚       â”‚   @Data
â”‚       â”‚   public class ProductResponse {
â”‚       â”‚       private Integer id;
â”‚       â”‚       private String name;
â”‚       â”‚       private String sku;
â”‚       â”‚       private String description;
â”‚       â”‚       private Boolean isVisible;
â”‚       â”‚       private String imageUrl;
â”‚       â”‚       private LocalDateTime createdAt;
â”‚       â”‚       private String attributes;
â”‚       â”‚   
â”‚       â”‚       // âœ… Added for "Display current price in product list"
â”‚       â”‚       // We return the MIN current price among variants (common storefront behavior).
â”‚       â”‚       private BigDecimal minPrice;
â”‚       â”‚       private String currencyCode;
â”‚       â”‚   
â”‚       â”‚       // âœ… THÃŠM
â”‚       â”‚       private Integer variantId;
â”‚       â”‚       private Integer categoryId;
â”‚       â”‚   }
â”‚       â””â”€â”€ VariantPriceResponse.java
â”‚           package com.retailmanagement.dto.response;
â”‚           
â”‚           import lombok.Data;
â”‚           
â”‚           import java.math.BigDecimal;
â”‚           
â”‚           @Data
â”‚           public class VariantPriceResponse {
â”‚           
â”‚               private Integer variantId;
â”‚               private Integer productId;
â”‚               private String variantName;
â”‚               private String sku;
â”‚           
â”‚               private String currencyCode;
â”‚               private BigDecimal price;
â”‚               private BigDecimal costPrice;
â”‚           
â”‚               // promo
â”‚               private String promotionCode;
â”‚               private BigDecimal finalPrice;
â”‚           }
â”œâ”€â”€ entity
â”‚   â”œâ”€â”€ BaseEntity.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.Column;
â”‚   â”‚   import jakarta.persistence.EntityListeners;
â”‚   â”‚   import jakarta.persistence.MappedSuperclass;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import org.springframework.data.annotation.CreatedDate;
â”‚   â”‚   import org.springframework.data.annotation.LastModifiedDate;
â”‚   â”‚   import org.springframework.data.jpa.domain.support.AuditingEntityListener;
â”‚   â”‚   
â”‚   â”‚   import java.time.LocalDateTime;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @MappedSuperclass
â”‚   â”‚   @EntityListeners(AuditingEntityListener.class)
â”‚   â”‚   
â”‚   â”‚   public abstract class BaseEntity {
â”‚   â”‚       @CreatedDate
â”‚   â”‚       @Column(name = "CreatedAt", nullable = false, updatable = false)
â”‚   â”‚       private LocalDateTime createdAt;
â”‚   â”‚   
â”‚   â”‚       @LastModifiedDate
â”‚   â”‚       @Column(name = "UpdatedAt")
â”‚   â”‚       private LocalDateTime updatedAt;
â”‚   â”‚   }
â”‚   â”œâ”€â”€ CartItem.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import jakarta.validation.constraints.NotNull;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import org.hibernate.annotations.ColumnDefault;
â”‚   â”‚   import org.hibernate.annotations.OnDelete;
â”‚   â”‚   import org.hibernate.annotations.OnDeleteAction;
â”‚   â”‚   
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "cart_items")
â”‚   â”‚   public class CartItem {
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       @Column(name = "id", nullable = false)
â”‚   â”‚       private Integer id;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY, optional = false)
â”‚   â”‚       @OnDelete(action = OnDeleteAction.CASCADE)
â”‚   â”‚       @JoinColumn(name = "customer_id", nullable = false)
â”‚   â”‚       private Customer customer;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY, optional = false)
â”‚   â”‚       @JoinColumn(name = "product_variant_id", nullable = false)
â”‚   â”‚       private ProductVariant productVariant;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @Column(name = "quantity", nullable = false)
â”‚   â”‚       private Integer quantity;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private Instant createdAt;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "updated_at", nullable = false)
â”‚   â”‚       private Instant updatedAt;
â”‚   â”‚   
â”‚   â”‚   }
â”‚   â”œâ”€â”€ Category.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import jakarta.validation.constraints.NotNull;
â”‚   â”‚   import jakarta.validation.constraints.Size;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import org.hibernate.annotations.ColumnDefault;
â”‚   â”‚   import org.hibernate.annotations.Nationalized;
â”‚   â”‚   
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   import java.util.LinkedHashSet;
â”‚   â”‚   import java.util.Set;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "categories")
â”‚   â”‚   public class Category {
â”‚   â”‚   
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       @Column(name = "id", nullable = false)
â”‚   â”‚       private Integer id;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 150)
â”‚   â”‚       @NotNull
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "name", nullable = false, length = 150)
â”‚   â”‚       private String name;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 500)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "description", length = 500)
â”‚   â”‚       private String description;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 500)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "image_url", length = 500)
â”‚   â”‚       private String imageUrl;
â”‚   â”‚   
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY)
â”‚   â”‚       @JoinColumn(name = "parent_id")
â”‚   â”‚       private Category parent;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("0")
â”‚   â”‚       @Column(name = "display_order", nullable = false)
â”‚   â”‚       private Integer displayOrder;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("1")
â”‚   â”‚       @Column(name = "is_active", nullable = false)
â”‚   â”‚       private Boolean isActive = true;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private Instant createdAt;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "updated_at", nullable = false)
â”‚   â”‚       private Instant updatedAt;
â”‚   â”‚   
â”‚   â”‚       @OneToMany(mappedBy = "parent")
â”‚   â”‚       private Set<Category> categories = new LinkedHashSet<>();
â”‚   â”‚   
â”‚   â”‚       @OneToMany(mappedBy = "category")
â”‚   â”‚       private Set<ProductCategory> productCategories = new LinkedHashSet<>();
â”‚   â”‚   
â”‚   â”‚       @PrePersist
â”‚   â”‚       void prePersist() {
â”‚   â”‚           Instant now = Instant.now();
â”‚   â”‚           if (createdAt == null) createdAt = now;
â”‚   â”‚           if (updatedAt == null) updatedAt = now;
â”‚   â”‚           if (isActive == null) isActive = true;
â”‚   â”‚           if (displayOrder == null) displayOrder = 0;
â”‚   â”‚       }
â”‚   â”‚   
â”‚   â”‚       @PreUpdate
â”‚   â”‚       void preUpdate() {
â”‚   â”‚           updatedAt = Instant.now();
â”‚   â”‚       }
â”‚   â”‚   }
â”‚   â”œâ”€â”€ Customer.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import lombok.*;
â”‚   â”‚   import org.hibernate.annotations.CreationTimestamp;
â”‚   â”‚   import org.hibernate.annotations.UpdateTimestamp;
â”‚   â”‚   
â”‚   â”‚   import java.math.BigDecimal;
â”‚   â”‚   import java.time.LocalDate;
â”‚   â”‚   import java.time.LocalDateTime;
â”‚   â”‚   
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "customers")
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @NoArgsConstructor
â”‚   â”‚   @AllArgsConstructor
â”‚   â”‚   @Builder
â”‚   â”‚   public class Customer {
â”‚   â”‚   
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       @Column(name = "id")
â”‚   â”‚       private Integer id;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "name", nullable = false, length = 150)
â”‚   â”‚       private String name;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "email", length = 100)
â”‚   â”‚       private String email;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "phone", length = 30)
â”‚   â”‚       private String phone;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "date_of_birth")
â”‚   â”‚       private LocalDate dateOfBirth;
â”‚   â”‚   
â”‚   â”‚       @Enumerated(EnumType.STRING)
â”‚   â”‚       @Column(name = "customer_type", nullable = false, length = 20)
â”‚   â”‚       private CustomerType customerType = CustomerType.REGULAR;
â”‚   â”‚   
â”‚   â”‚       @Enumerated(EnumType.STRING)
â”‚   â”‚       @Column(name = "vip_tier", length = 30)
â”‚   â”‚       private VipTier vipTier;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "segments_json", columnDefinition = "NVARCHAR(MAX)")
â”‚   â”‚       private String segmentsJson;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "loyalty_points", nullable = false)
â”‚   â”‚       private Integer loyaltyPoints = 0;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "total_spent", precision = 15, scale = 2)
â”‚   â”‚       private BigDecimal totalSpent = BigDecimal.ZERO;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "last_order_at")
â”‚   â”‚       private LocalDateTime lastOrderAt;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "address", length = 500)
â”‚   â”‚       private String address;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "notes", columnDefinition = "NVARCHAR(MAX)")
â”‚   â”‚       private String notes;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "last_login_at")
â”‚   â”‚       private LocalDateTime lastLoginAt;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "is_active", nullable = false)
â”‚   â”‚       private Boolean isActive = true;
â”‚   â”‚   
â”‚   â”‚       @CreationTimestamp
â”‚   â”‚       @Column(name = "created_at", nullable = false, updatable = false)
â”‚   â”‚       private LocalDateTime createdAt;
â”‚   â”‚   
â”‚   â”‚       @UpdateTimestamp
â”‚   â”‚       @Column(name = "updated_at")
â”‚   â”‚       private LocalDateTime updatedAt;
â”‚   â”‚   
â”‚   â”‚   
â”‚   â”‚   }
â”‚   â”œâ”€â”€ Customergroup.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   public class Customergroup {
â”‚   â”‚   }
â”‚   â”œâ”€â”€ CustomerType.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import com.fasterxml.jackson.annotation.JsonCreator;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   public enum CustomerType {
â”‚   â”‚       REGULAR("KhÃ¡ch hÃ ng thÆ°á»ng", 0),
â”‚   â”‚       VIP("KhÃ¡ch hÃ ng VIP", 1);
â”‚   â”‚       private final String displayname;
â”‚   â”‚       private final int level;
â”‚   â”‚       CustomerType(String displayname, int level) {
â”‚   â”‚           this.displayname = displayname;
â”‚   â”‚           this.level = level;
â”‚   â”‚       }
â”‚   â”‚       public boolean isVip() {
â”‚   â”‚           return this == VIP;
â”‚   â”‚       }
â”‚   â”‚       public static CustomerType fromString(String value) {
â”‚   â”‚           if (value == null) {
â”‚   â”‚               return REGULAR;
â”‚   â”‚           }
â”‚   â”‚           try {
â”‚   â”‚               return CustomerType.valueOf(value.toUpperCase());
â”‚   â”‚           } catch (IllegalArgumentException e) {
â”‚   â”‚               return REGULAR;
â”‚   â”‚           }
â”‚   â”‚       }
â”‚   â”‚       public static CustomerType fromDisplayName(String displayname) {
â”‚   â”‚           for (CustomerType type : CustomerType.values()) {
â”‚   â”‚               if (type.displayname.equalsIgnoreCase(displayname)) {
â”‚   â”‚                   return type;
â”‚   â”‚               }
â”‚   â”‚           }
â”‚   â”‚           return REGULAR;
â”‚   â”‚       }
â”‚   â”‚       @JsonCreator
â”‚   â”‚       public static CustomerType fromJson(String value) {
â”‚   â”‚           if (value == null) return REGULAR;
â”‚   â”‚           return CustomerType.valueOf(value.trim().toUpperCase());
â”‚   â”‚       }
â”‚   â”‚   
â”‚   â”‚   }
â”‚   â”œâ”€â”€ Image.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import jakarta.validation.constraints.NotNull;
â”‚   â”‚   import jakarta.validation.constraints.Size;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import org.hibernate.annotations.ColumnDefault;
â”‚   â”‚   import org.hibernate.annotations.Nationalized;
â”‚   â”‚   
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "images")
â”‚   â”‚   public class Image {
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       @Column(name = "id", nullable = false)
â”‚   â”‚       private Long id;
â”‚   â”‚   
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY)
â”‚   â”‚       @JoinColumn(name = "product_id")
â”‚   â”‚       private Product product;
â”‚   â”‚   
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY)
â”‚   â”‚       @JoinColumn(name = "variant_id")
â”‚   â”‚       private ProductVariant variant;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 800)
â”‚   â”‚       @NotNull
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "url", nullable = false, length = 800)
â”‚   â”‚       private String url;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("0")
â”‚   â”‚       @Column(name = "is_primary", nullable = false)
â”‚   â”‚       private Boolean isPrimary = false;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("0")
â”‚   â”‚       @Column(name = "sort_order", nullable = false)
â”‚   â”‚       private Integer sortOrder;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 200)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "alt_text", length = 200)
â”‚   â”‚       private String altText;
â”‚   â”‚   
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Lob
â”‚   â”‚       @Column(name = "meta_json")
â”‚   â”‚       private String metaJson;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private Instant createdAt;
â”‚   â”‚   
â”‚   â”‚   }
â”‚   â”œâ”€â”€ LoyaltyLedger.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import jakarta.validation.constraints.NotNull;
â”‚   â”‚   import jakarta.validation.constraints.Size;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import lombok.Builder;
â”‚   â”‚   import lombok.NoArgsConstructor;
â”‚   â”‚   import lombok.AllArgsConstructor;
â”‚   â”‚   import org.hibernate.annotations.ColumnDefault;
â”‚   â”‚   import org.hibernate.annotations.Nationalized;
â”‚   â”‚   
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "loyalty_ledger")
â”‚   â”‚   @Builder
â”‚   â”‚   @NoArgsConstructor
â”‚   â”‚   @AllArgsConstructor
â”‚   â”‚   public class LoyaltyLedger {
â”‚   â”‚   
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       @Column(name = "id", nullable = false)
â”‚   â”‚       private Long id;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY, optional = false)
â”‚   â”‚       @JoinColumn(name = "customer_id", nullable = false)
â”‚   â”‚       private Customer customer;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @Column(name = "points_delta", nullable = false)
â”‚   â”‚       private Integer pointsDelta;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 200)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "reason", length = 200)
â”‚   â”‚       private String reason;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 50)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "reference_type", length = 50)
â”‚   â”‚       private String referenceType;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "reference_id")
â”‚   â”‚       private Long referenceId;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 500)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "note", length = 500)
â”‚   â”‚       private String note;
â”‚   â”‚   
â”‚   â”‚   
â”‚   â”‚       @Column(name = "created_by")
â”‚   â”‚       private Integer createdBy;
â”‚   â”‚       @Column(name = "transaction_type", length = 50)
â”‚   â”‚       private String transactionType; // EARN / DEDUCT / TIER_UPGRADE / TIER_DOWNGRADE / PENALTY
â”‚   â”‚   
â”‚   â”‚       @Column(name = "tier_before", length = 30)
â”‚   â”‚       private String tierBefore;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "tier_after", length = 30)
â”‚   â”‚       private String tierAfter;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private Instant createdAt;
â”‚   â”‚   }
â”‚   â”œâ”€â”€ Notification.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import lombok.*;
â”‚   â”‚   import org.hibernate.annotations.CreationTimestamp;
â”‚   â”‚   
â”‚   â”‚   import java.time.LocalDateTime;
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "notifications",
â”‚   â”‚           indexes = {
â”‚   â”‚                   @Index(name = "IX_notifications_customer", columnList = "customer_id, created_at"),
â”‚   â”‚                   @Index(name = "IX_notifications_is_read", columnList = "is_read, created_at")
â”‚   â”‚           })
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @NoArgsConstructor
â”‚   â”‚   @AllArgsConstructor
â”‚   â”‚   @Builder
â”‚   â”‚   public class Notification {
â”‚   â”‚   
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       @Column(name = "id")
â”‚   â”‚       private Long id;
â”‚   â”‚   
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY)
â”‚   â”‚       @JoinColumn(name = "customer_id")
â”‚   â”‚       private Customer customer;
â”‚   â”‚   
â”‚   â”‚       @Enumerated(EnumType.STRING)
â”‚   â”‚       @Column(name = "type", nullable = false, length = 50)
â”‚   â”‚       private NotificationType type;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "title", nullable = false, length = 200)
â”‚   â”‚       private String title;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "message", columnDefinition = "NVARCHAR(MAX)")
â”‚   â”‚       private String message;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "is_read", nullable = false)
â”‚   â”‚       private Boolean isRead = false;
â”‚   â”‚   
â”‚   â”‚       @CreationTimestamp
â”‚   â”‚       @Column(name = "created_at", nullable = false, updatable = false)
â”‚   â”‚       private LocalDateTime createdAt;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "read_at")
â”‚   â”‚       private LocalDateTime readAt;
â”‚   â”‚   }
â”‚   â”œâ”€â”€ NotificationType.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   public enum NotificationType {
â”‚   â”‚       BIRTHDAY("Sinh nháº­t", "ğŸ‚"),
â”‚   â”‚       ORDER_STATUS("Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng", "ğŸ“¦"),
â”‚   â”‚       PROMOTION("Khuyáº¿n mÃ£i", "ğŸ"),
â”‚   â”‚       LOYALTY_POINTS("Äiá»ƒm tÃ­ch lÅ©y", "â­"),
â”‚   â”‚       VIP_TIER_UPGRADE("NÃ¢ng háº¡ng VIP", "ğŸ‘‘"),
â”‚   â”‚       SYSTEM("Há»‡ thá»‘ng", "ğŸ””");
â”‚   â”‚   
â”‚   â”‚       private final String displayName;
â”‚   â”‚       private final String icon;
â”‚   â”‚   
â”‚   â”‚       NotificationType(String displayName, String icon) {
â”‚   â”‚           this.displayName = displayName;
â”‚   â”‚           this.icon = icon;
â”‚   â”‚       }
â”‚   â”‚   }
â”‚   â”œâ”€â”€ Order.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import jakarta.validation.constraints.NotNull;
â”‚   â”‚   import jakarta.validation.constraints.Size;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import org.hibernate.annotations.ColumnDefault;
â”‚   â”‚   import org.hibernate.annotations.Nationalized;
â”‚   â”‚   import org.hibernate.annotations.OnDelete;
â”‚   â”‚   import org.hibernate.annotations.OnDeleteAction;
â”‚   â”‚   
â”‚   â”‚   import java.math.BigDecimal;
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   import java.util.LinkedHashSet;
â”‚   â”‚   import java.util.Set;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "orders")
â”‚   â”‚   public class Order {
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       @Column(name = "id", nullable = false)
â”‚   â”‚       private Long id;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 40)
â”‚   â”‚       @NotNull
â”‚   â”‚       @Nationalized
â”‚   â”‚       @ColumnDefault("concat(N'ORD-', CONVERT([char](8), sysdatetime(), 112), N'-', right(N'000000'+CONVERT([varchar](20), NEXT VALUE FOR [dbo].[order_seq]), 6))")
â”‚   â”‚       @Column(name = "order_number", nullable = false, length = 40)
â”‚   â”‚       private String orderNumber;
â”‚   â”‚   
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY)
â”‚   â”‚       @OnDelete(action = OnDeleteAction.SET_NULL)
â”‚   â”‚       @JoinColumn(name = "customer_id")
â”‚   â”‚       private Customer customer;
â”‚   â”‚   
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY)
â”‚   â”‚       @OnDelete(action = OnDeleteAction.SET_NULL)
â”‚   â”‚       @JoinColumn(name = "user_id")
â”‚   â”‚       private User user;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 20)
â”‚   â”‚       @NotNull
â”‚   â”‚       @Nationalized
â”‚   â”‚       @ColumnDefault("'OFFLINE'")
â”‚   â”‚       @Column(name = "channel", nullable = false, length = 20)
â”‚   â”‚       private String channel;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 30)
â”‚   â”‚       @NotNull
â”‚   â”‚       @Nationalized
â”‚   â”‚       @ColumnDefault("'PENDING'")
â”‚   â”‚       @Column(name = "status", nullable = false, length = 30)
â”‚   â”‚       private String status;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 50)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "payment_method", length = 50)
â”‚   â”‚       private String paymentMethod;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 20)
â”‚   â”‚       @NotNull
â”‚   â”‚       @Nationalized
â”‚   â”‚       @ColumnDefault("'UNPAID'")
â”‚   â”‚       @Column(name = "payment_status", nullable = false, length = 20)
â”‚   â”‚       private String paymentStatus;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 500)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "shipping_address", length = 500)
â”‚   â”‚       private String shippingAddress;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("0")
â”‚   â”‚       @Column(name = "shipping_fee", nullable = false, precision = 12, scale = 2)
â”‚   â”‚       private BigDecimal shippingFee;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 30)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "shipping_status", length = 30)
â”‚   â”‚       private String shippingStatus;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 100)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "tracking_code", length = 100)
â”‚   â”‚       private String trackingCode;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "paid_at")
â”‚   â”‚       private Instant paidAt;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "shipped_at")
â”‚   â”‚       private Instant shippedAt;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "delivered_at")
â”‚   â”‚       private Instant deliveredAt;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "cancelled_at")
â”‚   â”‚       private Instant cancelledAt;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "returned_at")
â”‚   â”‚       private Instant returnedAt;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("0")
â”‚   â”‚       @Column(name = "subtotal", nullable = false, precision = 15, scale = 2)
â”‚   â”‚       private BigDecimal subtotal;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("0")
â”‚   â”‚       @Column(name = "discount_total", nullable = false, precision = 15, scale = 2)
â”‚   â”‚       private BigDecimal discountTotal;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("0")
â”‚   â”‚       @Column(name = "tax_total", nullable = false, precision = 15, scale = 2)
â”‚   â”‚       private BigDecimal taxTotal;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("0")
â”‚   â”‚       @Column(name = "total_amount", nullable = false, precision = 15, scale = 2)
â”‚   â”‚       private BigDecimal totalAmount;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 50)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "applied_promotion_code", length = 50)
â”‚   â”‚       private String appliedPromotionCode;
â”‚   â”‚   
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Lob
â”‚   â”‚       @Column(name = "applied_promotion_json")
â”‚   â”‚       private String appliedPromotionJson;
â”‚   â”‚   
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Lob
â”‚   â”‚       @Column(name = "notes")
â”‚   â”‚       private String notes;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private Instant createdAt;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "updated_at", nullable = false)
â”‚   â”‚       private Instant updatedAt;
â”‚   â”‚   
â”‚   â”‚       @OneToMany(mappedBy = "order")
â”‚   â”‚       private Set<OrderItem> orderItems = new LinkedHashSet<>();
â”‚   â”‚   
â”‚   â”‚       @OneToMany(mappedBy = "order")
â”‚   â”‚       private Set<Payment> payments = new LinkedHashSet<>();
â”‚   â”‚   
â”‚   â”‚       @OneToMany(mappedBy = "order")
â”‚   â”‚       private Set<Return> returns = new LinkedHashSet<>();
â”‚   â”‚   
â”‚   â”‚       @PrePersist
â”‚   â”‚       protected void onCreate() {
â”‚   â”‚           createdAt = Instant.now();
â”‚   â”‚           updatedAt = Instant.now();
â”‚   â”‚           if (paymentStatus == null) {
â”‚   â”‚               paymentStatus = "UNPAID";
â”‚   â”‚           }
â”‚   â”‚           if (status == null) {
â”‚   â”‚               status = "PENDING";
â”‚   â”‚           }
â”‚   â”‚       }
â”‚   â”‚   
â”‚   â”‚       @PreUpdate
â”‚   â”‚       protected void onUpdate() {
â”‚   â”‚           updatedAt = Instant.now();
â”‚   â”‚       }
â”‚   â”‚   }
â”‚   â”œâ”€â”€ OrderItem.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import jakarta.validation.constraints.NotNull;
â”‚   â”‚   import jakarta.validation.constraints.Size;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import org.hibernate.annotations.ColumnDefault;
â”‚   â”‚   import org.hibernate.annotations.Nationalized;
â”‚   â”‚   
â”‚   â”‚   import java.math.BigDecimal;
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   import java.util.LinkedHashSet;
â”‚   â”‚   import java.util.Set;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "order_items")
â”‚   â”‚   public class OrderItem {
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       @Column(name = "id", nullable = false)
â”‚   â”‚       private Long id;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY, optional = false)
â”‚   â”‚       @JoinColumn(name = "order_id", nullable = false)
â”‚   â”‚       private Order order;
â”‚   â”‚   
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY)
â”‚   â”‚       @JoinColumn(name = "variant_id")
â”‚   â”‚       private ProductVariant variant;
â”‚   â”‚   
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY)
â”‚   â”‚       @JoinColumn(name = "product_id")
â”‚   â”‚       private Product product;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 200)
â”‚   â”‚       @NotNull
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "product_name", nullable = false, length = 200)
â”‚   â”‚       private String productName;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 150)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "variant_name", length = 150)
â”‚   â”‚       private String variantName;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 100)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "sku", length = 100)
â”‚   â”‚       private String sku;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @Column(name = "quantity", nullable = false)
â”‚   â”‚       private Integer quantity;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @Column(name = "unit_price", nullable = false, precision = 12, scale = 2)
â”‚   â”‚       private BigDecimal unitPrice;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("0")
â”‚   â”‚       @Column(name = "discount", nullable = false, precision = 12, scale = 2)
â”‚   â”‚       private BigDecimal discount;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @Column(name = "line_total", nullable = false, precision = 15, scale = 2)
â”‚   â”‚       private BigDecimal lineTotal;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private Instant createdAt;
â”‚   â”‚   
â”‚   â”‚       @OneToMany(mappedBy = "orderItem")
â”‚   â”‚       private Set<Return> returns = new LinkedHashSet<>();
â”‚   â”‚   
â”‚   â”‚   }
â”‚   â”œâ”€â”€ Payment.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import jakarta.validation.constraints.NotNull;
â”‚   â”‚   import jakarta.validation.constraints.Size;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import org.hibernate.annotations.ColumnDefault;
â”‚   â”‚   import org.hibernate.annotations.Nationalized;
â”‚   â”‚   import org.hibernate.annotations.OnDelete;
â”‚   â”‚   import org.hibernate.annotations.OnDeleteAction;
â”‚   â”‚   
â”‚   â”‚   import java.math.BigDecimal;
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "payments")
â”‚   â”‚   public class Payment {
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       @Column(name = "id", nullable = false)
â”‚   â”‚       private Long id;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY, optional = false)
â”‚   â”‚       @OnDelete(action = OnDeleteAction.CASCADE)
â”‚   â”‚       @JoinColumn(name = "order_id", nullable = false)
â”‚   â”‚       private Order order;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @Column(name = "amount", nullable = false, precision = 15, scale = 2)
â”‚   â”‚       private BigDecimal amount;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 50)
â”‚   â”‚       @NotNull
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "method", nullable = false, length = 50)
â”‚   â”‚       private String method;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 100)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "transaction_ref", length = 100)
â”‚   â”‚       private String transactionRef;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 20)
â”‚   â”‚       @NotNull
â”‚   â”‚       @Nationalized
â”‚   â”‚       @ColumnDefault("'PENDING'")
â”‚   â”‚       @Column(name = "status", nullable = false, length = 20)
â”‚   â”‚       private String status;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "paid_at")
â”‚   â”‚       private Instant paidAt;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private Instant createdAt;
â”‚   â”‚   
â”‚   â”‚   }
â”‚   â”œâ”€â”€ PriceHistory.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import jakarta.validation.constraints.NotNull;
â”‚   â”‚   import jakarta.validation.constraints.Size;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import org.hibernate.annotations.ColumnDefault;
â”‚   â”‚   import org.hibernate.annotations.Nationalized;
â”‚   â”‚   import org.hibernate.annotations.OnDelete;
â”‚   â”‚   import org.hibernate.annotations.OnDeleteAction;
â”‚   â”‚   
â”‚   â”‚   import java.math.BigDecimal;
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "price_history")
â”‚   â”‚   public class PriceHistory {
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       @Column(name = "id", nullable = false)
â”‚   â”‚       private Long id;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY, optional = false)
â”‚   â”‚       @OnDelete(action = OnDeleteAction.CASCADE)
â”‚   â”‚       @JoinColumn(name = "variant_id", nullable = false)
â”‚   â”‚       private ProductVariant variant;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 3)
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("'VND'")
â”‚   â”‚       @Column(name = "currency_code", nullable = false, length = 3)
â”‚   â”‚       private String currencyCode;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @Column(name = "price", nullable = false, precision = 12, scale = 2)
â”‚   â”‚       private BigDecimal price;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "cost_price", precision = 12, scale = 2)
â”‚   â”‚       private BigDecimal costPrice;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 200)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "reason", length = 200)
â”‚   â”‚       private String reason;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "effective_from", nullable = false)
â”‚   â”‚       private Instant effectiveFrom;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "effective_to")
â”‚   â”‚       private Instant effectiveTo;
â”‚   â”‚   
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY)
â”‚   â”‚       @OnDelete(action = OnDeleteAction.SET_NULL)
â”‚   â”‚       @JoinColumn(name = "created_by")
â”‚   â”‚       private User createdBy;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private Instant createdAt;
â”‚   â”‚   
â”‚   â”‚   }
â”‚   â”œâ”€â”€ Product.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.Column;
â”‚   â”‚   import jakarta.persistence.Entity;
â”‚   â”‚   import jakarta.persistence.GeneratedValue;
â”‚   â”‚   import jakarta.persistence.GenerationType;
â”‚   â”‚   import jakarta.persistence.Id;
â”‚   â”‚   import jakarta.persistence.Table;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.NoArgsConstructor;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import org.hibernate.annotations.CreationTimestamp;
â”‚   â”‚   import org.hibernate.annotations.UpdateTimestamp;
â”‚   â”‚   
â”‚   â”‚   import java.time.LocalDateTime;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @NoArgsConstructor
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "products")
â”‚   â”‚   public class Product {
â”‚   â”‚   
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       private Integer id;
â”‚   â”‚   
â”‚   â”‚       @Column(nullable = false, length = 200)
â”‚   â”‚       private String name;
â”‚   â”‚   
â”‚   â”‚       @Column(nullable = false, unique = true, length = 100)
â”‚   â”‚       private String sku;
â”‚   â”‚   
â”‚   â”‚       @Column(columnDefinition = "NVARCHAR(MAX)")
â”‚   â”‚       private String description;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "is_visible", nullable = false)
â”‚   â”‚       private Boolean isVisible = true;
â”‚   â”‚   
â”‚   â”‚       @CreationTimestamp
â”‚   â”‚       @Column(name = "created_at", updatable = false)
â”‚   â”‚       private LocalDateTime createdAt;
â”‚   â”‚   
â”‚   â”‚       @UpdateTimestamp
â”‚   â”‚       @Column(name = "updated_at")
â”‚   â”‚       private LocalDateTime updatedAt;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "attributes_json", columnDefinition = "nvarchar(max)")
â”‚   â”‚       private String attributesJson;
â”‚   â”‚   }
â”‚   â”œâ”€â”€ ProductCategory.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import jakarta.validation.constraints.NotNull;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import org.hibernate.annotations.ColumnDefault;
â”‚   â”‚   
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "product_categories")
â”‚   â”‚   public class ProductCategory {
â”‚   â”‚       @EmbeddedId
â”‚   â”‚       private ProductCategoryId id;
â”‚   â”‚   
â”‚   â”‚       @MapsId("categoryId")
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY, optional = false)
â”‚   â”‚       @JoinColumn(name = "category_id", nullable = false)
â”‚   â”‚       private Category category;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("0")
â”‚   â”‚       @Column(name = "is_primary", nullable = false)
â”‚   â”‚       private Boolean isPrimary = false;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private Instant createdAt;
â”‚   â”‚   
â”‚   â”‚   }
â”‚   â”œâ”€â”€ ProductCategoryId.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.Column;
â”‚   â”‚   import jakarta.persistence.Embeddable;
â”‚   â”‚   import lombok.*;
â”‚   â”‚   
â”‚   â”‚   import java.io.Serializable;
â”‚   â”‚   
â”‚   â”‚   @Data
â”‚   â”‚   @NoArgsConstructor
â”‚   â”‚   @AllArgsConstructor
â”‚   â”‚   @Embeddable
â”‚   â”‚   public class ProductCategoryId implements Serializable {
â”‚   â”‚       private static final long serialVersionUID = 6105819806365181834L;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "product_id")
â”‚   â”‚       private Integer productId;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "category_id")
â”‚   â”‚       private Integer categoryId;
â”‚   â”‚   
â”‚   â”‚   
â”‚   â”‚   }
â”‚   â”œâ”€â”€ ProductTag.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import jakarta.validation.constraints.NotNull;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import org.hibernate.annotations.ColumnDefault;
â”‚   â”‚   
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "product_tags")
â”‚   â”‚   public class ProductTag {
â”‚   â”‚       @EmbeddedId
â”‚   â”‚       private ProductTagId id;
â”‚   â”‚   
â”‚   â”‚       @MapsId("productId")
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY, optional = false)
â”‚   â”‚       @JoinColumn(name = "product_id", nullable = false)
â”‚   â”‚       private Product product;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private Instant createdAt;
â”‚   â”‚   
â”‚   â”‚   }
â”‚   â”œâ”€â”€ ProductTagId.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.Column;
â”‚   â”‚   import jakarta.persistence.Embeddable;
â”‚   â”‚   import jakarta.validation.constraints.NotNull;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import org.hibernate.Hibernate;
â”‚   â”‚   
â”‚   â”‚   import java.io.Serializable;
â”‚   â”‚   import java.util.Objects;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @Embeddable
â”‚   â”‚   public class ProductTagId implements Serializable {
â”‚   â”‚       private static final long serialVersionUID = -4861170464523510247L;
â”‚   â”‚       @NotNull
â”‚   â”‚       @Column(name = "product_id", nullable = false)
â”‚   â”‚       private Integer productId;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @Column(name = "tag_id", nullable = false)
â”‚   â”‚       private Integer tagId;
â”‚   â”‚   
â”‚   â”‚       @Override
â”‚   â”‚       public boolean equals(Object o) {
â”‚   â”‚           if (this == o) return true;
â”‚   â”‚           if (o == null || Hibernate.getClass(this) != Hibernate.getClass(o)) return false;
â”‚   â”‚           ProductTagId entity = (ProductTagId) o;
â”‚   â”‚           return Objects.equals(this.productId, entity.productId) &&
â”‚   â”‚                   Objects.equals(this.tagId, entity.tagId);
â”‚   â”‚       }
â”‚   â”‚   
â”‚   â”‚       @Override
â”‚   â”‚       public int hashCode() {
â”‚   â”‚           return Objects.hash(productId, tagId);
â”‚   â”‚       }
â”‚   â”‚   
â”‚   â”‚   }
â”‚   â”œâ”€â”€ ProductVariant.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import jakarta.validation.constraints.NotNull;
â”‚   â”‚   import jakarta.validation.constraints.Size;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import org.hibernate.annotations.ColumnDefault;
â”‚   â”‚   import org.hibernate.annotations.Nationalized;
â”‚   â”‚   import org.hibernate.annotations.OnDelete;
â”‚   â”‚   import org.hibernate.annotations.OnDeleteAction;
â”‚   â”‚   
â”‚   â”‚   import java.math.BigDecimal;
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   import java.util.LinkedHashSet;
â”‚   â”‚   import java.util.Set;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "product_variants")
â”‚   â”‚   public class ProductVariant {
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       @Column(name = "id", nullable = false)
â”‚   â”‚       private Integer id;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY, optional = false)
â”‚   â”‚       @OnDelete(action = OnDeleteAction.CASCADE)
â”‚   â”‚       @JoinColumn(name = "product_id", nullable = false)
â”‚   â”‚       private Product product;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 150)
â”‚   â”‚       @NotNull
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "variant_name", nullable = false, length = 150)
â”‚   â”‚       private String variantName;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 100)
â”‚   â”‚       @NotNull
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "sku", nullable = false, length = 100)
â”‚   â”‚       private String sku;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 100)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "barcode", length = 100)
â”‚   â”‚       private String barcode;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 3)
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("'VND'")
â”‚   â”‚       @Column(name = "currency_code", nullable = false, length = 3)
â”‚   â”‚       private String currencyCode;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @Column(name = "price", nullable = false, precision = 12, scale = 2)
â”‚   â”‚       private BigDecimal price;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "cost_price", precision = 12, scale = 2)
â”‚   â”‚       private BigDecimal costPrice;
â”‚   â”‚   
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Lob
â”‚   â”‚       @Column(name = "price_tiers_json")
â”‚   â”‚       private String priceTiersJson;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("0")
â”‚   â”‚       @Column(name = "stock_quantity", nullable = false)
â”‚   â”‚       private Integer stockQuantity;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("0")
â”‚   â”‚       @Column(name = "reserved_qty", nullable = false)
â”‚   â”‚       private Integer reservedQty;
â”‚   â”‚   
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Lob
â”‚   â”‚       @Column(name = "attributes_json")
â”‚   â”‚       private String attributesJson;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("1")
â”‚   â”‚       @Column(name = "is_active", nullable = false)
â”‚   â”‚       private Boolean isActive = false;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private Instant createdAt;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "updated_at", nullable = false)
â”‚   â”‚       private Instant updatedAt;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "deleted_at")
â”‚   â”‚       private Instant deletedAt;
â”‚   â”‚   
â”‚   â”‚       @OneToMany(mappedBy = "variant")
â”‚   â”‚       private Set<Image> images = new LinkedHashSet<>();
â”‚   â”‚   
â”‚   â”‚       @OneToMany(mappedBy = "variant")
â”‚   â”‚       private Set<OrderItem> orderItems = new LinkedHashSet<>();
â”‚   â”‚   
â”‚   â”‚       @OneToMany(mappedBy = "variant")
â”‚   â”‚       private Set<PriceHistory> priceHistories = new LinkedHashSet<>();
â”‚   â”‚   
â”‚   â”‚       @OneToMany(mappedBy = "variant")
â”‚   â”‚       private Set<StockTransaction> stockTransactions = new LinkedHashSet<>();
â”‚   â”‚   
â”‚   â”‚   }
â”‚   â”œâ”€â”€ Promotion.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import lombok.*;
â”‚   â”‚   
â”‚   â”‚   import java.math.BigDecimal;
â”‚   â”‚   import java.time.LocalDateTime;
â”‚   â”‚   
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "promotions")
â”‚   â”‚   @Data
â”‚   â”‚   @Builder
â”‚   â”‚   @NoArgsConstructor
â”‚   â”‚   @AllArgsConstructor
â”‚   â”‚   public class Promotion {
â”‚   â”‚   
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       private Integer id;
â”‚   â”‚   
â”‚   â”‚       @Column(nullable = false, unique = true, length = 50)
â”‚   â”‚       private String code;
â”‚   â”‚   
â”‚   â”‚       @Column(nullable = false, length = 150)
â”‚   â”‚       private String name;
â”‚   â”‚   
â”‚   â”‚       @Column(length = 500)
â”‚   â”‚       private String description;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "discount_type", nullable = false, length = 20)
â”‚   â”‚       private String discountType; // PERCENT / AMOUNT
â”‚   â”‚   
â”‚   â”‚       @Column(name = "discount_value", nullable = false, precision = 12, scale = 2)
â”‚   â”‚       private BigDecimal discountValue;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "min_order_amount", precision = 15, scale = 2)
â”‚   â”‚       private BigDecimal minOrderAmount;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "applicability_json", columnDefinition = "NVARCHAR(MAX)")
â”‚   â”‚       private String applicabilityJson;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "rules_json", columnDefinition = "NVARCHAR(MAX)")
â”‚   â”‚       private String rulesJson;
â”‚   â”‚   
â”‚   â”‚       @Builder.Default
â”‚   â”‚       @Column(nullable = false)
â”‚   â”‚       private Integer priority = 0;
â”‚   â”‚   
â”‚   â”‚       @Builder.Default
â”‚   â”‚       @Column(nullable = false)
â”‚   â”‚       private Boolean stackable = false;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "start_date", nullable = false)
â”‚   â”‚       private LocalDateTime startDate;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "end_date", nullable = false)
â”‚   â”‚       private LocalDateTime endDate;
â”‚   â”‚   
â”‚   â”‚       @Builder.Default
â”‚   â”‚       @Column(name = "is_active", nullable = false)
â”‚   â”‚       private Boolean isActive = true;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "created_by")
â”‚   â”‚       private Integer createdBy;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private LocalDateTime createdAt;
â”‚   â”‚   }
â”‚   â”œâ”€â”€ PromotionRedemption.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   
â”‚   â”‚   import java.time.LocalDateTime;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "promotion_redemptions")
â”‚   â”‚   public class PromotionRedemption {
â”‚   â”‚   
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       private Long id;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "promotion_id", nullable = false, unique = true)
â”‚   â”‚       private Integer promotionId;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "used_count", nullable = false)
â”‚   â”‚       private Long usedCount = 0L;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "updated_at", nullable = false)
â”‚   â”‚       private LocalDateTime updatedAt;
â”‚   â”‚   
â”‚   â”‚       @PrePersist
â”‚   â”‚       public void prePersist() {
â”‚   â”‚           if (usedCount == null) usedCount = 0L;
â”‚   â”‚           if (updatedAt == null) updatedAt = LocalDateTime.now();
â”‚   â”‚       }
â”‚   â”‚   
â”‚   â”‚       @PreUpdate
â”‚   â”‚       public void preUpdate() {
â”‚   â”‚           updatedAt = LocalDateTime.now();
â”‚   â”‚       }
â”‚   â”‚   }
â”‚   â”œâ”€â”€ Return.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import lombok.*;
â”‚   â”‚   import java.math.BigDecimal;
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "returns")
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @NoArgsConstructor
â”‚   â”‚   @AllArgsConstructor
â”‚   â”‚   @Builder
â”‚   â”‚   public class Return {
â”‚   â”‚   
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       private Long id;
â”‚   â”‚   
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY)
â”‚   â”‚       @JoinColumn(name = "order_id", nullable = false)
â”‚   â”‚       private Order order;
â”‚   â”‚   
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY)
â”‚   â”‚       @JoinColumn(name = "order_item_id", nullable = false)
â”‚   â”‚       private OrderItem orderItem;
â”‚   â”‚   
â”‚   â”‚       @Column(nullable = false)
â”‚   â”‚       private Integer quantity;
â”‚   â”‚   
â”‚   â”‚       @Column(length = 500)
â”‚   â”‚       private String reason;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "refund_amount", precision = 15, scale = 2, nullable = false)
â”‚   â”‚       private BigDecimal refundAmount = BigDecimal.ZERO;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "refund_method", length = 50)
â”‚   â”‚       private String refundMethod;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "refund_status", length = 20, nullable = false)
â”‚   â”‚       private String refundStatus = "PENDING";
â”‚   â”‚   
â”‚   â”‚       @Column(name = "refunded_at")
â”‚   â”‚       private Instant refundedAt;
â”‚   â”‚   
â”‚   â”‚       @Column(length = 20, nullable = false)
â”‚   â”‚       private String status = "PENDING";
â”‚   â”‚   
â”‚   â”‚       @Column(columnDefinition = "NVARCHAR(MAX)")
â”‚   â”‚       private String note;
â”‚   â”‚   
â”‚   â”‚       // âœ… CHá»ˆ LÆ¯U ID, KHÃ”NG DÃ™NG @ManyToOne
â”‚   â”‚       @Column(name = "processed_by")
â”‚   â”‚       private Integer processedBy;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private Instant createdAt = Instant.now();
â”‚   â”‚   }
â”‚   â”œâ”€â”€ Role.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   public enum Role {
â”‚   â”‚       ADMIN, SALES, INVENTORY, CUSTOMER
â”‚   â”‚   }
â”‚   â”œâ”€â”€ StockTransaction.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import jakarta.validation.constraints.NotNull;
â”‚   â”‚   import jakarta.validation.constraints.Size;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import org.hibernate.annotations.ColumnDefault;
â”‚   â”‚   import org.hibernate.annotations.Nationalized;
â”‚   â”‚   import org.hibernate.annotations.OnDelete;
â”‚   â”‚   import org.hibernate.annotations.OnDeleteAction;
â”‚   â”‚   
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "stock_transactions")
â”‚   â”‚   public class StockTransaction {
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       @Column(name = "id", nullable = false)
â”‚   â”‚       private Long id;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY, optional = false)
â”‚   â”‚       @OnDelete(action = OnDeleteAction.CASCADE)
â”‚   â”‚       @JoinColumn(name = "variant_id", nullable = false)
â”‚   â”‚       private ProductVariant variant;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @Column(name = "quantity", nullable = false)
â”‚   â”‚       private Integer quantity;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 30)
â”‚   â”‚       @NotNull
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "type", nullable = false, length = 30)
â”‚   â”‚       private String type;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 50)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "reference_type", length = 50)
â”‚   â”‚       private String referenceType;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "reference_id")
â”‚   â”‚       private Long referenceId;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 500)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "note", length = 500)
â”‚   â”‚       private String note;
â”‚   â”‚   
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY)
â”‚   â”‚       @OnDelete(action = OnDeleteAction.SET_NULL)
â”‚   â”‚       @JoinColumn(name = "created_by")
â”‚   â”‚       private User createdBy;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private Instant createdAt;
â”‚   â”‚   
â”‚   â”‚   }
â”‚   â”œâ”€â”€ SystemSetting.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import java.time.LocalDateTime;
â”‚   â”‚   
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "system_settings")
â”‚   â”‚   public class SystemSetting {
â”‚   â”‚       @Id
â”‚   â”‚       @Column(name = "setting_key", length = 50)
â”‚   â”‚       private String key;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "setting_value", nullable = false, length = 100)
â”‚   â”‚       private String value;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "updated_at", nullable = false)
â”‚   â”‚       private LocalDateTime updatedAt;
â”‚   â”‚   
â”‚   â”‚       public String getKey() { return key; }
â”‚   â”‚       public void setKey(String key) { this.key = key; }
â”‚   â”‚       public String getValue() { return value; }
â”‚   â”‚       public void setValue(String value) { this.value = value; }
â”‚   â”‚       public LocalDateTime getUpdatedAt() { return updatedAt; }
â”‚   â”‚       public void setUpdatedAt(LocalDateTime updatedAt) { this.updatedAt = updatedAt; }
â”‚   â”‚   }
â”‚   â”œâ”€â”€ Tag.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import jakarta.validation.constraints.NotNull;
â”‚   â”‚   import jakarta.validation.constraints.Size;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import org.hibernate.annotations.ColumnDefault;
â”‚   â”‚   import org.hibernate.annotations.Nationalized;
â”‚   â”‚   
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "tags")
â”‚   â”‚   public class Tag {
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       @Column(name = "id", nullable = false)
â”‚   â”‚       private Integer id;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 80)
â”‚   â”‚       @NotNull
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "name", nullable = false, length = 80)
â”‚   â”‚       private String name;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 30)
â”‚   â”‚       @NotNull
â”‚   â”‚       @Nationalized
â”‚   â”‚       @ColumnDefault("'GENERAL'")
â”‚   â”‚       @Column(name = "tag_type", nullable = false, length = 30)
â”‚   â”‚       private String tagType;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("1")
â”‚   â”‚       @Column(name = "is_active", nullable = false)
â”‚   â”‚       private Boolean isActive = false;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private Instant createdAt;
â”‚   â”‚   
â”‚   â”‚   }
â”‚   â”œâ”€â”€ User.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import lombok.*;
â”‚   â”‚   
â”‚   â”‚   import java.time.LocalDateTime;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @NoArgsConstructor
â”‚   â”‚   @AllArgsConstructor
â”‚   â”‚   @Builder
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "users", schema = "dbo")
â”‚   â”‚   public class User {
â”‚   â”‚   
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       private Integer id;
â”‚   â”‚   
â”‚   â”‚       @Column(nullable = false, unique = true, length = 50)
â”‚   â”‚       private String username;
â”‚   â”‚   
â”‚   â”‚       @Column(nullable = false, unique = true, length = 100)
â”‚   â”‚       private String email;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "password_hash", nullable = false, length = 255)
â”‚   â”‚       private String passwordHash;
â”‚   â”‚   
â”‚   â”‚       /**
â”‚   â”‚        * Role há»£p lá»‡: ADMIN, SALES, INVENTORY, CUSTOMER
â”‚   â”‚        */
â”‚   â”‚       @Column(nullable = false, length = 30)
â”‚   â”‚       private String role;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "is_active", nullable = false)
â”‚   â”‚       private Boolean isActive;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private LocalDateTime createdAt;
â”‚   â”‚   
â”‚   â”‚       @Column(name = "updated_at", nullable = false)
â”‚   â”‚       private LocalDateTime updatedAt;
â”‚   â”‚   
â”‚   â”‚       @PrePersist
â”‚   â”‚       public void prePersist() {
â”‚   â”‚           LocalDateTime now = LocalDateTime.now();
â”‚   â”‚           if (createdAt == null) createdAt = now;
â”‚   â”‚           if (updatedAt == null) updatedAt = now;
â”‚   â”‚           if (isActive == null) isActive = true;
â”‚   â”‚   
â”‚   â”‚           // máº·c Ä‘á»‹nh theo schema
â”‚   â”‚           if (role == null || role.isBlank()) role = "CUSTOMER";
â”‚   â”‚       }
â”‚   â”‚   
â”‚   â”‚       @PreUpdate
â”‚   â”‚       public void preUpdate() {
â”‚   â”‚           updatedAt = LocalDateTime.now();
â”‚   â”‚       }
â”‚   â”‚   }
â”‚   â”œâ”€â”€ UserLogin.java
â”‚   â”‚   package com.retailmanagement.entity;
â”‚   â”‚   
â”‚   â”‚   import jakarta.persistence.*;
â”‚   â”‚   import jakarta.validation.constraints.NotNull;
â”‚   â”‚   import jakarta.validation.constraints.Size;
â”‚   â”‚   import lombok.Getter;
â”‚   â”‚   import lombok.Setter;
â”‚   â”‚   import org.hibernate.annotations.ColumnDefault;
â”‚   â”‚   import org.hibernate.annotations.Nationalized;
â”‚   â”‚   import org.hibernate.annotations.OnDelete;
â”‚   â”‚   import org.hibernate.annotations.OnDeleteAction;
â”‚   â”‚   
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   
â”‚   â”‚   @Getter
â”‚   â”‚   @Setter
â”‚   â”‚   @Entity
â”‚   â”‚   @Table(name = "user_logins")
â”‚   â”‚   public class UserLogin {
â”‚   â”‚       @Id
â”‚   â”‚       @GeneratedValue(strategy = GenerationType.IDENTITY)
â”‚   â”‚       @Column(name = "id", nullable = false)
â”‚   â”‚       private Long id;
â”‚   â”‚   
â”‚   â”‚       @ManyToOne(fetch = FetchType.LAZY)
â”‚   â”‚       @OnDelete(action = OnDeleteAction.SET_NULL)
â”‚   â”‚       @JoinColumn(name = "user_id")
â”‚   â”‚       private User user;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 50)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "username", length = 50)
â”‚   â”‚       private String username;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @Column(name = "success", nullable = false)
â”‚   â”‚       private Boolean success = false;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 45)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "ip_address", length = 45)
â”‚   â”‚       private String ipAddress;
â”‚   â”‚   
â”‚   â”‚       @Size(max = 400)
â”‚   â”‚       @Nationalized
â”‚   â”‚       @Column(name = "user_agent", length = 400)
â”‚   â”‚       private String userAgent;
â”‚   â”‚   
â”‚   â”‚       @NotNull
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "created_at", nullable = false)
â”‚   â”‚       private Instant createdAt;
â”‚   â”‚   
â”‚   â”‚       @ColumnDefault("sysdatetime()")
â”‚   â”‚       @Column(name = "updated_at", nullable = false)
â”‚   â”‚       private Instant updatedAt;
â”‚   â”‚   
â”‚   â”‚       @PrePersist
â”‚   â”‚       public void prePersist() {
â”‚   â”‚           this.createdAt = Instant.now();
â”‚   â”‚       }
â”‚   â”‚   }
â”‚   â””â”€â”€ VipTier.java
â”‚       package com.retailmanagement.entity;
â”‚       
â”‚       import lombok.Getter;
â”‚       
â”‚       @Getter
â”‚       public enum VipTier {
â”‚           // Sá»­a discountRate thÃ nh dáº¡ng tháº­p phÃ¢n: 0.05 = 5%
â”‚           BRONZE("BRONZE", 100, 499, 0.05),      
â”‚           SILVER("SILVER", 500, 999, 0.10),       
â”‚           GOLD("GOLD", 1000, 2499, 0.15),      
â”‚           PLATINUM("PLATINUM", 2500, 4999, 0.20), 
â”‚           DIAMOND("DIAMOND", 5000, Integer.MAX_VALUE, 0.25); 
â”‚       
â”‚           private final String displayName;
â”‚           private final Integer minPoints;
â”‚           private final Integer maxPoints;
â”‚           private final Double discountRate; // Äá»•i tÃªn cho rÃµ nghÄ©a
â”‚       
â”‚           VipTier(String displayName, Integer minPoints, Integer maxPoints, Double discountRate) {
â”‚               this.displayName = displayName;
â”‚               this.minPoints = minPoints;
â”‚               this.maxPoints = maxPoints;
â”‚               this.discountRate = discountRate;
â”‚           }
â”‚       
â”‚           public static VipTier fromPoints(Integer points) {
â”‚               if (points == null || points < 100) return null; // < 100 Ä‘iá»ƒm lÃ  khÃ¡ch thÆ°á»ng
â”‚               for (VipTier tier : values()) {
â”‚                   if (points >= tier.minPoints && points <= tier.maxPoints) {
â”‚                       return tier;
â”‚                   }
â”‚               }
â”‚               return DIAMOND;
â”‚           }
â”‚       
â”‚           // Láº¥y má»‘c Ä‘iá»ƒm cá»§a háº¡ng tiáº¿p theo
â”‚           public Integer getNextTierThreshold() {
â”‚               VipTier[] tiers = values();
â”‚               int currentIndex = this.ordinal();
â”‚               if (currentIndex < tiers.length - 1) {
â”‚                   return tiers[currentIndex + 1].minPoints;
â”‚               }
â”‚               return null; // ÄÃ£ max cáº¥p
â”‚           }
â”‚       }
â”œâ”€â”€ exception
â”‚   â”œâ”€â”€ ErrorResponse.java
â”‚   â”‚   package com.retailmanagement.exception;
â”‚   â”‚   
â”‚   â”‚   import lombok.AllArgsConstructor;
â”‚   â”‚   import lombok.Data;
â”‚   â”‚   import lombok.NoArgsConstructor;
â”‚   â”‚   import java.time.LocalDateTime;
â”‚   â”‚   
â”‚   â”‚   @Data
â”‚   â”‚   @NoArgsConstructor
â”‚   â”‚   @AllArgsConstructor
â”‚   â”‚   public class ErrorResponse {
â”‚   â”‚       private int status;
â”‚   â”‚       private String message;
â”‚   â”‚       private LocalDateTime timestamp;
â”‚   â”‚   }
â”‚   â””â”€â”€ GlobalExceptionHandler.java
â”‚       package com.retailmanagement.exception;
â”‚       
â”‚       import com.retailmanagement.dto.response.ApiResponse;
â”‚       import org.springframework.http.HttpStatus;
â”‚       import org.springframework.http.ResponseEntity;
â”‚       import org.springframework.validation.FieldError;
â”‚       import org.springframework.web.bind.MethodArgumentNotValidException;
â”‚       import org.springframework.web.bind.annotation.ExceptionHandler;
â”‚       import org.springframework.web.bind.annotation.RestControllerAdvice;
â”‚       
â”‚       import java.io.IOException;
â”‚       import java.util.HashMap;
â”‚       import java.util.Map;
â”‚       
â”‚       @RestControllerAdvice
â”‚       public class GlobalExceptionHandler {
â”‚       
â”‚           @ExceptionHandler(MethodArgumentNotValidException.class)
â”‚           public ResponseEntity<ApiResponse<Map<String, String>>> handleValidationExceptions(MethodArgumentNotValidException ex) {
â”‚               Map<String, String> errors = new HashMap<>();
â”‚               ex.getBindingResult().getAllErrors().forEach(error -> {
â”‚                   String fieldName = ((FieldError) error).getField();
â”‚                   String errorMessage = error.getDefaultMessage();
â”‚                   errors.put(fieldName, errorMessage);
â”‚               });
â”‚       
â”‚               return ResponseEntity.status(HttpStatus.BAD_REQUEST)
â”‚                       .body(ApiResponse.error("Dá»¯ liá»‡u khÃ´ng há»£p lá»‡", errors));
â”‚           }
â”‚       
â”‚           @ExceptionHandler(IOException.class)
â”‚           public ResponseEntity<ApiResponse<Object>> handleIo(IOException ex) {
â”‚               return ResponseEntity.status(HttpStatus.BAD_REQUEST)
â”‚                       .body(ApiResponse.error("Lá»—i upload: " + ex.getMessage()));
â”‚           }
â”‚       
â”‚           @ExceptionHandler(IllegalArgumentException.class)
â”‚           public ResponseEntity<ApiResponse<Object>> handleIllegalArgument(IllegalArgumentException ex) {
â”‚               return ResponseEntity.status(HttpStatus.BAD_REQUEST)
â”‚                       .body(ApiResponse.error(ex.getMessage()));
â”‚           }
â”‚       
â”‚           @ExceptionHandler(RuntimeException.class)
â”‚           public ResponseEntity<ApiResponse<Object>> handleRuntimeException(RuntimeException ex) {
â”‚               return ResponseEntity.status(HttpStatus.BAD_REQUEST)
â”‚                       .body(ApiResponse.error(ex.getMessage()));
â”‚           }
â”‚       
â”‚           @ExceptionHandler(Exception.class)
â”‚           public ResponseEntity<ApiResponse<Object>> handleGeneralException(Exception ex) {
â”‚               return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
â”‚                       .body(ApiResponse.error("Lá»—i há»‡ thá»‘ng: " + ex.getMessage()));
â”‚           }
â”‚       }
â”œâ”€â”€ repository
â”‚   â”œâ”€â”€ CartItemRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.CartItem;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   
â”‚   â”‚   import java.util.List;
â”‚   â”‚   import java.util.Optional;
â”‚   â”‚   
â”‚   â”‚   public interface CartItemRepository extends JpaRepository<CartItem, Integer> {
â”‚   â”‚   
â”‚   â”‚       Optional<CartItem> findByCustomerIdAndProductVariantId(
â”‚   â”‚               Integer customerId,
â”‚   â”‚               Integer productVariantId
â”‚   â”‚       );
â”‚   â”‚   
â”‚   â”‚       List<CartItem> findByCustomerId(Integer customerId);
â”‚   â”‚   
â”‚   â”‚       long countByCustomerId(Integer customerId);
â”‚   â”‚   
â”‚   â”‚       void deleteByCustomerId(Integer customerId);
â”‚   â”‚   }
â”‚   â”œâ”€â”€ CategoryRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.Category;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   
â”‚   â”‚   import java.util.List;
â”‚   â”‚   
â”‚   â”‚   public interface CategoryRepository extends JpaRepository<Category, Integer> {
â”‚   â”‚       List<Category> findByIsActiveTrueOrderByDisplayOrderAscNameAsc();
â”‚   â”‚       List<Category> findAllByOrderByDisplayOrderAscNameAsc();
â”‚   â”‚   }
â”‚   â”œâ”€â”€ CustomRes.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.Customer;
â”‚   â”‚   import com.retailmanagement.entity.CustomerType;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   import org.springframework.data.jpa.repository.Query;
â”‚   â”‚   import org.springframework.data.repository.query.*;
â”‚   â”‚   import org.springframework.stereotype.Repository;
â”‚   â”‚   
â”‚   â”‚   import java.time.LocalDateTime;
â”‚   â”‚   import java.util.List;
â”‚   â”‚   import java.util.Optional;
â”‚   â”‚   @Repository
â”‚   â”‚   public interface CustomRes extends JpaRepository<Customer, Integer> {
â”‚   â”‚       Optional<Customer> findByEmail(String Email);
â”‚   â”‚       Optional<Customer> findByPhone(String phone);
â”‚   â”‚       List<Customer> findAll();
â”‚   â”‚       List<Customer> findByCustomerType(CustomerType type);
â”‚   â”‚       Optional<Customer> findByName(String name);
â”‚   â”‚   
â”‚   â”‚       Optional<Customer> findById(Integer id);
â”‚   â”‚   
â”‚   â”‚       @Query("SELECT c FROM Customer c WHERE c.lastLoginAt >= :since AND c.isActive = true ORDER BY c.lastLoginAt DESC")
â”‚   â”‚       List<Customer> findActiveCustomersSince(@Param("since") LocalDateTime since);
â”‚   â”‚   
â”‚   â”‚       @Query(value = "SELECT * FROM customers WHERE is_active = 1 " +
â”‚   â”‚               "AND MONTH(date_of_birth) = MONTH(GETDATE()) " +
â”‚   â”‚               "AND DAY(date_of_birth) = DAY(GETDATE())",
â”‚   â”‚               nativeQuery = true)
â”‚   â”‚       List<Customer> findCustomersWithBirthdayToday();
â”‚   â”‚   
â”‚   â”‚       /**
â”‚   â”‚        * TÃ¬m khÃ¡ch hÃ ng cÃ³ sinh nháº­t trong thÃ¡ng cá»¥ thá»ƒ
â”‚   â”‚        */
â”‚   â”‚       @Query(value = "SELECT * FROM customers WHERE is_active = 1 " +
â”‚   â”‚               "AND MONTH(date_of_birth) = :month " +
â”‚   â”‚               "ORDER BY DAY(date_of_birth)",
â”‚   â”‚               nativeQuery = true)
â”‚   â”‚       List<Customer> findCustomersWithBirthdayInMonth(@Param("month") int month);
â”‚   â”‚   
â”‚   â”‚       /**
â”‚   â”‚        * TÃ¬m khÃ¡ch hÃ ng cÃ³ sinh nháº­t trong khoáº£ng thá»i gian
â”‚   â”‚        */
â”‚   â”‚       @Query(value = "SELECT * FROM customers WHERE is_active = 1 " +
â”‚   â”‚               "AND ((MONTH(date_of_birth) = :startMonth AND DAY(date_of_birth) >= :startDay) " +
â”‚   â”‚               "     OR (MONTH(date_of_birth) = :endMonth AND DAY(date_of_birth) <= :endDay) " +
â”‚   â”‚               "     OR (MONTH(date_of_birth) > :startMonth AND MONTH(date_of_birth) < :endMonth)) " +
â”‚   â”‚               "ORDER BY MONTH(date_of_birth), DAY(date_of_birth)",
â”‚   â”‚               nativeQuery = true)
â”‚   â”‚       List<Customer> findCustomersWithBirthdayBetween(
â”‚   â”‚               @Param("startMonth") int startMonth,
â”‚   â”‚               @Param("startDay") int startDay,
â”‚   â”‚               @Param("endMonth") int endMonth,
â”‚   â”‚               @Param("endDay") int endDay
â”‚   â”‚       );
â”‚   â”‚   
â”‚   â”‚       /**
â”‚   â”‚        * Äáº¿m sá»‘ khÃ¡ch hÃ ng cÃ³ sinh nháº­t trong thÃ¡ng
â”‚   â”‚        */
â”‚   â”‚       @Query(value = "SELECT COUNT(*) FROM customers WHERE is_active = 1 " +
â”‚   â”‚               "AND MONTH(date_of_birth) = :month",
â”‚   â”‚               nativeQuery = true)
â”‚   â”‚       long countCustomersWithBirthdayInMonth(@Param("month") int month);
â”‚   â”‚   }
â”‚   â”œâ”€â”€ ImageRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.Image;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   import org.springframework.stereotype.Repository;
â”‚   â”‚   import java.util.Optional;
â”‚   â”‚   
â”‚   â”‚   @Repository
â”‚   â”‚   public interface ImageRepository extends JpaRepository<Image, Long> {
â”‚   â”‚       Optional<Image> findFirstByProductIdAndIsPrimaryTrue(Integer productId);
â”‚   â”‚   }
â”‚   â”œâ”€â”€ LoyaltyLedgerRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.LoyaltyLedger;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   import org.springframework.data.jpa.repository.Query;
â”‚   â”‚   import org.springframework.data.repository.query.Param;
â”‚   â”‚   import org.springframework.stereotype.Repository;
â”‚   â”‚   
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   import java.util.List;
â”‚   â”‚   
â”‚   â”‚   @Repository
â”‚   â”‚   public interface LoyaltyLedgerRepository extends JpaRepository<LoyaltyLedger, Long> {
â”‚   â”‚   
â”‚   â”‚       /**
â”‚   â”‚        * Find all loyalty ledger entries for a specific customer
â”‚   â”‚        */
â”‚   â”‚       List<LoyaltyLedger> findByCustomerIdOrderByCreatedAtDesc(Integer customerId);
â”‚   â”‚   
â”‚   â”‚       /**
â”‚   â”‚        * Find loyalty ledger entries by reference (e.g., order or return)
â”‚   â”‚        */
â”‚   â”‚       List<LoyaltyLedger> findByReferenceTypeAndReferenceId(String referenceType, Long referenceId);
â”‚   â”‚   
â”‚   â”‚       /**
â”‚   â”‚        * Find entries within a date range for reporting
â”‚   â”‚        */
â”‚   â”‚       @Query("SELECT l FROM LoyaltyLedger l WHERE l.customer.id = :customerId " +
â”‚   â”‚               "AND l.createdAt BETWEEN :startDate AND :endDate ORDER BY l.createdAt DESC")
â”‚   â”‚       List<LoyaltyLedger> findByCustomerAndDateRange(
â”‚   â”‚               @Param("customerId") Integer customerId,
â”‚   â”‚               @Param("startDate") Instant startDate,
â”‚   â”‚               @Param("endDate") Instant endDate
â”‚   â”‚       );
â”‚   â”‚   
â”‚   â”‚       /**
â”‚   â”‚        * Calculate total points earned/spent by reason
â”‚   â”‚        */
â”‚   â”‚       @Query("SELECT SUM(l.pointsDelta) FROM LoyaltyLedger l " +
â”‚   â”‚               "WHERE l.customer.id = :customerId AND l.reason = :reason")
â”‚   â”‚       Integer sumPointsByCustomerAndReason(
â”‚   â”‚               @Param("customerId") Integer customerId,
â”‚   â”‚               @Param("reason") String reason
â”‚   â”‚       );
â”‚   â”‚       @Query("SELECT ll FROM LoyaltyLedger ll WHERE ll.customer.id = :customerId " +
â”‚   â”‚               "AND ll.tierBefore IS NOT NULL AND ll.tierAfter IS NOT NULL " +
â”‚   â”‚               "ORDER BY ll.createdAt DESC")
â”‚   â”‚       List<LoyaltyLedger> findTierChanges(@Param("customerId") Integer customerId);
â”‚   â”‚       List<LoyaltyLedger> findTop10ByCustomerIdOrderByCreatedAtDesc(Integer customerId);
â”‚   â”‚   }
â”‚   â”œâ”€â”€ NotificationRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.Notification;
â”‚   â”‚   import com.retailmanagement.entity.NotificationType;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   import org.springframework.stereotype.Repository;
â”‚   â”‚   
â”‚   â”‚   import java.time.LocalDateTime;
â”‚   â”‚   import java.util.List;
â”‚   â”‚   
â”‚   â”‚   @Repository
â”‚   â”‚   public interface NotificationRepository extends JpaRepository<Notification, Long> {
â”‚   â”‚   
â”‚   â”‚       /**
â”‚   â”‚        * TÃ¬m táº¥t cáº£ thÃ´ng bÃ¡o cá»§a khÃ¡ch hÃ ng theo thá»© tá»± má»›i nháº¥t
â”‚   â”‚        */
â”‚   â”‚       List<Notification> findByCustomerIdOrderByCreatedAtDesc(Integer customerId);
â”‚   â”‚   
â”‚   â”‚       /**
â”‚   â”‚        * TÃ¬m thÃ´ng bÃ¡o chÆ°a Ä‘á»c cá»§a khÃ¡ch hÃ ng
â”‚   â”‚        */
â”‚   â”‚       List<Notification> findByCustomerIdAndIsReadFalseOrderByCreatedAtDesc(Integer customerId);
â”‚   â”‚   
â”‚   â”‚       /**
â”‚   â”‚        * Äáº¿m sá»‘ thÃ´ng bÃ¡o chÆ°a Ä‘á»c
â”‚   â”‚        */
â”‚   â”‚       long countByCustomerIdAndIsReadFalse(Integer customerId);
â”‚   â”‚   
â”‚   â”‚       /**
â”‚   â”‚        * Kiá»ƒm tra xem Ä‘Ã£ cÃ³ thÃ´ng bÃ¡o loáº¡i nÃ y trong khoáº£ng thá»i gian chÆ°a
â”‚   â”‚        */
â”‚   â”‚       boolean existsByCustomerIdAndTypeAndCreatedAtBetween(
â”‚   â”‚               Integer customerId,
â”‚   â”‚               NotificationType type,
â”‚   â”‚               LocalDateTime startDate,
â”‚   â”‚               LocalDateTime endDate
â”‚   â”‚       );
â”‚   â”‚   
â”‚   â”‚       /**
â”‚   â”‚        * TÃ¬m thÃ´ng bÃ¡o theo loáº¡i
â”‚   â”‚        */
â”‚   â”‚       List<Notification> findByCustomerIdAndTypeOrderByCreatedAtDesc(Integer customerId, NotificationType type);
â”‚   â”‚   }
â”‚   â”œâ”€â”€ OrderItemRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.OrderItem;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   
â”‚   â”‚   public interface OrderItemRepository extends JpaRepository<OrderItem, Long> {
â”‚   â”‚   }
â”‚   â”œâ”€â”€ OrderRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.Order;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   import org.springframework.data.jpa.repository.Query;
â”‚   â”‚   import org.springframework.data.repository.query.Param;
â”‚   â”‚   
â”‚   â”‚   import java.math.BigDecimal;
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   import java.util.List;
â”‚   â”‚   
â”‚   â”‚   public interface OrderRepository extends JpaRepository<Order, Long> {
â”‚   â”‚   
â”‚   â”‚       List<Order> findByStatusOrderByCreatedAtDesc(String status);
â”‚   â”‚   
â”‚   â”‚       List<Order> findByStatusInOrderByCreatedAtDesc(List<String> statuses);
â”‚   â”‚   
â”‚   â”‚       long countByCreatedAtBetween(Instant start, Instant end);
â”‚   â”‚   
â”‚   â”‚       List<Order> findByCustomerIdOrderByCreatedAtDesc(Integer customerId);
â”‚   â”‚   }
â”‚   â”œâ”€â”€ PaymentRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.Order;
â”‚   â”‚   import com.retailmanagement.entity.Payment;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   import org.springframework.data.jpa.repository.Query;
â”‚   â”‚   import org.springframework.data.repository.query.Param;
â”‚   â”‚   import org.springframework.stereotype.Repository;
â”‚   â”‚   
â”‚   â”‚   import java.math.BigDecimal;
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   import java.util.List;
â”‚   â”‚   
â”‚   â”‚   @Repository
â”‚   â”‚   public interface PaymentRepository extends JpaRepository<Payment, Long> {
â”‚   â”‚   
â”‚   â”‚       List<Payment> findByOrderId(Long orderId);
â”‚   â”‚   
â”‚   â”‚       List<Payment> findByOrderIdAndStatus(Long orderId, String status);
â”‚   â”‚       long countByCreatedAtBetween(Instant start, Instant end);
â”‚   â”‚   
â”‚   â”‚       /**
â”‚   â”‚        * TÃ¬m táº¥t cáº£ orders cá»§a má»™t customer
â”‚   â”‚        */
â”‚   â”‚   
â”‚   â”‚   
â”‚   â”‚       /**
â”‚   â”‚        * TÃ¬m orders theo status
â”‚   â”‚        */
â”‚   â”‚       List<Order> findByStatus(String status);
â”‚   â”‚   
â”‚   â”‚   
â”‚   â”‚   }
â”‚   â”œâ”€â”€ PriceHistoryRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.PriceHistory;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   
â”‚   â”‚   import java.util.List;
â”‚   â”‚   import java.util.Optional;
â”‚   â”‚   
â”‚   â”‚   public interface PriceHistoryRepository extends JpaRepository<PriceHistory, Long> {
â”‚   â”‚       List<PriceHistory> findByVariant_IdOrderByEffectiveFromDesc(Integer variantId);
â”‚   â”‚       Optional<PriceHistory> findFirstByVariant_IdAndEffectiveToIsNullOrderByEffectiveFromDesc(Integer variantId);
â”‚   â”‚   }
â”‚   â”œâ”€â”€ ProductCategoryRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.ProductCategory;
â”‚   â”‚   import com.retailmanagement.entity.ProductCategoryId;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   import org.springframework.stereotype.Repository;
â”‚   â”‚   
â”‚   â”‚   import java.util.Optional;
â”‚   â”‚   
â”‚   â”‚   @Repository
â”‚   â”‚   public interface ProductCategoryRepository extends JpaRepository<ProductCategory, ProductCategoryId> {
â”‚   â”‚       Optional<ProductCategory>
â”‚   â”‚       findFirstById_ProductIdAndIsPrimaryTrue(Integer productId);
â”‚   â”‚   }
â”‚   â”œâ”€â”€ ProductRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.Product;
â”‚   â”‚   import org.springframework.data.domain.Page;
â”‚   â”‚   import org.springframework.data.domain.Pageable;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   import org.springframework.data.jpa.repository.Query;
â”‚   â”‚   import org.springframework.data.repository.query.Param;
â”‚   â”‚   
â”‚   â”‚   public interface ProductRepository extends JpaRepository<Product, Integer> {
â”‚   â”‚   
â”‚   â”‚       @Query(
â”‚   â”‚               value =
â”‚   â”‚                       "SELECT p.* FROM products p " +
â”‚   â”‚                               "INNER JOIN product_categories pc ON p.id = pc.product_id " +
â”‚   â”‚                               "WHERE pc.category_id = :categoryId",
â”‚   â”‚               countQuery =
â”‚   â”‚                       "SELECT count(*) FROM products p " +
â”‚   â”‚                               "INNER JOIN product_categories pc ON p.id = pc.product_id " +
â”‚   â”‚                               "WHERE pc.category_id = :categoryId",
â”‚   â”‚               nativeQuery = true
â”‚   â”‚       )
â”‚   â”‚       Page<Product> findByCategoryId(@Param("categoryId") Integer categoryId, Pageable pageable);
â”‚   â”‚   
â”‚   â”‚       //TÃ¬m theo TÃªn, SKU, hoáº·c Attribute (trong chuá»—i JSON)
â”‚   â”‚       @Query(value = "SELECT * FROM products p WHERE " +
â”‚   â”‚               "(:keyword IS NULL OR :keyword = '' OR " +
â”‚   â”‚               "p.name LIKE %:keyword% OR " +
â”‚   â”‚               "p.sku LIKE %:keyword% OR " +
â”‚   â”‚               "p.attributes_json LIKE %:keyword%) " +
â”‚   â”‚               "AND (:isVisible IS NULL OR p.is_visible = :isVisible)",
â”‚   â”‚               nativeQuery = true)
â”‚   â”‚       Page<Product> searchProducts(@Param("keyword") String keyword,
â”‚   â”‚                                    @Param("isVisible") Boolean isVisible,
â”‚   â”‚                                    Pageable pageable);
â”‚   â”‚   }
â”‚   â”œâ”€â”€ ProductVariantRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.ProductVariant;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   
â”‚   â”‚   import java.util.List;
â”‚   â”‚   
â”‚   â”‚   public interface ProductVariantRepository extends JpaRepository<ProductVariant, Integer> {
â”‚   â”‚       List<ProductVariant> findByProduct_Id(Integer productId);
â”‚   â”‚   }
â”‚   â”œâ”€â”€ PromotionRedemptionRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.PromotionRedemption;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   
â”‚   â”‚   import java.util.Optional;
â”‚   â”‚   
â”‚   â”‚   public interface PromotionRedemptionRepository extends JpaRepository<PromotionRedemption, Long> {
â”‚   â”‚       Optional<PromotionRedemption> findByPromotionId(Integer promotionId);
â”‚   â”‚   }
â”‚   â”œâ”€â”€ PromotionRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.Promotion;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   
â”‚   â”‚   import java.time.LocalDateTime;
â”‚   â”‚   import java.util.List;
â”‚   â”‚   import java.util.Optional;
â”‚   â”‚   
â”‚   â”‚   public interface PromotionRepository extends JpaRepository<Promotion, Integer> {
â”‚   â”‚       Optional<Promotion> findByCode(String code);
â”‚   â”‚   
â”‚   â”‚       List<Promotion> findByIsActiveTrueAndStartDateLessThanEqualAndEndDateGreaterThanEqual(
â”‚   â”‚               LocalDateTime at1, LocalDateTime at2
â”‚   â”‚       );
â”‚   â”‚   
â”‚   â”‚       List<Promotion> findByIsActiveTrueAndStartDateLessThanEqualAndEndDateGreaterThanEqualAndIdNot(
â”‚   â”‚               LocalDateTime at1, LocalDateTime at2, Integer idNot
â”‚   â”‚       );
â”‚   â”‚   }
â”‚   â”œâ”€â”€ ReturnRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.Return;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   import org.springframework.stereotype.Repository;
â”‚   â”‚   
â”‚   â”‚   import java.util.List;
â”‚   â”‚   
â”‚   â”‚   @Repository
â”‚   â”‚   public interface ReturnRepository extends JpaRepository<Return, Long> {
â”‚   â”‚       List<Return> findByStatusOrderByCreatedAtDesc(String status);
â”‚   â”‚       List<Return> findByOrderIdOrderByCreatedAtDesc(Long orderId);
â”‚   â”‚       List<Return> findByOrder_Customer_IdOrderByCreatedAtDesc(Integer customerId);
â”‚   â”‚   }
â”‚   â”œâ”€â”€ StockTransactionRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.StockTransaction;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   
â”‚   â”‚   public interface StockTransactionRepository extends JpaRepository<StockTransaction, Long> {
â”‚   â”‚   }
â”‚   â”œâ”€â”€ SystemSettingRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.SystemSetting;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   
â”‚   â”‚   public interface SystemSettingRepository extends JpaRepository<SystemSetting, String> {}
â”‚   â”œâ”€â”€ UserLoginRepository.java
â”‚   â”‚   package com.retailmanagement.repository;
â”‚   â”‚   
â”‚   â”‚   import com.retailmanagement.entity.UserLogin;
â”‚   â”‚   import org.springframework.data.jpa.repository.JpaRepository;
â”‚   â”‚   import org.springframework.stereotype.Repository;
â”‚   â”‚   
â”‚   â”‚   import java.time.Instant;
â”‚   â”‚   import java.util.List;
â”‚   â”‚   import java.util.Optional;
â”‚   â”‚   
â”‚   â”‚   @Repository
â”‚   â”‚   public interface UserLoginRepository extends JpaRepository<UserLogin, Long> {
â”‚   â”‚       Optional<UserLogin>
â”‚   â”‚       findTopByUser_IdAndSuccessTrueAndUpdatedAtIsNullOrderByCreatedAtDesc(Integer id);
â”‚   â”‚   
â”‚   â”‚       List<UserLogin> findByCreatedAtBetween(Instant from, Instant to);
â”‚   â”‚   }
â”‚   â””â”€â”€ UserRepository.java
â”‚       package com.retailmanagement.repository;
â”‚       
â”‚       import com.retailmanagement.entity.User;
â”‚       import org.springframework.data.jpa.repository.JpaRepository;
â”‚       
â”‚       import java.util.Optional;
â”‚       
â”‚       public interface UserRepository extends JpaRepository<User, Integer> {
â”‚       
â”‚           boolean existsByUsername(String username);
â”‚           boolean existsByEmail(String email);
â”‚       
â”‚           boolean existsByUsernameAndIdNot(String username, Integer id);
â”‚           boolean existsByEmailAndIdNot(String email, Integer id);
â”‚       
â”‚           Optional<User> findByUsername(String username);
â”‚           Optional<User> findByEmail(String email);
â”‚       
â”‚           // login báº±ng username hoáº·c email
â”‚           Optional<User> findByUsernameOrEmail(String username, String email);
â”‚       }
â””â”€â”€ service
    â”œâ”€â”€ CustomerService.java
    â”‚   package com.retailmanagement.service;
    â”‚   
    â”‚   import com.retailmanagement.audit.Audit;
    â”‚   import com.retailmanagement.audit.AuditAction;
    â”‚   import com.retailmanagement.audit.AuditModule;
    â”‚   import com.retailmanagement.audit.TargetType;
    â”‚   import com.retailmanagement.dto.request.CustomerRequest;
    â”‚   import com.retailmanagement.dto.response.CustomerResponse;
    â”‚   import com.retailmanagement.entity.Customer;
    â”‚   import com.retailmanagement.entity.CustomerType;
    â”‚   import com.retailmanagement.entity.LoyaltyLedger;
    â”‚   import com.retailmanagement.entity.VipTier;
    â”‚   import com.retailmanagement.repository.CustomRes;
    â”‚   import com.retailmanagement.repository.LoyaltyLedgerRepository;
    â”‚   import jakarta.transaction.Transactional;
    â”‚   import lombok.RequiredArgsConstructor;
    â”‚   import org.springframework.beans.factory.annotation.Autowired;
    â”‚   import org.springframework.stereotype.Service;
    â”‚   
    â”‚   import java.math.BigDecimal;
    â”‚   import java.time.Instant;
    â”‚   import java.time.LocalDateTime;
    â”‚   import java.util.List;
    â”‚   import java.util.Optional;
    â”‚   import java.util.stream.Collectors;
    â”‚   
    â”‚   @Service
    â”‚   @RequiredArgsConstructor
    â”‚   public class CustomerService {
    â”‚   
    â”‚       @Autowired
    â”‚       private final CustomRes customRes;
    â”‚       @Autowired
    â”‚       private final LoyaltyLedgerRepository loyaltyLedgerRepository;
    â”‚   
    â”‚       private void saveLoyaltyLedger(
    â”‚               Customer customer,
    â”‚               int pointsDelta,
    â”‚               String transactionType,
    â”‚               VipTier tierBefore,
    â”‚               VipTier tierAfter,
    â”‚               String reason,
    â”‚               String note,
    â”‚               String referenceType,
    â”‚               Long referenceId,
    â”‚               Integer createdBy) {
    â”‚   
    â”‚           LoyaltyLedger ledger = LoyaltyLedger.builder()
    â”‚                   .customer(customer)
    â”‚                   .pointsDelta(pointsDelta)
    â”‚                   .transactionType(transactionType)
    â”‚                   .tierBefore(tierBefore != null ? tierBefore.name() : null)
    â”‚                   .tierAfter(tierAfter != null ? tierAfter.name() : null)
    â”‚                   .reason(reason)
    â”‚                   .note(note)
    â”‚                   .referenceType(referenceType)
    â”‚                   .referenceId(referenceId)
    â”‚                   .createdBy(createdBy)
    â”‚                   .createdAt(Instant.now())
    â”‚                   .build();
    â”‚   
    â”‚           loyaltyLedgerRepository.save(ledger);
    â”‚   
    â”‚           System.out.println("âœ… Saved loyalty ledger: " + transactionType + " | Points: " + pointsDelta +
    â”‚                   " | Tier: " + (tierBefore != null ? tierBefore.name() : "NULL") +
    â”‚                   " â†’ " + (tierAfter != null ? tierAfter.name() : "NULL"));
    â”‚       }
    â”‚       private String formatMoney(BigDecimal amount) {
    â”‚           return String.format("%,d VNÄ", amount.longValue());
    â”‚       }
    â”‚   
    â”‚       private String getDeductNote(String reason, BigDecimal amount) {
    â”‚           return switch (reason) {
    â”‚               case "CANCEL_ORDER" -> "Trá»« Ä‘iá»ƒm do há»§y Ä‘Æ¡n: " + formatMoney(amount);
    â”‚               case "CANCEL_PENALTY" -> "âš ï¸ Pháº¡t 10% do há»§y Ä‘Æ¡n Ä‘Ã£ thanh toÃ¡n: " + formatMoney(amount);
    â”‚               case "RETURN" -> "Trá»« Ä‘iá»ƒm do tráº£ hÃ ng: " + formatMoney(amount);
    â”‚               default -> "Trá»« Ä‘iá»ƒm: " + formatMoney(amount);
    â”‚           };
    â”‚       }
    â”‚       @Audit(
    â”‚               module = AuditModule.CUSTOMER,
    â”‚               action = AuditAction.CREATE,
    â”‚               targetType = TargetType.CUSTOMER
    â”‚       )
    â”‚       @Transactional
    â”‚       public CustomerResponse create(CustomerRequest customerRequest) {
    â”‚           if (customRes.findByEmail(customerRequest.getEmail()).isPresent()) {
    â”‚               throw new RuntimeException("Email Ä‘Ã£ tá»“n táº¡i trong há»‡ thá»‘ng");
    â”‚           }
    â”‚           if (customRes.findByPhone(customerRequest.getPhone()).isPresent()) {
    â”‚               throw new RuntimeException("Sá»‘ Ä‘iá»‡n thoáº¡i Ä‘Ã£ tá»“n táº¡i trong há»‡ thá»‘ng");
    â”‚           }
    â”‚   
    â”‚           CustomerType type = (customerRequest.getCustomerType() != null)
    â”‚                   ? customerRequest.getCustomerType()
    â”‚                   : CustomerType.REGULAR;
    â”‚   
    â”‚           Customer customer = Customer.builder()
    â”‚                   .name(customerRequest.getFullName())
    â”‚                   .email(customerRequest.getEmail())
    â”‚                   .phone(customerRequest.getPhone())
    â”‚                   .dateOfBirth(customerRequest.getBirthDate())
    â”‚                   .address(customerRequest.getAddress())
    â”‚                   .notes(customerRequest.getNotes())
    â”‚                   .customerType(type)
    â”‚                   .vipTier(null)              // Máº·c Ä‘á»‹nh chÆ°a cÃ³ háº¡ng (KhÃ¡ch thÆ°á»ng)
    â”‚                   .totalSpent(BigDecimal.ZERO)
    â”‚                   .loyaltyPoints(0)           // Äiá»ƒm báº¯t Ä‘áº§u = 0
    â”‚                   .isActive(true)
    â”‚                   .build();
    â”‚   
    â”‚           Customer saved = customRes.save(customer);
    â”‚           return mapToResponse(saved);
    â”‚       }
    â”‚   
    â”‚       private CustomerResponse mapToResponse(Customer customer) {
    â”‚           VipTier currentTier = customer.getVipTier();
    â”‚           int currentPoints = customer.getLoyaltyPoints() != null ? customer.getLoyaltyPoints() : 0;
    â”‚   
    â”‚           // --- Logic tÃ­nh Ä‘iá»ƒm lÃªn háº¡ng ---
    â”‚           Integer pointsToNext = 0;
    â”‚   
    â”‚           if (currentTier == null) {
    â”‚               // Náº¿u chÆ°a cÃ³ háº¡ng (KhÃ¡ch thÆ°á»ng), Ä‘Ã­ch Ä‘áº¿n lÃ  BRONZE
    â”‚               pointsToNext = VipTier.BRONZE.getMinPoints() - currentPoints;
    â”‚           } else {
    â”‚               // Náº¿u Ä‘Ã£ cÃ³ háº¡ng, láº¥y má»‘c cá»§a háº¡ng tiáº¿p theo
    â”‚               Integer nextThreshold = currentTier.getNextTierThreshold();
    â”‚               if (nextThreshold != null) {
    â”‚                   pointsToNext = nextThreshold - currentPoints;
    â”‚               } else {
    â”‚                   pointsToNext = 0; // ÄÃ£ lÃ  Max Level (DIAMOND)
    â”‚               }
    â”‚           }
    â”‚           // Äáº£m báº£o khÃ´ng hiá»ƒn thá»‹ sá»‘ Ã¢m
    â”‚           if (pointsToNext < 0) pointsToNext = 0;
    â”‚   
    â”‚           return CustomerResponse.builder()
    â”‚                   .id(customer.getId())
    â”‚                   .name(customer.getName())
    â”‚                   .email(customer.getEmail())
    â”‚                   .phone(customer.getPhone())
    â”‚                   .dateOfBirth(customer.getDateOfBirth())
    â”‚                   .customerType(customer.getCustomerType())
    â”‚                   .customerTypeDisplay(customer.getCustomerType().getDisplayname())
    â”‚                   .vipTier(currentTier)
    â”‚                   .vipTierDisplay(currentTier != null ? currentTier.getDisplayName() : "Member") // Hiá»ƒn thá»‹ Member náº¿u null
    â”‚                   .loyaltyPoints(currentPoints)
    â”‚                   .pointsToNextTier(pointsToNext)
    â”‚                   .discountRate(currentTier != null ? currentTier.getDiscountRate() : 0.0) // 0.0 náº¿u lÃ  khÃ¡ch thÆ°á»ng
    â”‚                   .lastLoginAt(customer.getLastLoginAt())
    â”‚                   .totalSpent(customer.getTotalSpent())
    â”‚                   .lastOrderAt(customer.getLastOrderAt())
    â”‚                   .address(customer.getAddress())
    â”‚                   .notes(customer.getNotes())
    â”‚                   .segmentsJson(customer.getSegmentsJson())
    â”‚                   .isActive(customer.getIsActive())
    â”‚                   .createdAt(customer.getCreatedAt())
    â”‚                   .updatedAt(customer.getUpdatedAt())
    â”‚                   .build();
    â”‚       }
    â”‚   
    â”‚       @Transactional
    â”‚       public void addLoyaltyPoints(Integer customerId, BigDecimal orderTotal) {
    â”‚           Customer customer = customRes.findById(customerId)
    â”‚                   .orElseThrow(() -> new RuntimeException("KhÃ´ng tÃ¬m tháº¥y khÃ¡ch hÃ ng"));
    â”‚   
    â”‚           // LÆ°u tráº¡ng thÃ¡i trÆ°á»›c khi thay Ä‘á»•i
    â”‚           int pointsBefore = customer.getLoyaltyPoints() == null ? 0 : customer.getLoyaltyPoints();
    â”‚           VipTier tierBefore = customer.getVipTier();
    â”‚   
    â”‚           // 1. Quy Ä‘á»•i Ä‘iá»ƒm
    â”‚           int pointsEarned = orderTotal.divide(BigDecimal.valueOf(10000)).intValue();
    â”‚           if (pointsEarned <= 0) return;
    â”‚   
    â”‚           // 2. Cá»™ng Ä‘iá»ƒm
    â”‚           int newTotalPoints = pointsBefore + pointsEarned;
    â”‚           customer.setLoyaltyPoints(newTotalPoints);
    â”‚   
    â”‚           BigDecimal currentSpent = customer.getTotalSpent() == null ? BigDecimal.ZERO : customer.getTotalSpent();
    â”‚           customer.setTotalSpent(currentSpent.add(orderTotal));
    â”‚   
    â”‚           // 3. Cáº­p nháº­t háº¡ng
    â”‚           VipTier newTier = VipTier.fromPoints(newTotalPoints);
    â”‚           customer.setVipTier(newTier);
    â”‚   
    â”‚           if(newTier == null || newTier == VipTier.BRONZE || newTier == VipTier.SILVER) {
    â”‚               customer.setCustomerType(CustomerType.REGULAR);
    â”‚           } else {
    â”‚               customer.setCustomerType(CustomerType.VIP);
    â”‚           }
    â”‚   
    â”‚           customRes.save(customer);
    â”‚   
    â”‚           // âœ… 4. GHI Lá»ŠCH Sá»¬ Cá»˜NG ÄIá»‚M
    â”‚           saveLoyaltyLedger(
    â”‚                   customer,
    â”‚                   pointsEarned,
    â”‚                   "EARN",
    â”‚                   tierBefore,
    â”‚                   newTier,
    â”‚                   "PURCHASE",
    â”‚                   "Cá»™ng Ä‘iá»ƒm tá»« thanh toÃ¡n: " + formatMoney(orderTotal),
    â”‚                   "orders",
    â”‚                   null,
    â”‚                   null
    â”‚           );
    â”‚   
    â”‚           // âœ… 5. GHI Lá»ŠCH Sá»¬ THAY Äá»”I Háº NG (náº¿u cÃ³)
    â”‚           if (tierBefore != newTier) {
    â”‚               String transactionType = (newTier != null && (tierBefore == null ||
    â”‚                       newTier.ordinal() > tierBefore.ordinal())) ? "TIER_UPGRADE" : "TIER_DOWNGRADE";
    â”‚   
    â”‚               String note = String.format("ğŸ‰ ThÄƒng háº¡ng tá»« %s â†’ %s (Äiá»ƒm: %d)",
    â”‚                       tierBefore != null ? tierBefore.getDisplayName() : "Member",
    â”‚                       newTier != null ? newTier.getDisplayName() : "Member",
    â”‚                       newTotalPoints);
    â”‚   
    â”‚               saveLoyaltyLedger(
    â”‚                       customer,
    â”‚                       0, // KhÃ´ng thay Ä‘á»•i Ä‘iá»ƒm trong log nÃ y
    â”‚                       transactionType,
    â”‚                       tierBefore,
    â”‚                       newTier,
    â”‚                       "TIER_CHANGE",
    â”‚                       note,
    â”‚                       null,
    â”‚                       null,
    â”‚                       null
    â”‚               );
    â”‚           }
    â”‚       }
    â”‚   
    â”‚       public List<CustomerResponse> findAll() {
    â”‚           return customRes.findAll().stream().map(this::mapToResponse).collect(Collectors.toList());
    â”‚       }
    â”‚   
    â”‚       public List<CustomerResponse> findbyCustomerType(CustomerType type) {
    â”‚           return customRes.findByCustomerType(type).stream()
    â”‚                   .map(this::mapToResponse).collect(Collectors.toList());
    â”‚       }
    â”‚   
    â”‚       @Audit(
    â”‚               module = AuditModule.CUSTOMER,
    â”‚               action = AuditAction.DELETE,
    â”‚               targetType = TargetType.CUSTOMER
    â”‚       )
    â”‚       public void deleteById(int id) {
    â”‚           Customer customer = customRes.findById(id).orElseThrow();
    â”‚           customer.setIsActive(false);
    â”‚           customRes.save(customer);
    â”‚       }
    â”‚   
    â”‚       @Audit(
    â”‚               module = AuditModule.CUSTOMER,
    â”‚               action = AuditAction.UPDATE,
    â”‚               targetType = TargetType.CUSTOMER
    â”‚       )
    â”‚       public CustomerResponse updateById(Integer id, CustomerRequest customerRequest) {
    â”‚           Customer customer = customRes.findById(id)
    â”‚                   .orElseThrow(() -> new RuntimeException("KhÃ´ng tÃ¬m tháº¥y KhÃ¡ch hÃ ng vá»›i id: " + id));
    â”‚   
    â”‚           if (customerRequest.getFullName() != null) {
    â”‚               customer.setName(customerRequest.getFullName());
    â”‚           }
    â”‚   
    â”‚           String oldEmail = customer.getEmail();
    â”‚           if (customerRequest.getEmail() != null && !customerRequest.getEmail().equals(oldEmail)) {
    â”‚               if (customRes.findByEmail(customerRequest.getEmail()).isPresent()) {
    â”‚                   throw new RuntimeException("Email nÃ y Ä‘Ã£ tá»“n táº¡i trong há»‡ thá»‘ng");
    â”‚               }
    â”‚               customer.setEmail(customerRequest.getEmail());
    â”‚           }
    â”‚   
    â”‚           String oldPhone = customer.getPhone();
    â”‚           if (customerRequest.getPhone() != null && !customerRequest.getPhone().equals(oldPhone)) {
    â”‚               if (customRes.findByPhone(customerRequest.getPhone()).isPresent()) {
    â”‚                   throw new RuntimeException("Sá»‘ Ä‘iá»‡n thoáº¡i nÃ y Ä‘Ã£ tá»“n táº¡i trong há»‡ thá»‘ng");
    â”‚               }
    â”‚               customer.setPhone(customerRequest.getPhone());
    â”‚           }
    â”‚   
    â”‚           if (customerRequest.getBirthDate() != null) {
    â”‚               customer.setDateOfBirth(customerRequest.getBirthDate());
    â”‚           }
    â”‚           if (customerRequest.getAddress() != null) {
    â”‚               customer.setAddress(customerRequest.getAddress());
    â”‚           }
    â”‚           if (customerRequest.getNotes() != null) {
    â”‚               customer.setNotes(customerRequest.getNotes());
    â”‚           }
    â”‚   
    â”‚           Customer updated = customRes.save(customer);
    â”‚           return mapToResponse(updated);
    â”‚       }
    â”‚       // Trong CustomerService
    â”‚       public CustomerResponse findByEmail(String email) {
    â”‚           System.out.println("DEBUG Service: Äang tÃ¬m khÃ¡ch hÃ ng vá»›i email: " + email);
    â”‚   
    â”‚           Optional<Customer> customerOpt = customRes.findByEmail(email.trim());
    â”‚   
    â”‚           if (customerOpt.isEmpty()) {
    â”‚               System.out.println("DEBUG Service: KhÃ´ng tÃ¬m tháº¥y vá»›i email: " + email);
    â”‚               // Thá»­ tÃ¬m vá»›i username náº¿u email khÃ´ng tÃ¬m tháº¥y
    â”‚               customerOpt = customRes.findByName(email.trim());
    â”‚   
    â”‚               if (customerOpt.isEmpty()) {
    â”‚                   System.out.println("DEBUG Service: CÅ©ng khÃ´ng tÃ¬m tháº¥y vá»›i username: " + email);
    â”‚                   return null;
    â”‚               }
    â”‚           }
    â”‚   
    â”‚           Customer customer = customerOpt.get();
    â”‚           System.out.println("DEBUG Service: TÃ¬m tháº¥y khÃ¡ch hÃ ng: " + customer.getName() + ", email: " + customer.getEmail());
    â”‚   
    â”‚           return mapToResponse(customer);
    â”‚   
    â”‚       }
    â”‚   
    â”‚       public List<CustomerResponse> findActiveInLast30Days() {
    â”‚           LocalDateTime thirtyDaysAgo = LocalDateTime.now().minusDays(30);
    â”‚   
    â”‚           // âœ… DÃ¹ng method má»›i vá»›i last_login_at
    â”‚           List<Customer> activeCustomers = customRes.findActiveCustomersSince(thirtyDaysAgo);
    â”‚   
    â”‚           return activeCustomers.stream()
    â”‚                   .map(this::mapToResponse)
    â”‚                   .collect(Collectors.toList());
    â”‚       }
    â”‚       /**
    â”‚        * Trá»« Ä‘iá»ƒm loyalty khi há»§y Ä‘Æ¡n hoáº·c tráº£ hÃ ng
    â”‚        */
    â”‚       /**
    â”‚        * Trá»« Ä‘iá»ƒm loyalty khi há»§y Ä‘Æ¡n hoáº·c tráº£ hÃ ng
    â”‚        */
    â”‚       @Transactional
    â”‚       public void deductLoyaltyPoints(Integer customerId, BigDecimal orderTotal,
    â”‚                                       String reason, String referenceType, Long referenceId) {
    â”‚           Customer customer = customRes.findById(customerId)
    â”‚                   .orElseThrow(() -> new RuntimeException("KhÃ´ng tÃ¬m tháº¥y khÃ¡ch hÃ ng"));
    â”‚   
    â”‚           // LÆ°u tráº¡ng thÃ¡i trÆ°á»›c khi thay Ä‘á»•i
    â”‚           int pointsBefore = customer.getLoyaltyPoints() == null ? 0 : customer.getLoyaltyPoints();
    â”‚           VipTier tierBefore = customer.getVipTier();
    â”‚   
    â”‚           // 1. TÃ­nh Ä‘iá»ƒm bá»‹ trá»«
    â”‚           int pointsToDeduct = orderTotal.divide(BigDecimal.valueOf(10000)).intValue();
    â”‚           if (pointsToDeduct <= 0) return;
    â”‚   
    â”‚           // 2. Trá»« Ä‘iá»ƒm
    â”‚           int newTotalPoints = Math.max(0, pointsBefore - pointsToDeduct);
    â”‚           customer.setLoyaltyPoints(newTotalPoints);
    â”‚   
    â”‚           // 3. Trá»« tá»•ng chi tiÃªu (CHá»ˆ KHI KHÃ”NG PHáº¢I PENALTY)
    â”‚           if (!"CANCEL_PENALTY".equals(reason) && !"RETURN_PENALTY".equals(reason)) {
    â”‚               BigDecimal currentSpent = customer.getTotalSpent() == null ? BigDecimal.ZERO : customer.getTotalSpent();
    â”‚               BigDecimal newSpent = currentSpent.subtract(orderTotal);
    â”‚               customer.setTotalSpent(newSpent.compareTo(BigDecimal.ZERO) < 0 ? BigDecimal.ZERO : newSpent);
    â”‚           }
    â”‚   
    â”‚           // 4. Cáº­p nháº­t háº¡ng
    â”‚           VipTier newTier = VipTier.fromPoints(newTotalPoints);
    â”‚           customer.setVipTier(newTier);
    â”‚   
    â”‚           if(newTier == null || newTier == VipTier.BRONZE || newTier == VipTier.SILVER) {
    â”‚               customer.setCustomerType(CustomerType.REGULAR);
    â”‚           } else {
    â”‚               customer.setCustomerType(CustomerType.VIP);
    â”‚           }
    â”‚   
    â”‚           customRes.save(customer);
    â”‚   
    â”‚           // âœ… 5. GHI Lá»ŠCH Sá»¬ TRá»ª ÄIá»‚M
    â”‚           String transactionType = "CANCEL_PENALTY".equals(reason) ? "PENALTY" : "DEDUCT";
    â”‚           String note = getDeductNote(reason, orderTotal);
    â”‚   
    â”‚           saveLoyaltyLedger(
    â”‚                   customer,
    â”‚                   -pointsToDeduct,
    â”‚                   transactionType,
    â”‚                   tierBefore,
    â”‚                   newTier,
    â”‚                   reason,
    â”‚                   note,
    â”‚                   referenceType,
    â”‚                   referenceId,
    â”‚                   null
    â”‚           );
    â”‚   
    â”‚           // âœ… 6. GHI Lá»ŠCH Sá»¬ Háº  Háº NG (náº¿u cÃ³)
    â”‚           if (tierBefore != newTier) {
    â”‚               String note2 = String.format("âš ï¸ Háº¡ háº¡ng tá»« %s â†’ %s do trá»« Ä‘iá»ƒm (Äiá»ƒm cÃ²n: %d)",
    â”‚                       tierBefore != null ? tierBefore.getDisplayName() : "Member",
    â”‚                       newTier != null ? newTier.getDisplayName() : "Member",
    â”‚                       newTotalPoints);
    â”‚   
    â”‚               saveLoyaltyLedger(
    â”‚                       customer,
    â”‚                       0,
    â”‚                       "TIER_DOWNGRADE",
    â”‚                       tierBefore,
    â”‚                       newTier,
    â”‚                       "TIER_CHANGE",
    â”‚                       note2,
    â”‚                       null,
    â”‚                       null,
    â”‚                       null
    â”‚               );
    â”‚           }
    â”‚       }
    â”‚   
    â”‚   }
    â”œâ”€â”€ PricingService.java
    â”‚   package com.retailmanagement.service;
    â”‚   
    â”‚   import com.retailmanagement.dto.request.UpsertPriceRequest;
    â”‚   import com.retailmanagement.dto.response.VariantPriceResponse;
    â”‚   import com.retailmanagement.entity.PriceHistory;
    â”‚   import com.retailmanagement.entity.ProductVariant;
    â”‚   import com.retailmanagement.entity.Promotion;
    â”‚   import com.retailmanagement.entity.User;
    â”‚   import com.retailmanagement.repository.PriceHistoryRepository;
    â”‚   import com.retailmanagement.repository.ProductVariantRepository;
    â”‚   import com.retailmanagement.repository.UserRepository;
    â”‚   import org.springframework.stereotype.Service;
    â”‚   import org.springframework.transaction.annotation.Transactional;
    â”‚   
    â”‚   import java.math.BigDecimal;
    â”‚   import java.math.RoundingMode;
    â”‚   import java.time.Instant;
    â”‚   import java.time.LocalDateTime;
    â”‚   import java.util.List;
    â”‚   import java.util.NoSuchElementException;
    â”‚   
    â”‚   @Service
    â”‚   public class PricingService {
    â”‚   
    â”‚       private final ProductVariantRepository variantRepo;
    â”‚       private final PriceHistoryRepository priceHistoryRepo;
    â”‚       private final SettingService settingService;
    â”‚       private final PromotionService promotionService;
    â”‚       private final UserRepository userRepository;
    â”‚   
    â”‚       public PricingService(ProductVariantRepository variantRepo,
    â”‚                             PriceHistoryRepository priceHistoryRepo,
    â”‚                             SettingService settingService,
    â”‚                             PromotionService promotionService,
    â”‚                             UserRepository userRepository) {
    â”‚           this.variantRepo = variantRepo;
    â”‚           this.priceHistoryRepo = priceHistoryRepo;
    â”‚           this.settingService = settingService;
    â”‚           this.promotionService = promotionService;
    â”‚           this.userRepository = userRepository;
    â”‚       }
    â”‚   
    â”‚       @Transactional
    â”‚       public PriceHistory setVariantPrice(Integer variantId, UpsertPriceRequest req, Integer userId) {
    â”‚           ProductVariant v = variantRepo.findById(variantId)
    â”‚                   .orElseThrow(() -> new NoSuchElementException("Variant not found"));
    â”‚   
    â”‚           if (req == null) throw new IllegalArgumentException("Body rá»—ng");
    â”‚           if (req.getPrice() == null || req.getPrice().compareTo(BigDecimal.ZERO) < 0) {
    â”‚               throw new IllegalArgumentException("price pháº£i >= 0");
    â”‚           }
    â”‚           if (req.getCostPrice() != null && req.getCostPrice().compareTo(BigDecimal.ZERO) < 0) {
    â”‚               throw new IllegalArgumentException("costPrice pháº£i >= 0");
    â”‚           }
    â”‚   
    â”‚           User user = null;
    â”‚           if (userId != null && userId > 0) {
    â”‚               user = userRepository.findById(userId).orElse(null);
    â”‚           }
    â”‚   
    â”‚           String currency = (req.getCurrencyCode() == null || req.getCurrencyCode().isBlank())
    â”‚                   ? settingService.getDefaultCurrency()
    â”‚                   : req.getCurrencyCode().trim().toUpperCase();
    â”‚   
    â”‚           Instant now = Instant.now();
    â”‚   
    â”‚           priceHistoryRepo.findFirstByVariant_IdAndEffectiveToIsNullOrderByEffectiveFromDesc(variantId)
    â”‚                   .ifPresent(cur -> {
    â”‚                       cur.setEffectiveTo(now);
    â”‚                       priceHistoryRepo.save(cur);
    â”‚                   });
    â”‚   
    â”‚           PriceHistory ph = new PriceHistory();
    â”‚           ph.setVariant(v);
    â”‚           ph.setCurrencyCode(currency);
    â”‚           ph.setPrice(scaleMoney(req.getPrice()));
    â”‚           ph.setCostPrice(req.getCostPrice() == null ? null : scaleMoney(req.getCostPrice()));
    â”‚           ph.setReason(req.getReason() == null || req.getReason().isBlank() ? "MANUAL" : req.getReason().trim());
    â”‚           ph.setEffectiveFrom(now);
    â”‚           ph.setEffectiveTo(null);
    â”‚           ph.setCreatedBy(user);
    â”‚           ph.setCreatedAt(now);
    â”‚           priceHistoryRepo.save(ph);
    â”‚   
    â”‚           v.setCurrencyCode(currency);
    â”‚           v.setPrice(scaleMoney(req.getPrice()));
    â”‚           v.setCostPrice(req.getCostPrice() == null ? null : scaleMoney(req.getCostPrice()));
    â”‚           v.setUpdatedAt(now);
    â”‚           variantRepo.save(v);
    â”‚   
    â”‚           return ph;
    â”‚       }
    â”‚   
    â”‚       public List<VariantPriceResponse> listCurrentPricesByProduct(Integer productId) {
    â”‚           List<ProductVariant> variants = variantRepo.findByProduct_Id(productId);
    â”‚           LocalDateTime now = LocalDateTime.now();
    â”‚   
    â”‚           return variants.stream().map(v -> {
    â”‚               VariantPriceResponse r = new VariantPriceResponse();
    â”‚               r.setVariantId(v.getId());
    â”‚               r.setProductId(v.getProduct().getId());
    â”‚               r.setVariantName(v.getVariantName());
    â”‚               r.setSku(v.getSku());
    â”‚               r.setCurrencyCode(v.getCurrencyCode());
    â”‚               r.setPrice(v.getPrice());
    â”‚               r.setCostPrice(v.getCostPrice());
    â”‚   
    â”‚               Promotion best = promotionService.findBestPromotionForVariant(v, now);
    â”‚               if (best != null) {
    â”‚                   r.setPromotionCode(best.getCode());
    â”‚                   r.setFinalPrice(promotionService.computeEffectiveUnitPrice(v.getPrice(), best));
    â”‚               } else {
    â”‚                   r.setFinalPrice(v.getPrice());
    â”‚               }
    â”‚               return r;
    â”‚           }).toList();
    â”‚       }
    â”‚   
    â”‚       @Transactional
    â”‚       public PriceHistory updateLatestHistory(Long priceHistoryId, UpsertPriceRequest req) {
    â”‚           PriceHistory ph = priceHistoryRepo.findById(priceHistoryId)
    â”‚                   .orElseThrow(() -> new NoSuchElementException("Price history not found"));
    â”‚   
    â”‚           if (ph.getEffectiveTo() != null) {
    â”‚               throw new IllegalArgumentException("Chá»‰ Ä‘Æ°á»£c sá»­a báº£n ghi giÃ¡ hiá»‡n táº¡i (effective_to = null)");
    â”‚           }
    â”‚   
    â”‚           if (req == null) throw new IllegalArgumentException("Body rá»—ng");
    â”‚           if (req.getPrice() == null || req.getPrice().compareTo(BigDecimal.ZERO) < 0) {
    â”‚               throw new IllegalArgumentException("price pháº£i >= 0");
    â”‚           }
    â”‚           if (req.getCostPrice() != null && req.getCostPrice().compareTo(BigDecimal.ZERO) < 0) {
    â”‚               throw new IllegalArgumentException("costPrice pháº£i >= 0");
    â”‚           }
    â”‚   
    â”‚           String currency = (req.getCurrencyCode() == null || req.getCurrencyCode().isBlank())
    â”‚                   ? ph.getCurrencyCode()
    â”‚                   : req.getCurrencyCode().trim().toUpperCase();
    â”‚   
    â”‚           ph.setCurrencyCode(currency);
    â”‚           ph.setPrice(scaleMoney(req.getPrice()));
    â”‚           ph.setCostPrice(req.getCostPrice() == null ? null : scaleMoney(req.getCostPrice()));
    â”‚           if (req.getReason() != null && !req.getReason().isBlank()) ph.setReason(req.getReason().trim());
    â”‚           priceHistoryRepo.save(ph);
    â”‚   
    â”‚           ProductVariant v = ph.getVariant();
    â”‚           v.setCurrencyCode(currency);
    â”‚           v.setPrice(scaleMoney(req.getPrice()));
    â”‚           v.setCostPrice(req.getCostPrice() == null ? null : scaleMoney(req.getCostPrice()));
    â”‚           v.setUpdatedAt(Instant.now());
    â”‚           variantRepo.save(v);
    â”‚   
    â”‚           return ph;
    â”‚       }
    â”‚   
    â”‚       @Transactional
    â”‚       public void deleteLatestAndRollback(Long priceHistoryId) {
    â”‚           PriceHistory current = priceHistoryRepo.findById(priceHistoryId)
    â”‚                   .orElseThrow(() -> new NoSuchElementException("Price history not found"));
    â”‚   
    â”‚           if (current.getEffectiveTo() != null) {
    â”‚               throw new IllegalArgumentException("Chá»‰ Ä‘Æ°á»£c xÃ³a báº£n ghi giÃ¡ hiá»‡n táº¡i (effective_to = null)");
    â”‚           }
    â”‚   
    â”‚           Integer variantId = current.getVariant().getId();
    â”‚           priceHistoryRepo.delete(current);
    â”‚   
    â”‚           List<PriceHistory> histories = priceHistoryRepo.findByVariant_IdOrderByEffectiveFromDesc(variantId);
    â”‚   
    â”‚           ProductVariant v = variantRepo.findById(variantId)
    â”‚                   .orElseThrow(() -> new NoSuchElementException("Variant not found"));
    â”‚   
    â”‚           if (histories.isEmpty()) {
    â”‚               String currency = settingService.getDefaultCurrency();
    â”‚               v.setCurrencyCode(currency);
    â”‚               v.setPrice(BigDecimal.ZERO.setScale(2, RoundingMode.HALF_UP));
    â”‚               v.setCostPrice(null);
    â”‚               v.setUpdatedAt(Instant.now());
    â”‚               variantRepo.save(v);
    â”‚               return;
    â”‚           }
    â”‚   
    â”‚           PriceHistory latest = histories.get(0);
    â”‚           latest.setEffectiveTo(null);
    â”‚           priceHistoryRepo.save(latest);
    â”‚   
    â”‚           v.setCurrencyCode(latest.getCurrencyCode());
    â”‚           v.setPrice(scaleMoney(latest.getPrice()));
    â”‚           v.setCostPrice(latest.getCostPrice() == null ? null : scaleMoney(latest.getCostPrice()));
    â”‚           v.setUpdatedAt(Instant.now());
    â”‚           variantRepo.save(v);
    â”‚       }
    â”‚   
    â”‚       public VariantPriceResponse getEffectivePrice(Integer variantId) {
    â”‚           ProductVariant v = variantRepo.findById(variantId)
    â”‚                   .orElseThrow(() -> new NoSuchElementException("Variant not found"));
    â”‚   
    â”‚           LocalDateTime now = LocalDateTime.now();
    â”‚           Promotion best = promotionService.findBestPromotionForVariant(v, now);
    â”‚   
    â”‚           VariantPriceResponse r = new VariantPriceResponse();
    â”‚           r.setVariantId(v.getId());
    â”‚           r.setProductId(v.getProduct().getId());
    â”‚           r.setVariantName(v.getVariantName());
    â”‚           r.setSku(v.getSku());
    â”‚           r.setCurrencyCode(v.getCurrencyCode());
    â”‚           r.setPrice(v.getPrice());
    â”‚           r.setCostPrice(v.getCostPrice());
    â”‚   
    â”‚           if (best != null) {
    â”‚               r.setPromotionCode(best.getCode());
    â”‚               r.setFinalPrice(promotionService.computeEffectiveUnitPrice(v.getPrice(), best));
    â”‚           } else {
    â”‚               r.setFinalPrice(v.getPrice());
    â”‚           }
    â”‚           return r;
    â”‚       }
    â”‚   
    â”‚       private static BigDecimal scaleMoney(BigDecimal v) {
    â”‚           if (v == null) return null;
    â”‚           return v.setScale(2, RoundingMode.HALF_UP);
    â”‚       }
    â”‚   }
    â”œâ”€â”€ ProductService.java
    â”‚   package com.retailmanagement.service;
    â”‚   
    â”‚   import com.fasterxml.jackson.core.type.TypeReference;
    â”‚   import com.fasterxml.jackson.databind.ObjectMapper;
    â”‚   import com.retailmanagement.dto.request.AttributeRequest;
    â”‚   import com.retailmanagement.dto.request.ProductRequest;
    â”‚   import com.retailmanagement.dto.response.ProductResponse;
    â”‚   import com.retailmanagement.entity.*;
    â”‚   import com.retailmanagement.repository.*;
    â”‚   import lombok.RequiredArgsConstructor;
    â”‚   import org.springframework.data.domain.*;
    â”‚   import org.springframework.stereotype.Service;
    â”‚   import org.springframework.transaction.annotation.Transactional;
    â”‚   import org.springframework.web.multipart.MultipartFile;
    â”‚   
    â”‚   import java.io.IOException;
    â”‚   import java.nio.file.*;
    â”‚   import java.time.Instant;
    â”‚   import java.time.LocalDateTime;
    â”‚   import java.util.List;
    â”‚   import java.util.UUID;
    â”‚   
    â”‚   @Service
    â”‚   @RequiredArgsConstructor
    â”‚   public class ProductService {
    â”‚   
    â”‚       private final ProductRepository productRepository;
    â”‚       private final CategoryRepository categoryRepository;
    â”‚       private final ImageRepository imageRepository;
    â”‚       private final ProductCategoryRepository productCategoryRepository;
    â”‚       private final ProductVariantRepository productVariantRepository;
    â”‚       private final ObjectMapper objectMapper = new ObjectMapper();
    â”‚   
    â”‚       private final String UPLOAD_DIR = "uploads/";
    â”‚   
    â”‚       @Transactional
    â”‚       public void createProduct(ProductRequest request) throws IOException {
    â”‚           Product product = new Product();
    â”‚   
    â”‚           // 1. Xá»­ lÃ½ thÃ´ng tin cÆ¡ báº£n
    â”‚           product.setName(request.getName().trim());
    â”‚           product.setSku(request.getSku().trim().toUpperCase());
    â”‚           product.setIsVisible(request.getIsVisible() != null ? request.getIsVisible() : true);
    â”‚           product.setCreatedAt(LocalDateTime.now());
    â”‚           product.setUpdatedAt(LocalDateTime.now());
    â”‚   
    â”‚           // 2. Xá»­ lÃ½ thuá»™c tÃ­nh: Gá»™p vÃ o Description
    â”‚           String finalDescription = request.getDescription();
    â”‚   
    â”‚           // Kiá»ƒm tra náº¿u attributes khÃ´ng null vÃ  khÃ´ng rá»—ng
    â”‚           if (request.getAttributes() != null && !request.getAttributes().isEmpty()) {
    â”‚               try {
    â”‚                   // 1. DÃ¹ng Jackson dá»‹ch chuá»—i JSON sang List
    â”‚                   List<AttributeRequest> attrList = objectMapper.readValue(
    â”‚                           request.getAttributes(),
    â”‚                           new TypeReference<List<AttributeRequest>>(){}
    â”‚                   );
    â”‚   
    â”‚                   // 2. Ná»‘i chuá»—i vÃ o Description
    â”‚                   StringBuilder attrStr = new StringBuilder();
    â”‚                   attrStr.append("\n\n--- THÃ”NG Sá» Ká»¸ THUáº¬T ---\n");
    â”‚                   for (AttributeRequest attr : attrList) {
    â”‚                       attrStr.append("- ").append(attr.getName())
    â”‚                               .append(": ").append(attr.getValue()).append("\n");
    â”‚                   }
    â”‚                   finalDescription += attrStr.toString();
    â”‚   
    â”‚               } catch (Exception e) {
    â”‚                   // Náº¿u JSON sai Ä‘á»‹nh dáº¡ng, chá»‰ in log vÃ  bá» qua, khÃ´ng lÃ m crash chÆ°Æ¡ng trÃ¬nh
    â”‚                   System.err.println("Lá»—i parse attributes JSON: " + e.getMessage());
    â”‚               }
    â”‚           }
    â”‚           product.setDescription(finalDescription);
    â”‚   
    â”‚           product.setAttributesJson(request.getAttributes());
    â”‚   
    â”‚           Product savedProduct = productRepository.save(product);
    â”‚   
    â”‚           if (request.getCategoryIds() != null) {
    â”‚               for (Integer catId : request.getCategoryIds()) {
    â”‚                   ProductCategory pc = new ProductCategory();
    â”‚                   ProductCategoryId pcId = new ProductCategoryId(savedProduct.getId(), catId);
    â”‚                   pc.setId(pcId);
    â”‚                   pc.setCategory(categoryRepository.getReferenceById(catId));
    â”‚                   pc.setIsPrimary(false);
    â”‚                   pc.setCreatedAt(Instant.now());
    â”‚                   productCategoryRepository.save(pc);
    â”‚               }
    â”‚           }
    â”‚   
    â”‚           if (request.getGalleryImages() != null) {
    â”‚               int sortOrder = 0;
    â”‚               for (MultipartFile file : request.getGalleryImages()) {
    â”‚                   if (!file.isEmpty()) {
    â”‚                       String fileName = saveFileToDisk(file);
    â”‚                       Image image = new Image();
    â”‚                       image.setProduct(savedProduct);
    â”‚                       image.setUrl("/uploads/" + fileName);
    â”‚                       image.setIsPrimary(sortOrder == 0);
    â”‚                       image.setSortOrder(sortOrder++);
    â”‚                       image.setCreatedAt(Instant.now());
    â”‚                       imageRepository.save(image);
    â”‚                   }
    â”‚               }
    â”‚           }
    â”‚   
    â”‚   
    â”‚       }
    â”‚   
    â”‚       @Transactional
    â”‚       public void updateProduct(Integer id, ProductRequest request) throws IOException {
    â”‚           Product product = productRepository.findById(id)
    â”‚                   .orElseThrow(() -> new RuntimeException("Product not found"));
    â”‚   
    â”‚           product.setName(request.getName());
    â”‚           product.setSku(request.getSku());
    â”‚           product.setUpdatedAt(LocalDateTime.now());
    â”‚   
    â”‚           // Update Description kÃ¨m thuá»™c tÃ­nh má»›i
    â”‚           String finalDescription = request.getDescription();
    â”‚   
    â”‚           // Kiá»ƒm tra náº¿u attributes khÃ´ng null vÃ  khÃ´ng rá»—ng
    â”‚           if (request.getAttributes() != null && !request.getAttributes().isEmpty()) {
    â”‚               try {
    â”‚                   // 1. DÃ¹ng Jackson dá»‹ch chuá»—i JSON sang List
    â”‚                   List<AttributeRequest> attrList = objectMapper.readValue(
    â”‚                           request.getAttributes(),
    â”‚                           new TypeReference<List<AttributeRequest>>(){}
    â”‚                   );
    â”‚   
    â”‚                   // 2. Ná»‘i chuá»—i vÃ o Description
    â”‚                   StringBuilder attrStr = new StringBuilder();
    â”‚                   attrStr.append("\n\n--- THÃ”NG Sá» Ká»¸ THUáº¬T ---\n");
    â”‚                   for (AttributeRequest attr : attrList) {
    â”‚                       attrStr.append("- ").append(attr.getName())
    â”‚                               .append(": ").append(attr.getValue()).append("\n");
    â”‚                   }
    â”‚                   finalDescription += attrStr.toString();
    â”‚   
    â”‚               } catch (Exception e) {
    â”‚                   // Náº¿u JSON sai Ä‘á»‹nh dáº¡ng, chá»‰ in log vÃ  bá» qua, khÃ´ng lÃ m crash chÆ°Æ¡ng trÃ¬nh
    â”‚                   System.err.println("Lá»—i parse attributes JSON: " + e.getMessage());
    â”‚               }
    â”‚           }
    â”‚           product.setDescription(finalDescription);
    â”‚           product.setAttributesJson(request.getAttributes());
    â”‚   
    â”‚           if (request.getIdsToDelete() != null && !request.getIdsToDelete().isEmpty()) {
    â”‚               imageRepository.deleteAllById(request.getIdsToDelete());
    â”‚           }
    â”‚   
    â”‚           if (request.getGalleryImages() != null) {
    â”‚               for (MultipartFile file : request.getGalleryImages()) {
    â”‚                   if (!file.isEmpty()) {
    â”‚                       String fileName = saveFileToDisk(file);
    â”‚                       Image image = new Image();
    â”‚                       image.setProduct(product);
    â”‚                       image.setUrl("/uploads/" + fileName);
    â”‚                       image.setIsPrimary(false);
    â”‚                       image.setSortOrder(1);
    â”‚                       image.setCreatedAt(Instant.now());
    â”‚                       imageRepository.save(image);
    â”‚                   }
    â”‚               }
    â”‚           }
    â”‚           productRepository.save(product);
    â”‚       }
    â”‚   
    â”‚       public Page<ProductResponse> getProducts(int page, Integer categoryId, String keyword, String sortBy) {
    â”‚           String sortColumn = "created_at";
    â”‚           Sort.Direction direction = Sort.Direction.DESC;
    â”‚   
    â”‚           if (sortBy != null) {
    â”‚               if (sortBy.contains("name")) sortColumn = "name";
    â”‚               if (sortBy.contains("asc")) direction = Sort.Direction.ASC;
    â”‚               if ("oldest".equals(sortBy)) {
    â”‚                   sortColumn = "created_at";
    â”‚                   direction = Sort.Direction.ASC;
    â”‚               }
    â”‚           }
    â”‚   
    â”‚           Pageable pageable = PageRequest.of(page, 20, Sort.by(direction, sortColumn));
    â”‚   
    â”‚           if (keyword != null && !keyword.isEmpty()) {
    â”‚               return productRepository.searchProducts(keyword, true, pageable).map(this::mapToResponse);
    â”‚           }
    â”‚           if (categoryId != null) {
    â”‚               return productRepository.findByCategoryId(categoryId, pageable).map(this::mapToResponse);
    â”‚           }
    â”‚           return productRepository.searchProducts(null, true, pageable).map(this::mapToResponse);
    â”‚       }
    â”‚   
    â”‚       //CHI TIáº¾T Sáº¢N PHáº¨M
    â”‚       public ProductResponse getProductById(Integer id) {
    â”‚           Product product = productRepository.findById(id)
    â”‚                   .orElseThrow(() -> new RuntimeException("KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m vá»›i ID: " + id));
    â”‚           return mapToResponse(product);
    â”‚       }
    â”‚   
    â”‚       //XÃ“A Má»€M (SOFT DELETE)
    â”‚       @Transactional
    â”‚       public void softDeleteProduct(Integer id) {
    â”‚           Product product = productRepository.findById(id)
    â”‚                   .orElseThrow(() -> new RuntimeException("KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m"));
    â”‚           product.setIsVisible(false);
    â”‚           productRepository.save(product);
    â”‚       }
    â”‚   
    â”‚       private ProductResponse mapToResponse(Product product) {
    â”‚           ProductResponse dto = new ProductResponse();
    â”‚           dto.setId(product.getId());
    â”‚           dto.setName(product.getName());
    â”‚           dto.setSku(product.getSku());
    â”‚           dto.setDescription(product.getDescription()); // Description nÃ y Ä‘Ã£ chá»©a cáº£ thuá»™c tÃ­nh
    â”‚           dto.setIsVisible(product.getIsVisible());
    â”‚           dto.setCreatedAt(product.getCreatedAt());
    â”‚   
    â”‚           dto.setAttributes(product.getAttributesJson());
    â”‚   
    â”‚           imageRepository.findFirstByProductIdAndIsPrimaryTrue(product.getId())
    â”‚                   .ifPresent(img -> dto.setImageUrl(img.getUrl()));
    â”‚   
    â”‚           productVariantRepository.findByProduct_Id(product.getId()).stream()
    â”‚                   .filter(v -> v.getPrice() != null)
    â”‚                   .min((v1, v2) -> v1.getPrice().compareTo(v2.getPrice()))
    â”‚                   .ifPresent(v -> {
    â”‚                       dto.setMinPrice(v.getPrice());        // âœ… FIX
    â”‚                       dto.setCurrencyCode(v.getCurrencyCode()); // âœ… FIX
    â”‚                       dto.setVariantId(v.getId());          // âœ… FIX (QUAN TRá»ŒNG NHáº¤T)
    â”‚                   });
    â”‚   
    â”‚           productCategoryRepository
    â”‚                   .findFirstById_ProductIdAndIsPrimaryTrue(product.getId())
    â”‚                   .ifPresent(pc -> dto.setCategoryId(
    â”‚                           pc.getCategory().getId()
    â”‚                   ));
    â”‚   
    â”‚           return dto;
    â”‚       }
    â”‚   
    â”‚       private String saveFileToDisk(MultipartFile file) throws IOException {
    â”‚           Path uploadPath = Paths.get(UPLOAD_DIR);
    â”‚           if (!Files.exists(uploadPath)) Files.createDirectories(uploadPath);
    â”‚           String fileName = UUID.randomUUID().toString() + "_" + file.getOriginalFilename();
    â”‚           Files.copy(file.getInputStream(), uploadPath.resolve(fileName), StandardCopyOption.REPLACE_EXISTING);
    â”‚           return fileName;
    â”‚       }
    â”‚   }
    â””â”€â”€ PromotionService.java
        package com.retailmanagement.service;
        
        import com.fasterxml.jackson.databind.ObjectMapper;
        import com.retailmanagement.dto.request.PromotionRequest;
        import com.retailmanagement.entity.ProductVariant;
        import com.retailmanagement.entity.Promotion;
        import com.retailmanagement.entity.PromotionRedemption;
        import com.retailmanagement.repository.ProductVariantRepository;
        import com.retailmanagement.repository.PromotionRedemptionRepository;
        import com.retailmanagement.repository.PromotionRepository;
        import org.springframework.stereotype.Service;
        import org.springframework.transaction.annotation.Transactional;
        
        import java.math.BigDecimal;
        import java.math.RoundingMode;
        import java.time.LocalDateTime;
        import java.util.*;
        import java.util.stream.Collectors;
        
        @Service
        public class PromotionService {
        
            private final PromotionRepository promoRepo;
            private final ProductVariantRepository variantRepo;
            private final PromotionRedemptionRepository redemptionRepo;
            private final ObjectMapper objectMapper = new ObjectMapper();
        
            public PromotionService(PromotionRepository promoRepo,
                                    ProductVariantRepository variantRepo,
                                    PromotionRedemptionRepository redemptionRepo) {
                this.promoRepo = promoRepo;
                this.variantRepo = variantRepo;
                this.redemptionRepo = redemptionRepo;
            }
        
            // =========================
            // JSON models
            // =========================
            // applicabilityJson: {"scope":"ALL"} or {"product_ids":[1,2]} or {"variant_ids":[10,11]}
            public static class Applicability {
                public String scope;
                public List<Integer> product_ids;
                public List<Integer> variant_ids;
            }
        
            // rulesJson: {"usage_limit":100,"combo":{"buy_qty":2,"get_qty":1}}
            public static class Rules {
                public Integer usage_limit;
                public Combo combo;
            }
        
            public static class Combo {
                public Integer buy_qty;
                public Integer get_qty;
            }
        
            private String buildApplicabilityJson(PromotionRequest req) {
                try {
                    Applicability a = new Applicability();
                    String scope = (req.getScope() == null) ? "ALL" : req.getScope().trim().toUpperCase();
                    a.scope = scope;
                    a.product_ids = req.getProductIds();
                    a.variant_ids = req.getVariantIds();
                    return objectMapper.writeValueAsString(a);
                } catch (Exception e) {
                    throw new IllegalArgumentException("applicabilityJson khÃ´ng há»£p lá»‡");
                }
            }
        
            private Applicability parseApplicability(String json) {
                try {
                    if (json == null || json.isBlank()) {
                        Applicability a = new Applicability();
                        a.scope = "ALL";
                        return a;
                    }
                    return objectMapper.readValue(json, Applicability.class);
                } catch (Exception e) {
                    Applicability a = new Applicability();
                    a.scope = "ALL";
                    return a;
                }
            }
        
            private String buildRulesJson(PromotionRequest req) {
                try {
                    Rules r = new Rules();
        
                    if (req.getUsageLimit() != null) {
                        if (req.getUsageLimit() <= 0) throw new IllegalArgumentException("usageLimit pháº£i > 0 hoáº·c null");
                        r.usage_limit = req.getUsageLimit();
                    }
        
                    Integer buy = req.getBuyQty();
                    Integer get = req.getGetQty();
                    boolean hasCombo = buy != null || get != null;
                    if (hasCombo) {
                        if (buy == null || get == null) throw new IllegalArgumentException("combo buyQty/getQty pháº£i Ä‘á»§");
                        if (buy <= 0 || get <= 0) throw new IllegalArgumentException("combo buyQty/getQty pháº£i > 0");
                        Combo c = new Combo();
                        c.buy_qty = buy;
                        c.get_qty = get;
                        r.combo = c;
                    }
        
                    // náº¿u r rá»—ng -> tráº£ null Ä‘á»ƒ DB gá»n
                    if (r.usage_limit == null && r.combo == null) return null;
                    return objectMapper.writeValueAsString(r);
                } catch (IllegalArgumentException ex) {
                    throw ex;
                } catch (Exception e) {
                    throw new IllegalArgumentException("rulesJson khÃ´ng há»£p lá»‡");
                }
            }
        
            private Rules parseRules(String json) {
                try {
                    if (json == null || json.isBlank()) return new Rules();
                    return objectMapper.readValue(json, Rules.class);
                } catch (Exception e) {
                    return new Rules();
                }
            }
        
            // =========================
            // Duplicate/overlap checks
            // =========================
            private boolean dateOverlap(LocalDateTime s1, LocalDateTime e1, LocalDateTime s2, LocalDateTime e2) {
                return !s1.isAfter(e2) && !e1.isBefore(s2);
            }
        
            private boolean applicabilityOverlap(Applicability a, Applicability b) {
                String sa = (a.scope == null) ? "ALL" : a.scope.toUpperCase();
                String sb = (b.scope == null) ? "ALL" : b.scope.toUpperCase();
                if ("ALL".equals(sa) || "ALL".equals(sb)) return true;
        
                Set<Integer> aProducts = a.product_ids == null ? Set.of() : new HashSet<>(a.product_ids);
                Set<Integer> bProducts = b.product_ids == null ? Set.of() : new HashSet<>(b.product_ids);
        
                Set<Integer> aVariants = a.variant_ids == null ? Set.of() : new HashSet<>(a.variant_ids);
                Set<Integer> bVariants = b.variant_ids == null ? Set.of() : new HashSet<>(b.variant_ids);
        
                if (!aProducts.isEmpty() && !bProducts.isEmpty()) {
                    return !Collections.disjoint(aProducts, bProducts);
                }
        
                if (!aVariants.isEmpty() && !bVariants.isEmpty()) {
                    return !Collections.disjoint(aVariants, bVariants);
                }
        
                // PRODUCT vs VARIANT => map variant->product
                if (!aProducts.isEmpty() && !bVariants.isEmpty()) {
                    List<ProductVariant> vs = variantRepo.findAllById(bVariants);
                    Set<Integer> bVariantProducts = vs.stream().map(v -> v.getProduct().getId()).collect(Collectors.toSet());
                    return !Collections.disjoint(aProducts, bVariantProducts);
                }
        
                if (!bProducts.isEmpty() && !aVariants.isEmpty()) {
                    List<ProductVariant> vs = variantRepo.findAllById(aVariants);
                    Set<Integer> aVariantProducts = vs.stream().map(v -> v.getProduct().getId()).collect(Collectors.toSet());
                    return !Collections.disjoint(bProducts, aVariantProducts);
                }
        
                return false;
            }
        
            private void assertNoDuplicatePromotion(Promotion draft, Integer ignoreId) {
                LocalDateTime s = draft.getStartDate();
                LocalDateTime e = draft.getEndDate();
        
                List<Promotion> candidates = (ignoreId == null)
                        ? promoRepo.findByIsActiveTrueAndStartDateLessThanEqualAndEndDateGreaterThanEqual(e, s)
                        : promoRepo.findByIsActiveTrueAndStartDateLessThanEqualAndEndDateGreaterThanEqualAndIdNot(e, s, ignoreId);
        
                Applicability newApp = parseApplicability(draft.getApplicabilityJson());
        
                List<String> conflicts = new ArrayList<>();
                for (Promotion p : candidates) {
                    if (!dateOverlap(p.getStartDate(), p.getEndDate(), s, e)) continue;
        
                    Applicability oldApp = parseApplicability(p.getApplicabilityJson());
                    if (applicabilityOverlap(newApp, oldApp)) conflicts.add(p.getCode());
                }
        
                if (!conflicts.isEmpty()) {
                    throw new IllegalArgumentException("TrÃ¹ng khuyáº¿n mÃ£i theo thá»i gian/pháº¡m vi vá»›i: " + String.join(", ", conflicts));
                }
            }
        
            // =========================
            // CRUD
            // =========================
            @Transactional
            public Promotion create(PromotionRequest req, Integer createdBy) {
                if (req == null) throw new IllegalArgumentException("Body rá»—ng");
                if (req.getCode() == null || req.getCode().isBlank()) throw new IllegalArgumentException("code khÃ´ng Ä‘Æ°á»£c rá»—ng");
                if (req.getName() == null || req.getName().isBlank()) throw new IllegalArgumentException("name khÃ´ng Ä‘Æ°á»£c rá»—ng");
                if (req.getStartDate() == null || req.getEndDate() == null) throw new IllegalArgumentException("startDate/endDate báº¯t buá»™c");
                if (!req.getStartDate().isBefore(req.getEndDate())) throw new IllegalArgumentException("startDate pháº£i < endDate");
        
                String code = req.getCode().trim().toUpperCase();
                promoRepo.findByCode(code).ifPresent(x -> { throw new IllegalArgumentException("Promo code Ä‘Ã£ tá»“n táº¡i"); });
        
                String discountType = req.getDiscountType() == null ? "PERCENT" : req.getDiscountType().trim().toUpperCase();
                BigDecimal discountValue = req.getDiscountValue();
        
                String rulesJson = buildRulesJson(req);
                Rules rules = parseRules(rulesJson);
                boolean hasCombo = rules != null && rules.combo != null;
        
                if (hasCombo) {
                    // combo khÃ´ng cáº§n discountValue, nhÆ°ng náº¿u gá»­i thÃ¬ pháº£i há»£p lá»‡ (hoáº·c bá»)
                    if (discountValue != null && discountValue.compareTo(BigDecimal.ZERO) != 0) {
                        throw new IllegalArgumentException("Khuyáº¿n mÃ£i combo (mua X táº·ng Y) khÃ´ng dÃ¹ng discountValue");
                    }
                    // discountType váº«n giá»¯ PERCENT/AMOUNT trong schema hiá»‡n táº¡i, nhÆ°ng sáº½ Æ°u tiÃªn combo khi tÃ­nh giÃ¡
                } else {
                    if (discountValue == null) throw new IllegalArgumentException("discountValue báº¯t buá»™c (trá»« combo)");
                    if (discountValue.compareTo(BigDecimal.ZERO) < 0) throw new IllegalArgumentException("discountValue pháº£i >= 0");
                    if (!"PERCENT".equals(discountType) && !"AMOUNT".equals(discountType)) {
                        throw new IllegalArgumentException("discountType chá»‰ há»— trá»£ PERCENT hoáº·c AMOUNT");
                    }
                    if ("PERCENT".equals(discountType) && discountValue.compareTo(new BigDecimal("100")) > 0) {
                        throw new IllegalArgumentException("discountValue PERCENT tá»‘i Ä‘a 100");
                    }
                }
        
                Promotion p = new Promotion();
                p.setCode(code);
                p.setName(req.getName().trim());
                p.setDescription(req.getDescription());
                p.setDiscountType(discountType);
                p.setDiscountValue(discountValue == null ? BigDecimal.ZERO.setScale(2, RoundingMode.HALF_UP) : discountValue.setScale(2, RoundingMode.HALF_UP));
                p.setStartDate(req.getStartDate());
                p.setEndDate(req.getEndDate());
                p.setPriority(req.getPriority() == null ? 0 : req.getPriority());
                p.setStackable(req.getStackable() != null && req.getStackable());
                p.setIsActive(req.getIsActive() == null || req.getIsActive());
                p.setApplicabilityJson(buildApplicabilityJson(req));
                p.setRulesJson(rulesJson);
                p.setCreatedBy(createdBy);
                p.setCreatedAt(LocalDateTime.now());
        
                assertNoDuplicatePromotion(p, null);
        
                Promotion saved = promoRepo.save(p);
        
                // init redemption counter row (Ä‘á»ƒ check usageLimit)
                redemptionRepo.findByPromotionId(saved.getId()).orElseGet(() -> {
                    PromotionRedemption r = new PromotionRedemption();
                    r.setPromotionId(saved.getId());
                    r.setUsedCount(0L);
                    r.setUpdatedAt(LocalDateTime.now());
                    return redemptionRepo.save(r);
                });
        
                return saved;
            }
        
            // activeOnly=true => Ä‘ang hoáº¡t Ä‘á»™ng theo thá»i gian (start<=now<=end) vÃ  isActive=true
            public List<Promotion> list(Boolean activeOnly) {
                if (activeOnly != null && activeOnly) {
                    LocalDateTime now = LocalDateTime.now();
                    return promoRepo.findByIsActiveTrueAndStartDateLessThanEqualAndEndDateGreaterThanEqual(now, now);
                }
                return promoRepo.findAll();
            }
        
            @Transactional
            public Promotion update(Integer id, PromotionRequest req) {
                Promotion p = promoRepo.findById(id).orElseThrow(() -> new NoSuchElementException("Promotion not found"));
                if (req == null) throw new IllegalArgumentException("Body rá»—ng");
        
                if (req.getName() != null) p.setName(req.getName().trim());
                if (req.getDescription() != null) p.setDescription(req.getDescription());
        
                if (req.getDiscountType() != null) p.setDiscountType(req.getDiscountType().trim().toUpperCase());
                if (req.getDiscountValue() != null) {
                    if (req.getDiscountValue().compareTo(BigDecimal.ZERO) < 0) throw new IllegalArgumentException("discountValue pháº£i >= 0");
                    p.setDiscountValue(req.getDiscountValue().setScale(2, RoundingMode.HALF_UP));
                }
        
                if (req.getStartDate() != null) p.setStartDate(req.getStartDate());
                if (req.getEndDate() != null) p.setEndDate(req.getEndDate());
                if (req.getPriority() != null) p.setPriority(req.getPriority());
                if (req.getStackable() != null) p.setStackable(req.getStackable());
                if (req.getIsActive() != null) p.setIsActive(req.getIsActive());
        
                if (req.getScope() != null || req.getProductIds() != null || req.getVariantIds() != null) {
                    p.setApplicabilityJson(buildApplicabilityJson(req));
                }
        
                // rules: náº¿u cÃ³ báº¥t ká»³ field rules nÃ o thÃ¬ rebuild, náº¿u khÃ´ng thÃ¬ giá»¯ nguyÃªn
                if (req.getUsageLimit() != null || req.getBuyQty() != null || req.getGetQty() != null) {
                    p.setRulesJson(buildRulesJson(req));
                }
        
                if (!p.getStartDate().isBefore(p.getEndDate())) throw new IllegalArgumentException("startDate pháº£i < endDate");
        
                String dt = p.getDiscountType() == null ? "PERCENT" : p.getDiscountType().trim().toUpperCase();
                if (!"PERCENT".equals(dt) && !"AMOUNT".equals(dt)) {
                    throw new IllegalArgumentException("discountType chá»‰ há»— trá»£ PERCENT hoáº·c AMOUNT");
                }
        
                Rules rules = parseRules(p.getRulesJson());
                boolean hasCombo = rules != null && rules.combo != null;
        
                if (hasCombo) {
                    if (p.getDiscountValue() != null && p.getDiscountValue().compareTo(BigDecimal.ZERO) != 0) {
                        throw new IllegalArgumentException("Khuyáº¿n mÃ£i combo (mua X táº·ng Y) khÃ´ng dÃ¹ng discountValue");
                    }
                    if (rules.combo.buy_qty == null || rules.combo.get_qty == null || rules.combo.buy_qty <= 0 || rules.combo.get_qty <= 0) {
                        throw new IllegalArgumentException("combo buyQty/getQty pháº£i > 0");
                    }
                } else {
                    if (p.getDiscountValue() == null) throw new IllegalArgumentException("discountValue báº¯t buá»™c (trá»« combo)");
                    if ("PERCENT".equals(dt) && p.getDiscountValue().compareTo(new BigDecimal("100")) > 0) {
                        throw new IllegalArgumentException("discountValue PERCENT tá»‘i Ä‘a 100");
                    }
                }
        
                assertNoDuplicatePromotion(p, p.getId());
                return promoRepo.save(p);
            }
        
            @Transactional
            public void delete(Integer id) {
                Promotion p = promoRepo.findById(id).orElseThrow(() -> new NoSuchElementException("Promotion not found"));
                p.setIsActive(false);
                promoRepo.save(p);
            }
        
            // =========================
            // Pricing logic
            // =========================
            public Promotion findBestPromotionForVariant(ProductVariant v, LocalDateTime at) {
                List<Promotion> active = promoRepo.findByIsActiveTrueAndStartDateLessThanEqualAndEndDateGreaterThanEqual(at, at);
        
                BigDecimal base = v.getPrice() == null ? BigDecimal.ZERO : v.getPrice();
                Promotion best = null;
                BigDecimal bestFinal = base;
        
                for (Promotion p : active) {
                    Applicability app = parseApplicability(p.getApplicabilityJson());
                    if (!isApplicable(app, v)) continue;
                    if (!isUsableByLimit(p)) continue;
        
                    BigDecimal finalPrice = computeEffectiveUnitPrice(base, p);
        
                    if (finalPrice.compareTo(bestFinal) < 0) {
                        bestFinal = finalPrice;
                        best = p;
                    } else if (finalPrice.compareTo(bestFinal) == 0 && best != null) {
                        if (p.getPriority() > best.getPriority()) best = p;
                    }
                }
                return best;
            }
        
            public boolean isApplicable(Applicability app, ProductVariant v) {
                String scope = (app.scope == null) ? "ALL" : app.scope.toUpperCase();
                if ("ALL".equals(scope)) return true;
        
                Integer productId = v.getProduct().getId();
                Integer variantId = v.getId();
        
                if (app.product_ids != null && app.product_ids.contains(productId)) return true;
                if (app.variant_ids != null && app.variant_ids.contains(variantId)) return true;
        
                return false;
            }
        
            // GiÃ¡ hiá»‡u lá»±c theo Ä‘Æ¡n vá»‹ (Ä‘á»ƒ hiá»ƒn thá»‹ trÃªn list sáº£n pháº©m)
            // - Náº¿u cÃ³ combo buyX getY => base * buy/(buy+get)
            // - NgÆ°á»£c láº¡i Ã¡p dá»¥ng discountType/discountValue
            public BigDecimal computeEffectiveUnitPrice(BigDecimal base, Promotion p) {
                if (base == null) base = BigDecimal.ZERO;
                if (p == null) return money(base);
        
                Rules rules = parseRules(p.getRulesJson());
                if (rules != null && rules.combo != null && rules.combo.buy_qty != null && rules.combo.get_qty != null) {
                    int buy = rules.combo.buy_qty;
                    int get = rules.combo.get_qty;
                    if (buy > 0 && get > 0) {
                        BigDecimal numerator = base.multiply(BigDecimal.valueOf(buy));
                        BigDecimal denom = BigDecimal.valueOf((long) buy + (long) get);
                        BigDecimal r = numerator.divide(denom, 2, RoundingMode.HALF_UP);
                        return r.compareTo(BigDecimal.ZERO) < 0 ? BigDecimal.ZERO.setScale(2, RoundingMode.HALF_UP) : r;
                    }
                }
        
                return applyDiscount(base, p.getDiscountType(), p.getDiscountValue());
            }
        
            public BigDecimal applyDiscount(BigDecimal base, String type, BigDecimal value) {
                if (base == null) return BigDecimal.ZERO.setScale(2, RoundingMode.HALF_UP);
                if (value == null) return money(base);
        
                String t = (type == null) ? "PERCENT" : type.toUpperCase();
                if ("AMOUNT".equals(t)) {
                    BigDecimal r = base.subtract(value);
                    return r.compareTo(BigDecimal.ZERO) < 0 ? BigDecimal.ZERO.setScale(2, RoundingMode.HALF_UP) : money(r);
                }
        
                BigDecimal pct = value;
                if (pct.compareTo(BigDecimal.ZERO) < 0) pct = BigDecimal.ZERO;
                if (pct.compareTo(new BigDecimal("100")) > 0) pct = new BigDecimal("100");
        
                BigDecimal discount = base.multiply(pct).divide(new BigDecimal("100"), 2, RoundingMode.HALF_UP);
                BigDecimal r = base.subtract(discount);
                return r.compareTo(BigDecimal.ZERO) < 0 ? BigDecimal.ZERO.setScale(2, RoundingMode.HALF_UP) : money(r);
            }
        
            // =========================
            // Usage limit (giá»›i háº¡n sá»‘ láº§n dÃ¹ng)
            // =========================
            public boolean isUsableByLimit(Promotion p) {
                if (p == null) return false;
                Rules rules = parseRules(p.getRulesJson());
                if (rules == null || rules.usage_limit == null) return true;
        
                int limit = rules.usage_limit;
                if (limit <= 0) return true;
        
                long used = redemptionRepo.findByPromotionId(p.getId()).map(PromotionRedemption::getUsedCount).orElse(0L);
                return used < limit;
            }
        
            // Dá»± phÃ²ng cho flow Ä‘áº·t hÃ ng: gá»i khi order dÃ¹ng khuyáº¿n mÃ£i
            @Transactional
            public void recordRedemption(Integer promotionId, long delta) {
                if (promotionId == null) return;
                if (delta <= 0) delta = 1;
        
                PromotionRedemption r = redemptionRepo.findByPromotionId(promotionId).orElseGet(() -> {
                    PromotionRedemption x = new PromotionRedemption();
                    x.setPromotionId(promotionId);
                    x.setUsedCount(0L);
                    x.setUpdatedAt(LocalDateTime.now());
                    return x;
                });
        
                r.setUsedCount((r.getUsedCount() == null ? 0L : r.getUsedCount()) + delta);
                r.setUpdatedAt(LocalDateTime.now());
                redemptionRepo.save(r);
            }
        
            private static BigDecimal money(BigDecimal v) {
                return v.setScale(2, RoundingMode.HALF_UP);
            }
        }
