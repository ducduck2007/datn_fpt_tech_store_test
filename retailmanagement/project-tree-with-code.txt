├── audit
│   ├── Audit.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.audit;
│   │     
│   │     import java.lang.annotation.*;
│   │     
│   │     @Target(ElementType.METHOD)
│   │     @Retention(RetentionPolicy.RUNTIME)
│   │     @Documented
│   │     public @interface Audit {
│   │     
│   │         String module();
│   │         AuditAction action();
│   │         String targetType();
│   │     }
│   │     
│   │   ---- END ----
│   ├── AuditAction.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.audit;
│   │     
│   │     public enum AuditAction {
│   │         CREATE,
│   │         UPDATE,
│   │         DELETE,
│   │         LOGIN,
│   │         LOGOUT
│   │     }
│   │     
│   │   ---- END ----
│   ├── AuditLog.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.audit;
│   │     
│   │     import com.retailmanagement.entity.User;
│   │     import jakarta.persistence.*;
│   │     import jakarta.validation.constraints.NotNull;
│   │     import jakarta.validation.constraints.Size;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.ColumnDefault;
│   │     import org.hibernate.annotations.Nationalized;
│   │     import org.hibernate.annotations.OnDelete;
│   │     import org.hibernate.annotations.OnDeleteAction;
│   │     
│   │     import java.time.Instant;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @Entity
│   │     @Table(name = "audit_logs")
│   │     public class AuditLog {
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         @Column(name = "id", nullable = false)
│   │         private Long id;
│   │     
│   │         @ManyToOne(fetch = FetchType.LAZY)
│   │         @OnDelete(action = OnDeleteAction.SET_NULL)
│   │         @JoinColumn(name = "user_id")
│   │         private User user;
│   │     
│   │         @Size(max = 50)
│   │         @NotNull
│   │         @Nationalized
│   │         @Column(name = "module", nullable = false, length = 50)
│   │         private String module;
│   │     
│   │         @Size(max = 50)
│   │         @NotNull
│   │         @Nationalized
│   │         @Column(name = "action", nullable = false, length = 50)
│   │         private String action;
│   │     
│   │         @Size(max = 50)
│   │         @Nationalized
│   │         @Column(name = "target_type", length = 50)
│   │         private String targetType;
│   │     
│   │         @Column(name = "target_id")
│   │         private Long targetId;
│   │     
│   │         @Nationalized
│   │         @Lob
│   │         @Column(name = "details_json")
│   │         private String detailsJson;
│   │     
│   │         @Size(max = 45)
│   │         @Nationalized
│   │         @Column(name = "ip_address", length = 45)
│   │         private String ipAddress;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "created_at", nullable = false)
│   │         private Instant createdAt;
│   │     
│   │         @PrePersist
│   │         public void prePersist() {
│   │             this.createdAt = Instant.now();
│   │         }
│   │     
│   │     }
│   │   ---- END ----
│   ├── AuditLogAspect.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.audit;
│   │     
│   │     import com.fasterxml.jackson.core.JsonProcessingException;
│   │     import com.retailmanagement.dto.response.UserResponse;
│   │     import com.retailmanagement.util.IpUtil;
│   │     import com.retailmanagement.util.SecurityUtil;
│   │     import jakarta.servlet.http.HttpServletRequest;
│   │     import lombok.RequiredArgsConstructor;
│   │     import org.aspectj.lang.JoinPoint;
│   │     import org.aspectj.lang.annotation.AfterReturning;
│   │     import org.aspectj.lang.annotation.Aspect;
│   │     import org.springframework.stereotype.Component;
│   │     import tools.jackson.databind.ObjectMapper;
│   │     
│   │     import java.util.Map;
│   │     
│   │     @Aspect
│   │     @Component
│   │     @RequiredArgsConstructor
│   │     public class AuditLogAspect {
│   │     
│   │         private final AuditLogService auditLogService;
│   │         private final HttpServletRequest request;
│   │         private final ObjectMapper objectMapper;
│   │     
│   │         //Chỉ chạy khi Method chạy thành công (Ví dụ method: method Create, method Update)
│   │         @AfterReturning(
│   │                 // Chỉ chạy khi có annotation audit (@Audit)
│   │                 pointcut = "@annotation(audit)",
│   │                 // Lấy dữ liệu của method (Ví dụ method: method Create, method Update)
│   │                 returning = "result"
│   │         )
│   │         public void logAfterSuccess(
│   │                 JoinPoint joinPoint,
│   │                 Audit audit,
│   │                 Object result
│   │         ) throws JsonProcessingException {
│   │             // Lấy id của user thao tác
│   │             Integer userId = SecurityUtil.getCurrentUserId();
│   │     
│   │             // Lấy ip của user thao tác
│   │             String ip = IpUtil.getClientIp(request);
│   │     
│   │             // Lấy id của đối tượng tác động (Ví dụ đối tượng: User, Customer, Product,...)
│   │             Long targetId = extractTargetId(result);
│   │     
│   │             //
│   │             String detailsJson = objectMapper.writeValueAsString(
│   │                     Map.of(
│   │                             "method", joinPoint.getSignature().getName(),
│   │                             "args", joinPoint.getArgs()
│   │                     )
│   │             );
│   │     
│   │             // Lưu
│   │             auditLogService.save(
│   │                     userId,
│   │                     audit.module(),
│   │                     audit.action(),
│   │                     audit.targetType(),
│   │                     targetId,
│   │                     detailsJson,
│   │                     ip
│   │             );
│   │         }
│   │     
│   │         //Hàm lấy id của đối tượng bị thao tác
│   │         private Long extractTargetId(Object result) {
│   │             if(result == null) {
│   │                 return null;
│   │             }
│   │     
│   │             if(result instanceof UserResponse user) {
│   │                 return Long.valueOf(user.getId());
│   │             }
│   │             return null;
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   ├── AuditLogRepository.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.audit;
│   │     
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     import org.springframework.stereotype.Repository;
│   │     
│   │     @Repository
│   │     public interface AuditLogRepository extends JpaRepository<AuditLog, Long> {
│   │     }
│   │     
│   │   ---- END ----
│   └── AuditLogService.java
│       ---- CODE ----
│         package com.retailmanagement.audit;
│         
│         import com.retailmanagement.entity.User;
│         import jakarta.persistence.EntityManager;
│         import jakarta.persistence.PersistenceContext;
│         import lombok.RequiredArgsConstructor;
│         import org.springframework.stereotype.Service;
│         
│         @Service
│         @RequiredArgsConstructor
│         public class AuditLogService {
│         
│             private final AuditLogRepository auditLogRepository;
│         
│             @PersistenceContext
│             private EntityManager entityManager;
│         
│             public void save(
│                     Integer userId,
│                     String module,
│                     AuditAction action,
│                     String targetType,
│                     Long targetId,
│                     String detailsJson,
│                     String ipAddress
│             ) {
│                 AuditLog log = new AuditLog();
│         
│                 // Dùng entityMananger.getReference để tạo proxy User để gán userId
│                 // (proxy đại diện cho User thật)
│                if(userId != null) {
│                     User userRef = entityManager.getReference(User.class,userId);
│                     log.setUser(userRef);
│                }
│                 log.setModule(module);
│                 log.setAction(action.name());
│                 log.setTargetType(targetType);
│                 log.setTargetId(targetId);
│                 log.setDetailsJson(detailsJson);
│                 log.setIpAddress(ipAddress);
│         
│                 auditLogRepository.save(log);
│             }
│         }
│         
│       ---- END ----
├── config
│   ├── CorsConfig.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.config;
│   │     
│   │     import org.springframework.context.annotation.Bean;
│   │     import org.springframework.context.annotation.Configuration;
│   │     import org.springframework.web.cors.CorsConfiguration;
│   │     import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
│   │     import org.springframework.web.filter.CorsFilter;
│   │     
│   │     @Configuration
│   │     public class CorsConfig {
│   │     
│   │         @Bean
│   │         public CorsFilter corsFilter() {
│   │             UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
│   │             CorsConfiguration config = new CorsConfiguration();
│   │             config.setAllowCredentials(true);
│   │             config.addAllowedOriginPattern("*");
│   │             config.addAllowedHeader("*");
│   │             config.addAllowedMethod("*");
│   │             source.registerCorsConfiguration("/**", config);
│   │             return new CorsFilter(source);
│   │         }
│   │     }
│   │   ---- END ----
│   ├── JwtProperties.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.config;
│   │     
│   │     import lombok.Data;
│   │     import org.springframework.boot.context.properties.ConfigurationProperties;
│   │     import org.springframework.context.annotation.Configuration;
│   │     
│   │     @Data
│   │     @Configuration
│   │     @ConfigurationProperties(prefix = "app.jwt")
│   │     public class JwtProperties {
│   │         private String secret;
│   │         private long expiration;
│   │     }
│   │     
│   │   ---- END ----
│   ├── ModelMapperConfig.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.config;
│   │     
│   │     import org.modelmapper.ModelMapper;
│   │     import org.springframework.context.annotation.Bean;
│   │     import org.springframework.context.annotation.Configuration;
│   │     
│   │     @Configuration
│   │     public class ModelMapperConfig {
│   │     
│   │         @Bean
│   │         public ModelMapper modelMapper() {
│   │             return new ModelMapper();
│   │         }
│   │     }
│   │   ---- END ----
│   ├── SecurityConfig.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.config;
│   │     
│   │     import com.retailmanagement.security.CustomUserDetailsService;
│   │     import com.retailmanagement.security.JwtAuthenticationFilter;
│   │     import lombok.RequiredArgsConstructor;
│   │     import org.springframework.context.annotation.Bean;
│   │     import org.springframework.context.annotation.Configuration;
│   │     import org.springframework.security.authentication.AuthenticationManager;
│   │     import org.springframework.security.authentication.ProviderManager;
│   │     import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
│   │     import org.springframework.security.config.annotation.web.builders.HttpSecurity;
│   │     import org.springframework.security.config.http.SessionCreationPolicy;
│   │     import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
│   │     import org.springframework.security.crypto.password.PasswordEncoder;
│   │     import org.springframework.security.web.SecurityFilterChain;
│   │     import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
│   │     
│   │     @Configuration
│   │     @RequiredArgsConstructor
│   │     public class SecurityConfig {
│   │     
│   │         private final JwtAuthenticationFilter jwtAuthenticationFilter;
│   │         private final CustomUserDetailsService userDetailsService;
│   │     
│   │         @Bean
│   │         public PasswordEncoder passwordEncoder() {
│   │             return new BCryptPasswordEncoder();
│   │         }
│   │     
│   │         /**
│   │          * ✅ Fix cho lỗi của bạn:
│   │          * - DaoAuthenticationProvider bắt buộc truyền UserDetailsService trong constructor
│   │          * - Không dùng setUserDetailsService() (vì version bạn đang dùng không có)
│   │          */
│   │         @Bean
│   │         public DaoAuthenticationProvider authenticationProvider(PasswordEncoder encoder) {
│   │             DaoAuthenticationProvider provider = new DaoAuthenticationProvider(userDetailsService);
│   │             provider.setPasswordEncoder(encoder);
│   │             return provider;
│   │         }
│   │     
│   │         @Bean
│   │         public AuthenticationManager authenticationManager(DaoAuthenticationProvider provider) {
│   │             return new ProviderManager(provider);
│   │         }
│   │     
│   │         @Bean
│   │         public SecurityFilterChain filterChain(HttpSecurity http, DaoAuthenticationProvider provider) throws Exception {
│   │             http
│   │                     .csrf(csrf -> csrf.disable())
│   │                     .cors(cors -> {})
│   │                     .sessionManagement(sm -> sm.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
│   │                     .authenticationProvider(provider)
│   │                     .authorizeHttpRequests(auth -> auth
│   │                             .requestMatchers(
│   │                                     "/api/auth/**",
│   │                                     "/swagger-ui.html",
│   │                                     "/swagger-ui/**",
│   │                                     "/api-docs/**",
│   │                                     "/v3/api-docs/**",
│   │                                     "/api/products/**",
│   │                                     "/api/categories/**",
│   │                                     "/uploads/**"
│   │                             ).permitAll()
│   │     
│   │                             // ví dụ rule role (tuỳ bạn đang dùng ROLE_... hay không)
│   │                             .requestMatchers("/api/admin/**").hasRole("ADMIN")
│   │                             .requestMatchers("/api/sales/**").hasAnyRole("SALES", "ADMIN")
│   │                             .requestMatchers("/api/inventory/**").hasAnyRole("INVENTORY", "ADMIN")
│   │                             .requestMatchers("/api/customer/**").hasAnyRole("CUSTOMER", "ADMIN")
│   │     
│   │                             .anyRequest().authenticated()
│   │                     )
│   │                     .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);
│   │     
│   │             return http.build();
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   └── WebConfig.java
│       ---- CODE ----
│         package com.retailmanagement.config;
│         
│         import org.springframework.context.annotation.Configuration;
│         import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
│         import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;
│         
│         @Configuration
│         public class WebConfig implements WebMvcConfigurer {
│         
│             @Override
│             public void addResourceHandlers(ResourceHandlerRegistry registry) {
│                 String projectDir = System.getProperty("user.dir");
│         
│                 registry.addResourceHandler("/uploads/**")
│                         .addResourceLocations("file:" + projectDir + "/uploads/");
│             }
│         }
│       ---- END ----
├── controller
│   ├── AuthController.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.controller;
│   │     
│   │     import com.retailmanagement.dto.request.LoginRequest;
│   │     import com.retailmanagement.dto.request.RegisterRequest;
│   │     import com.retailmanagement.dto.response.ApiResponse;
│   │     import com.retailmanagement.dto.response.AuthResponse;
│   │     import com.retailmanagement.service.AuthService;
│   │     import jakarta.validation.Valid;
│   │     import lombok.RequiredArgsConstructor;
│   │     import org.springframework.web.bind.annotation.*;
│   │     
│   │     @RestController
│   │     @RequiredArgsConstructor
│   │     @RequestMapping("/api/auth")
│   │     public class AuthController {
│   │     
│   │         private final AuthService authService;
│   │     
│   │         @PostMapping("/register")
│   │         public ApiResponse<AuthResponse> register(@Valid @RequestBody RegisterRequest request) {
│   │             return ApiResponse.success("Đăng ký thành công", authService.register(request));
│   │         }
│   │     
│   │         @PostMapping("/login")
│   │         public ApiResponse<AuthResponse> login(@Valid @RequestBody LoginRequest request) {
│   │             return ApiResponse.success("Đăng nhập thành công", authService.login(request));
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   ├── CategoryController.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.controller;
│   │     
│   │     import com.retailmanagement.dto.response.ApiResponse;
│   │     import com.retailmanagement.dto.response.CategoryResponse;
│   │     import com.retailmanagement.entity.Category;
│   │     import com.retailmanagement.repository.CategoryRepository;
│   │     import lombok.RequiredArgsConstructor;
│   │     import org.springframework.http.ResponseEntity;
│   │     import org.springframework.web.bind.annotation.*;
│   │     
│   │     import java.util.List;
│   │     
│   │     @RestController
│   │     @RequestMapping("/api/categories")
│   │     @RequiredArgsConstructor
│   │     public class CategoryController {
│   │     
│   │         private final CategoryRepository categoryRepository;
│   │     
│   │         @PostMapping
│   │         public ResponseEntity<ApiResponse<Category>> createCategory(@RequestBody Category category) {
│   │             Category saved = categoryRepository.save(category);
│   │             return ResponseEntity.ok(ApiResponse.success("Tạo danh mục thành công", saved));
│   │         }
│   │     
│   │         // ✅ Added: category list for product filter UI
│   │         // activeOnly=true by default to avoid showing disabled categories
│   │         @GetMapping
│   │         public ResponseEntity<ApiResponse<List<CategoryResponse>>> listCategories(
│   │                 @RequestParam(defaultValue = "true") boolean activeOnly
│   │         ) {
│   │             List<Category> categories = activeOnly
│   │                     ? categoryRepository.findByIsActiveTrueOrderByDisplayOrderAscNameAsc()
│   │                     : categoryRepository.findAllByOrderByDisplayOrderAscNameAsc();
│   │     
│   │             List<CategoryResponse> result = categories.stream().map(this::toResponse).toList();
│   │             return ResponseEntity.ok(ApiResponse.success("Lấy danh mục thành công", result));
│   │         }
│   │     
│   │         private CategoryResponse toResponse(Category c) {
│   │             return CategoryResponse.builder()
│   │                     .id(c.getId())
│   │                     .name(c.getName())
│   │                     .description(c.getDescription())
│   │                     .imageUrl(c.getImageUrl())
│   │                     .parentId(c.getParent() != null ? c.getParent().getId() : null)
│   │                     .displayOrder(c.getDisplayOrder())
│   │                     .isActive(c.getIsActive())
│   │                     .build();
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   ├── CusController.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.controller;
│   │     
│   │     
│   │     import com.retailmanagement.dto.request.CustomerRequest;
│   │     import com.retailmanagement.dto.response.CustomerResponse;
│   │     import com.retailmanagement.entity.CustomerType;
│   │     import com.retailmanagement.service.CustomerService;
│   │     import jakarta.validation.Valid;
│   │     import org.springframework.beans.factory.annotation.Autowired;
│   │     import org.springframework.http.HttpStatus;
│   │     import org.springframework.http.ResponseEntity;
│   │     import org.springframework.web.bind.annotation.*;
│   │     
│   │     import java.util.List;
│   │     
│   │     @RestController
│   │     @CrossOrigin(origins = "*")
│   │     @RequestMapping("/api/auth/customers")
│   │     public class CusController {
│   │         @Autowired
│   │         private CustomerService cusservice;
│   │         @PostMapping("")
│   │         public ResponseEntity<CustomerResponse> addCustomer(@Valid @RequestBody CustomerRequest cus) {
│   │            CustomerResponse response= cusservice.create(cus);
│   │             return ResponseEntity.status(HttpStatus.CREATED).body(response) ;
│   │         }
│   │         @GetMapping("")
│   │         public ResponseEntity<List<CustomerResponse>> findAll() {
│   │             return ResponseEntity.status(HttpStatus.OK).body(cusservice.findAll());
│   │         }
│   │         @GetMapping("/{type}")
│   │         public ResponseEntity<List<CustomerResponse>> findByCustomerType(@Valid @PathVariable CustomerType type) {
│   │             return ResponseEntity.status(HttpStatus.OK).body(cusservice.findbyCustomerType(type));
│   │         }
│   │         @DeleteMapping("/{id}")
│   │         public ResponseEntity<CustomerResponse> deleteCustomer(@Valid @PathVariable int id) {
│   │             cusservice.deleteById(id);
│   │             return ResponseEntity.noContent().build();
│   │         }
│   │         @PutMapping("/{id}")
│   │         public ResponseEntity<CustomerResponse> updateCustomer(@Valid @PathVariable int id, @RequestBody CustomerRequest cus) {
│   │             CustomerResponse up = cusservice.updateById(id, cus);
│   │             return ResponseEntity.ok().body(up) ;
│   │         }
│   │     
│   │     }
│   │     
│   │   ---- END ----
│   ├── OrderController.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.controller;
│   │     
│   │     import com.retailmanagement.dto.request.CreateOrderRequest;
│   │     import com.retailmanagement.dto.request.UpdateOrderRequest;
│   │     import com.retailmanagement.dto.response.CreateOrderResponse;
│   │     import com.retailmanagement.dto.response.OrderDetailResponse;
│   │     import com.retailmanagement.dto.response.OrderListResponse;
│   │     import com.retailmanagement.security.CustomUserDetails;
│   │     import com.retailmanagement.service.OrderQueryService;
│   │     import com.retailmanagement.service.OrderService;
│   │     import lombok.RequiredArgsConstructor;
│   │     import org.springframework.http.ResponseEntity;
│   │     import org.springframework.security.core.annotation.AuthenticationPrincipal;
│   │     import org.springframework.web.bind.annotation.*;
│   │     
│   │     import java.util.List;
│   │     
│   │     @RestController
│   │     @RequestMapping("/api/orders")
│   │     @RequiredArgsConstructor
│   │     public class OrderController {
│   │     
│   │         private final OrderService orderService;
│   │         private final OrderQueryService orderQueryService;
│   │     
│   │         @PostMapping
│   │         public ResponseEntity<CreateOrderResponse> createOrder(
│   │                 @RequestBody CreateOrderRequest request,
│   │                 @AuthenticationPrincipal CustomUserDetails user) {
│   │     
│   │             return ResponseEntity.ok(
│   │                     orderService.createOrder(request, user.getUserId())
│   │             );
│   │         }
│   │     
│   │     
│   │     
│   │     
│   │         @GetMapping("/new")
│   │         public List<OrderListResponse> getNewOrders() {
│   │             return orderQueryService.getNewOrders();
│   │         }
│   │     
│   │         @GetMapping("/processing")
│   │         public List<OrderListResponse> getProcessingOrders() {
│   │             return orderQueryService.getProcessingOrders();
│   │         }
│   │     
│   │         /* UPDATE */
│   │         @PutMapping("/{orderId}")
│   │         public ResponseEntity<Void> updateOrder(
│   │                 @PathVariable Long orderId,
│   │                 @RequestBody UpdateOrderRequest request) {
│   │     
│   │             orderService.updateOrder(orderId, request);
│   │             return ResponseEntity.ok().build();
│   │         }
│   │     
│   │         /* CANCEL */
│   │         @PutMapping("/{orderId}/cancel")
│   │         public ResponseEntity<Void> cancelOrder(
│   │                 @PathVariable Long orderId,
│   │                 @AuthenticationPrincipal CustomUserDetails user) {
│   │     
│   │             orderService.cancelOrder(orderId, user.getUserId());
│   │             return ResponseEntity.ok().build();
│   │         }
│   │     
│   │         /* DELETE */
│   │         @DeleteMapping("/{orderId}")
│   │         public ResponseEntity<Void> deleteOrder(@PathVariable Long orderId) {
│   │     
│   │             orderService.deleteOrder(orderId);
│   │             return ResponseEntity.ok().build();
│   │         }
│   │     
│   │         /* DETAIL */
│   │         @GetMapping("/{orderId}")
│   │         public ResponseEntity<OrderDetailResponse> getOrderDetail(
│   │                 @PathVariable Long orderId) {
│   │     
│   │             return ResponseEntity.ok(
│   │                     orderService.getOrderDetail(orderId)
│   │             );
│   │         }
│   │     }
│   │     
│   │     
│   │   ---- END ----
│   ├── PriceController.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.controller;
│   │     
│   │     import com.retailmanagement.dto.request.UpsertPriceRequest;
│   │     import com.retailmanagement.dto.response.ApiResponse;
│   │     import com.retailmanagement.dto.response.VariantPriceResponse;
│   │     import com.retailmanagement.entity.PriceHistory;
│   │     import com.retailmanagement.service.PricingService;
│   │     import org.springframework.web.bind.annotation.*;
│   │     
│   │     import java.util.List;
│   │     
│   │     @RestController
│   │     @RequestMapping("/api/prices")
│   │     public class PriceController {
│   │     
│   │         private final PricingService pricingService;
│   │     
│   │         public PriceController(PricingService pricingService) {
│   │             this.pricingService = pricingService;
│   │         }
│   │     
│   │         // Tạo/đổi giá variant + ghi history
│   │         @PostMapping("/variants/{variantId}")
│   │         public ApiResponse<PriceHistory> setVariantPrice(@PathVariable Integer variantId,
│   │                                                          @RequestBody UpsertPriceRequest req) {
│   │             // nếu bạn có auth: lấy userId từ SecurityContext, tạm set null/0
│   │             PriceHistory ph = pricingService.setVariantPrice(variantId, req, 0);
│   │             return ApiResponse.success(ph);
│   │         }
│   │     
│   │         // Danh sách giá theo sản phẩm (kèm finalPrice sau promo)
│   │         @GetMapping("/products/{productId}")
│   │         public ApiResponse<List<VariantPriceResponse>> listByProduct(@PathVariable Integer productId) {
│   │             return ApiResponse.success(pricingService.listCurrentPricesByProduct(productId));
│   │         }
│   │     
│   │         // Sửa bản ghi giá hiện tại
│   │         @PutMapping("/history/{id}")
│   │         public ApiResponse<PriceHistory> updateLatest(@PathVariable Long id, @RequestBody UpsertPriceRequest req) {
│   │             return ApiResponse.success(pricingService.updateLatestHistory(id, req));
│   │         }
│   │     
│   │         // Xóa bản ghi giá hiện tại và rollback
│   │         @DeleteMapping("/history/{id}")
│   │         public ApiResponse<String> deleteLatest(@PathVariable Long id) {
│   │             pricingService.deleteLatestAndRollback(id);
│   │             return ApiResponse.success("OK");
│   │         }
│   │     
│   │         // Giá hiện tại sau khuyến mãi theo variant
│   │         @GetMapping("/variants/{variantId}/effective")
│   │         public ApiResponse<VariantPriceResponse> getEffective(@PathVariable Integer variantId) {
│   │             return ApiResponse.success(pricingService.getEffectivePrice(variantId));
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   ├── ProductController.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.controller;
│   │     
│   │     import com.retailmanagement.dto.request.ProductRequest;
│   │     import com.retailmanagement.dto.response.ApiResponse;
│   │     import com.retailmanagement.dto.response.ProductResponse;
│   │     import com.retailmanagement.service.ProductService;
│   │     import lombok.RequiredArgsConstructor;
│   │     import org.springframework.data.domain.Page;
│   │     import org.springframework.http.MediaType;
│   │     import org.springframework.http.ResponseEntity;
│   │     import org.springframework.web.bind.annotation.*;
│   │     
│   │     import java.io.IOException;
│   │     
│   │     @RestController
│   │     @RequestMapping("/api/products")
│   │     @RequiredArgsConstructor
│   │     public class ProductController {
│   │     
│   │         private final ProductService productService;
│   │     
│   │         @PostMapping(consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
│   │         public ResponseEntity<ApiResponse<Object>> createProduct(@ModelAttribute ProductRequest request) throws IOException {
│   │             productService.createProduct(request);
│   │             return ResponseEntity.ok(ApiResponse.success("Thêm sản phẩm thành công", null));
│   │         }
│   │     
│   │         @GetMapping
│   │         public ResponseEntity<ApiResponse<Page<ProductResponse>>> getProducts(
│   │                 @RequestParam(defaultValue = "0") int page,
│   │                 @RequestParam(required = false) Integer categoryId
│   │         ) {
│   │             Page<ProductResponse> products = productService.getProducts(page, categoryId);
│   │             return ResponseEntity.ok(ApiResponse.success("Lấy danh sách thành công", products));
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   ├── PromotionController.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.controller;
│   │     
│   │     import com.retailmanagement.dto.request.PromotionRequest;
│   │     import com.retailmanagement.dto.response.ApiResponse;
│   │     import com.retailmanagement.entity.Promotion;
│   │     import com.retailmanagement.service.PromotionService;
│   │     import org.springframework.web.bind.annotation.*;
│   │     
│   │     import java.util.List;
│   │     
│   │     @RestController
│   │     @RequestMapping("/api/promotions")
│   │     public class PromotionController {
│   │     
│   │         private final PromotionService promotionService;
│   │     
│   │         public PromotionController(PromotionService promotionService) {
│   │             this.promotionService = promotionService;
│   │         }
│   │     
│   │         @PostMapping
│   │         public ApiResponse<Promotion> create(@RequestBody PromotionRequest req) {
│   │             // nếu có auth: lấy userId thật
│   │             return ApiResponse.success(promotionService.create(req, 0));
│   │         }
│   │     
│   │         @GetMapping
│   │         public ApiResponse<List<Promotion>> list(@RequestParam(required = false) Boolean activeOnly) {
│   │             return ApiResponse.success(promotionService.list(activeOnly));
│   │         }
│   │     
│   │         @PutMapping("/{id}")
│   │         public ApiResponse<Promotion> update(@PathVariable Integer id, @RequestBody PromotionRequest req) {
│   │             return ApiResponse.success(promotionService.update(id, req));
│   │         }
│   │     
│   │         @DeleteMapping("/{id}")
│   │         public ApiResponse<String> delete(@PathVariable Integer id) {
│   │             promotionService.delete(id);
│   │             return ApiResponse.success("OK");
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   ├── SettingController.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.controller;
│   │     
│   │     import com.retailmanagement.dto.request.SetDefaultCurrencyRequest;
│   │     import com.retailmanagement.dto.response.ApiResponse;
│   │     import com.retailmanagement.service.SettingService;
│   │     import org.springframework.web.bind.annotation.*;
│   │     
│   │     @RestController
│   │     @RequestMapping("/api/settings")
│   │     public class SettingController {
│   │     
│   │         private final SettingService settingService;
│   │     
│   │         public SettingController(SettingService settingService) {
│   │             this.settingService = settingService;
│   │         }
│   │     
│   │         @GetMapping("/currency/default")
│   │         public ApiResponse<String> getDefaultCurrency() {
│   │             return ApiResponse.success(settingService.getDefaultCurrency());
│   │         }
│   │     
│   │         @PutMapping("/currency/default")
│   │         public ApiResponse<String> setDefaultCurrency(@RequestBody SetDefaultCurrencyRequest req) {
│   │             return ApiResponse.success(settingService.setDefaultCurrency(req.getCurrencyCode()));
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   ├── TestApiController.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.controller;
│   │     
│   │     import com.retailmanagement.dto.response.ApiResponse;
│   │     import org.springframework.web.bind.annotation.GetMapping;
│   │     import org.springframework.web.bind.annotation.RequestMapping;
│   │     import org.springframework.web.bind.annotation.RestController;
│   │     
│   │     @RestController
│   │     @RequestMapping("/api/test")
│   │     public class TestApiController {
│   │     
│   │         @GetMapping("/protected")
│   │         public ApiResponse<String> protectedApi() {
│   │             return ApiResponse.success("OK protected");
│   │         }
│   │     }
│   │     
│   │     
│   │   ---- END ----
│   └── UserController.java
│       ---- CODE ----
│         package com.retailmanagement.controller;
│         
│         import com.retailmanagement.dto.request.CreateUserRequest;
│         import com.retailmanagement.dto.request.UpdateUserRequest;
│         import com.retailmanagement.dto.response.UserResponse;
│         import com.retailmanagement.service.UserService;
│         import jakarta.validation.Valid;
│         import lombok.RequiredArgsConstructor;
│         import org.springframework.http.HttpStatus;
│         import org.springframework.http.ResponseEntity;
│         import org.springframework.web.bind.annotation.*;
│         
│         import java.util.List;
│         
│         @RestController
│         @CrossOrigin("*")
│         @RequestMapping("/api/auth/users")
│         @RequiredArgsConstructor
│         public class UserController {
│         
│             private final UserService userService;
│         
│             @GetMapping("")
│             public List<UserResponse> getAllUsers(){
│                 return userService.findAll();
│             }
│         
│             @PostMapping("add")
│             public ResponseEntity<UserResponse> createUser(@Valid @RequestBody CreateUserRequest request){
│                 UserResponse response = userService.createUser(request);
│                 return ResponseEntity.status(HttpStatus.CREATED).body(response);
│             }
│         
│             @PutMapping("update")
│             public ResponseEntity<UserResponse> UpdateUser(@Valid @RequestBody UpdateUserRequest request, @RequestParam("id") Integer id){
│                 UserResponse response = userService.updateUser(request,id);
│                 return ResponseEntity.ok(response);
│             }
│         
│             @DeleteMapping("delete")
│             public ResponseEntity<UserResponse> DeleteUser(@RequestParam("id") Integer id){
│                 UserResponse response = userService.deleteUser(id);
│                 return ResponseEntity.noContent().build();
│             }
│         }
│         
│       ---- END ----
├── dto
│   ├── request
│   │   ├── CreateOrderItemRequest.java
│   │   │   ---- CODE ----
│   │   │     package com.retailmanagement.dto.request;
│   │   │     
│   │   │     import lombok.Data;
│   │   │     
│   │   │     @Data
│   │   │     public class CreateOrderItemRequest {
│   │   │     
│   │   │         private Integer variantId;
│   │   │         private Integer quantity;
│   │   │     }
│   │   │     
│   │   │   ---- END ----
│   │   ├── CreateOrderRequest.java
│   │   │   ---- CODE ----
│   │   │     package com.retailmanagement.dto.request;
│   │   │     
│   │   │     import lombok.Data;
│   │   │     
│   │   │     import java.util.List;
│   │   │     
│   │   │     @Data
│   │   │     public class CreateOrderRequest {
│   │   │     
│   │   │         private Integer customerId;
│   │   │         private String paymentMethod; // CASH / BANK / COD
│   │   │         private String channel;        // ONLINE / OFFLINE
│   │   │         private String notes;
│   │   │     
│   │   │         private List<CreateOrderItemRequest> items;
│   │   │     }
│   │   │     
│   │   │     
│   │   │   ---- END ----
│   │   ├── CreateUserRequest.java
│   │   │   ---- CODE ----
│   │   │     package com.retailmanagement.dto.request;
│   │   │     
│   │   │     import jakarta.validation.constraints.Email;
│   │   │     import jakarta.validation.constraints.NotBlank;
│   │   │     import jakarta.validation.constraints.Size;
│   │   │     import lombok.AllArgsConstructor;
│   │   │     import lombok.Builder;
│   │   │     import lombok.Data;
│   │   │     import lombok.NoArgsConstructor;
│   │   │     
│   │   │     @Data
│   │   │     @NoArgsConstructor
│   │   │     @AllArgsConstructor
│   │   │     @Builder
│   │   │     public class CreateUserRequest {
│   │   │         //Dùng để tạo User mới
│   │   │         @NotBlank(message = "Username không được để trống")
│   │   │         @Size(max = 50, message = "Username tối đa 50 ký tự")
│   │   │         private String username;
│   │   │     
│   │   │         @NotBlank(message = "Email không được để trống")
│   │   │         @Email(message = "Email không đúng định dạng")
│   │   │         private String email;
│   │   │     
│   │   │         @NotBlank(message = "Password không được để trống")
│   │   │         @Size(min = 6, message = "Password phải có ít nhất 6 ký tụ")
│   │   │         private String password; // plaintext từ client
│   │   │     
│   │   │         private String role; //Chỉ được nhập ADMIN,SALES,INVENTORY,CUSTOMER
│   │   │     }
│   │   │     
│   │   │   ---- END ----
│   │   ├── CustomerRequest.java
│   │   │   ---- CODE ----
│   │   │     package com.retailmanagement.dto.request;
│   │   │     
│   │   │     
│   │   │     import com.retailmanagement.entity.CustomerType;
│   │   │     import jakarta.validation.constraints.Email;
│   │   │     import jakarta.validation.constraints.NotBlank;
│   │   │     import jakarta.validation.constraints.*;
│   │   │     import jakarta.validation.constraints.Size;
│   │   │     import lombok.Data;
│   │   │     import lombok.*;
│   │   │     
│   │   │     import java.time.LocalDate;
│   │   │     
│   │   │     @Data
│   │   │     @NoArgsConstructor
│   │   │     @AllArgsConstructor
│   │   │     @Builder
│   │   │     public class CustomerRequest {
│   │   │         @NotBlank(message = "Không được để trống tên khách hàng")
│   │   │         @Size(max = 200, message = "Tên không được vượt quá 200 ký tự")
│   │   │         private String fullName;
│   │   │         @Email(message = "Email không hợp lệ")
│   │   │         @Size(max = 200, message = "Email không được vượt quá 200 ký tự")
│   │   │         @NotBlank(message = "Không được để trống email khách hàng")
│   │   │         private String email;
│   │   │         @Pattern(regexp = "^(0|\\+84)[0-9]{9,10}$", message = "Số điện thoại không hợp lệ")
│   │   │         @NotBlank(message = "Không được để trống số điện thoại khách hàng")
│   │   │         private String phone;
│   │   │     
│   │   │         @Past(message = "Ngày sinh phải là ngày trong quá khứ")
│   │   │         private LocalDate birthDate;
│   │   │     
│   │   │         private CustomerType customerType;
│   │   │     
│   │   │         @Size(max = 500, message = "Ghi chú không được vượt quá 500 ký tự")
│   │   │         private String note;
│   │   │         @Size(max = 500, message = "Địa chỉ không được vượt quá 500 ký tự")
│   │   │         private String address; // Thêm field address
│   │   │     
│   │   │         @Size(max = 2000, message = "Ghi chú không được vượt quá 2000 ký tự")
│   │   │         private String notes; // MATCH với entity: notes (không phải note)
│   │   │     }
│   │   │     
│   │   │   ---- END ----
│   │   ├── LoginRequest.java
│   │   │   ---- CODE ----
│   │   │     package com.retailmanagement.dto.request;
│   │   │     
│   │   │     import jakarta.validation.constraints.NotBlank;
│   │   │     import lombok.Data;
│   │   │     
│   │   │     @Data
│   │   │     public class LoginRequest {
│   │   │     
│   │   │         // có thể là username hoặc email
│   │   │         @NotBlank(message = "identifier không được để trống")
│   │   │         private String identifier;
│   │   │     
│   │   │         @NotBlank(message = "password không được để trống")
│   │   │         private String password;
│   │   │     }
│   │   │     
│   │   │   ---- END ----
│   │   ├── ProductRequest.java
│   │   │   ---- CODE ----
│   │   │     package com.retailmanagement.dto.request;
│   │   │     
│   │   │     import lombok.Data;
│   │   │     import org.springframework.web.multipart.MultipartFile;
│   │   │     
│   │   │     @Data
│   │   │     public class ProductRequest {
│   │   │         private String name;
│   │   │         private String sku;
│   │   │         private String description;
│   │   │         private Boolean isVisible;
│   │   │     
│   │   │         private Integer categoryId;
│   │   │     
│   │   │         private MultipartFile imageFile;
│   │   │     }
│   │   │     
│   │   │   ---- END ----
│   │   ├── PromotionRequest.java
│   │   │   ---- CODE ----
│   │   │     package com.retailmanagement.dto.request;
│   │   │     
│   │   │     import lombok.Getter;
│   │   │     import lombok.Setter;
│   │   │     
│   │   │     import java.math.BigDecimal;
│   │   │     import java.time.LocalDateTime;
│   │   │     import java.util.List;
│   │   │     
│   │   │     @Getter
│   │   │     @Setter
│   │   │     public class PromotionRequest {
│   │   │     
│   │   │         private String code;
│   │   │         private String name;
│   │   │         private String description;
│   │   │     
│   │   │         // PERCENT / AMOUNT
│   │   │         private String discountType;
│   │   │         private BigDecimal discountValue;
│   │   │     
│   │   │         private LocalDateTime startDate;
│   │   │         private LocalDateTime endDate;
│   │   │     
│   │   │         // ALL / PRODUCT / VARIANT
│   │   │         private String scope;
│   │   │         private List<Integer> productIds;
│   │   │         private List<Integer> variantIds;
│   │   │     
│   │   │         private Integer priority = 0;
│   │   │         private Boolean stackable = false;
│   │   │         private Boolean isActive = true;
│   │   │     }
│   │   │     
│   │   │   ---- END ----
│   │   ├── RegisterRequest.java
│   │   │   ---- CODE ----
│   │   │     package com.retailmanagement.dto.request;
│   │   │     
│   │   │     import jakarta.validation.constraints.Email;
│   │   │     import jakarta.validation.constraints.NotBlank;
│   │   │     import jakarta.validation.constraints.Size;
│   │   │     import lombok.Data;
│   │   │     
│   │   │     @Data
│   │   │     public class RegisterRequest {
│   │   │     
│   │   │         @NotBlank(message = "username không được để trống")
│   │   │         @Size(min = 3, max = 50, message = "username 3-50 ký tự")
│   │   │         private String username;
│   │   │     
│   │   │         @NotBlank(message = "email không được để trống")
│   │   │         @Email(message = "email không hợp lệ")
│   │   │         @Size(max = 100, message = "email tối đa 100 ký tự")
│   │   │         private String email;
│   │   │     
│   │   │         @NotBlank(message = "password không được để trống")
│   │   │         @Size(min = 6, max = 100, message = "password 6-100 ký tự")
│   │   │         private String password;
│   │   │     }
│   │   │     
│   │   │   ---- END ----
│   │   ├── SetDefaultCurrencyRequest.java
│   │   │   ---- CODE ----
│   │   │     package com.retailmanagement.dto.request;
│   │   │     
│   │   │     public class SetDefaultCurrencyRequest {
│   │   │         private String currencyCode;
│   │   │     
│   │   │         public String getCurrencyCode() { return currencyCode; }
│   │   │         public void setCurrencyCode(String currencyCode) { this.currencyCode = currencyCode; }
│   │   │     }
│   │   │     
│   │   │   ---- END ----
│   │   ├── UpdateOrderRequest.java
│   │   │   ---- CODE ----
│   │   │     package com.retailmanagement.dto.request;
│   │   │     
│   │   │     import lombok.Data;
│   │   │     
│   │   │     @Data
│   │   │     public class UpdateOrderRequest {
│   │   │         private String paymentMethod;
│   │   │         private String notes;
│   │   │     }
│   │   │     
│   │   │     
│   │   │   ---- END ----
│   │   ├── UpdateUserRequest.java
│   │   │   ---- CODE ----
│   │   │     package com.retailmanagement.dto.request;
│   │   │     
│   │   │     import jakarta.validation.constraints.Email;
│   │   │     import jakarta.validation.constraints.NotBlank;
│   │   │     import jakarta.validation.constraints.Size;
│   │   │     import lombok.AllArgsConstructor;
│   │   │     import lombok.Builder;
│   │   │     import lombok.Data;
│   │   │     import lombok.NoArgsConstructor;
│   │   │     
│   │   │     @Data
│   │   │     @NoArgsConstructor
│   │   │     @AllArgsConstructor
│   │   │     @Builder
│   │   │     public class UpdateUserRequest {
│   │   │         // Không có password vì tách riêng update password
│   │   │         @NotBlank(message = "Username không được để trống")
│   │   │         @Size(max = 50, message = "Username tối đa 50 ký tự")
│   │   │         private String username;
│   │   │     
│   │   │         @NotBlank(message = "Email không được để trống")
│   │   │         @Email(message = "Email không đúng định dạng")
│   │   │         private String email;
│   │   │     
│   │   │         private String role; //Chỉ được nhập ADMIN,SALES,INVENTORY,CUSTOMER
│   │   │     }
│   │   │     
│   │   │   ---- END ----
│   │   └── UpsertPriceRequest.java
│   │       ---- CODE ----
│   │         package com.retailmanagement.dto.request;
│   │         
│   │         import java.math.BigDecimal;
│   │         import lombok.Getter;
│   │         import lombok.Setter;
│   │         
│   │         @Getter
│   │         @Setter
│   │         public class UpsertPriceRequest {
│   │         
│   │             private String currencyCode;   // null -> dùng DEFAULT_CURRENCY
│   │             private BigDecimal price;
│   │             private BigDecimal costPrice;
│   │             private String reason;          // MANUAL / PROMO ...
│   │         }
│   │         
│   │       ---- END ----
│   └── response
│       ├── ApiResponse.java
│       │   ---- CODE ----
│       │     package com.retailmanagement.dto.response;
│       │     
│       │     import lombok.AllArgsConstructor;
│       │     import lombok.Data;
│       │     import lombok.NoArgsConstructor;
│       │     
│       │     @Data
│       │     @NoArgsConstructor
│       │     @AllArgsConstructor
│       │     public class ApiResponse<T> {
│       │     
│       │         private boolean success;
│       │         private String message;
│       │         private T data;
│       │     
│       │         public static <T> ApiResponse<T> success(T data) {
│       │             return new ApiResponse<>(true, "Success", data);
│       │         }
│       │     
│       │         public static <T> ApiResponse<T> success(String message, T data) {
│       │             return new ApiResponse<>(true, message, data);
│       │         }
│       │     
│       │         public static <T> ApiResponse<T> error(String message) {
│       │             return new ApiResponse<>(false, message, null);
│       │         }
│       │     
│       │         public static <T> ApiResponse<T> error(String message, T data) {
│       │             return new ApiResponse<>(false, message, data);
│       │         }
│       │     }
│       │     
│       │   ---- END ----
│       ├── AuthResponse.java
│       │   ---- CODE ----
│       │     package com.retailmanagement.dto.response;
│       │     
│       │     import lombok.AllArgsConstructor;
│       │     import lombok.Builder;
│       │     import lombok.Data;
│       │     import lombok.NoArgsConstructor;
│       │     
│       │     @Data
│       │     @NoArgsConstructor
│       │     @AllArgsConstructor
│       │     @Builder
│       │     public class AuthResponse {
│       │         private String token;
│       │         private long expiresIn;
│       │         private UserResponse user;
│       │     }
│       │     
│       │   ---- END ----
│       ├── CategoryResponse.java
│       │   ---- CODE ----
│       │     package com.retailmanagement.dto.response;
│       │     
│       │     import lombok.AllArgsConstructor;
│       │     import lombok.Builder;
│       │     import lombok.Data;
│       │     import lombok.NoArgsConstructor;
│       │     
│       │     @Data
│       │     @NoArgsConstructor
│       │     @AllArgsConstructor
│       │     @Builder
│       │     public class CategoryResponse {
│       │         private Integer id;
│       │         private String name;
│       │         private String description;
│       │         private String imageUrl;
│       │         private Integer parentId;
│       │         private Integer displayOrder;
│       │         private Boolean isActive;
│       │     }
│       │     
│       │   ---- END ----
│       ├── CreateOrderResponse.java
│       │   ---- CODE ----
│       │     package com.retailmanagement.dto.response;
│       │     
│       │     import lombok.AllArgsConstructor;
│       │     import lombok.Data;
│       │     
│       │     import java.math.BigDecimal;
│       │     import java.time.Instant;
│       │     import java.util.List;
│       │     
│       │     @Data
│       │     @AllArgsConstructor
│       │     public class CreateOrderResponse {
│       │     
│       │         private Long orderId;
│       │         private String orderNumber;
│       │         private String status;
│       │         private String paymentStatus;
│       │     
│       │         // Customer (flatten)
│       │         private Integer customerId;
│       │         private String customerName;
│       │     
│       │         // Staff (flatten)
│       │         private Integer staffId;
│       │         private String staffUsername;
│       │     
│       │         // Amounts
│       │         private BigDecimal subtotal;
│       │         private BigDecimal discountTotal;
│       │         private BigDecimal taxTotal;
│       │         private BigDecimal shippingFee;
│       │         private BigDecimal totalAmount;
│       │     
│       │         private Instant createdAt;
│       │     
│       │         // Items (list đơn giản)
│       │         private List<Item> items;
│       │     
│       │         @Data
│       │         @AllArgsConstructor
│       │         public static class Item {
│       │             private String productName;
│       │             private String variantName;
│       │             private String sku;
│       │             private Integer quantity;
│       │             private BigDecimal unitPrice;
│       │             private BigDecimal discount;
│       │             private BigDecimal lineTotal;
│       │         }
│       │     }
│       │     
│       │     
│       │     
│       │   ---- END ----
│       ├── CustomerResponse.java
│       │   ---- CODE ----
│       │     package com.retailmanagement.dto.response;
│       │     
│       │     
│       │     import com.retailmanagement.entity.*;
│       │     import lombok.*;
│       │     
│       │     import java.math.BigDecimal;
│       │     import java.time.LocalDate;
│       │     import java.time.LocalDateTime;
│       │     
│       │     @Data
│       │     @NoArgsConstructor
│       │     @AllArgsConstructor
│       │     @Builder
│       │     public class CustomerResponse {
│       │         private Integer id; // MATCH với entity: Integer id (không phải Long customerId)
│       │     
│       │         private String name; // MATCH với entity: name (không phải fullName)
│       │     
│       │         private String email;
│       │     
│       │         private String phone;
│       │     
│       │         private LocalDate dateOfBirth; // MATCH với entity: dateOfBirth (không phải birthDate)
│       │     
│       │         private CustomerType customerType;
│       │         private String customerTypeDisplay;
│       │     
│       │         private VipTier vipTier; // Thêm vipTier
│       │         private String vipTierDisplay;
│       │     
│       │         private Integer loyaltyPoints; // Thêm loyaltyPoints
│       │         private Integer pointsToNextTier; // Điểm cần để lên hạng
│       │         private Double discountRate; // % giảm giá
│       │     
│       │         private BigDecimal totalSpent; // Thêm totalSpent
│       │         private LocalDateTime lastOrderAt; // Thêm lastOrderAt
│       │         private String address; // Thêm address
│       │         private String notes; // MATCH với entity: notes (không phải note)
│       │         private String segmentsJson; // Thêm segmentsJson
│       │         private Boolean isActive;
│       │         private LocalDateTime createdAt;
│       │         private LocalDateTime updatedAt;
│       │     }
│       │   ---- END ----
│       ├── OrderDetailResponse.java
│       │   ---- CODE ----
│       │     package com.retailmanagement.dto.response;
│       │     
│       │     import lombok.AllArgsConstructor;
│       │     import lombok.Data;
│       │     
│       │     import java.math.BigDecimal;
│       │     import java.time.Instant;
│       │     import java.util.List;
│       │     
│       │     @Data
│       │     @AllArgsConstructor
│       │     public class OrderDetailResponse {
│       │     
│       │         private Long orderId;
│       │         private String orderNumber;
│       │         private String status;
│       │         private String paymentStatus;
│       │     
│       │         private Integer customerId;
│       │         private String customerName;
│       │     
│       │         private Integer staffId;
│       │         private String staffUsername;
│       │     
│       │         private BigDecimal subtotal;
│       │         private BigDecimal discountTotal;
│       │         private BigDecimal taxTotal;
│       │         private BigDecimal shippingFee;
│       │         private BigDecimal totalAmount;
│       │     
│       │         private Instant createdAt;
│       │     
│       │         private List<CreateOrderResponse.Item> items;
│       │     }
│       │     
│       │     
│       │   ---- END ----
│       ├── OrderListResponse.java
│       │   ---- CODE ----
│       │     package com.retailmanagement.dto.response;
│       │     
│       │     import lombok.AllArgsConstructor;
│       │     import lombok.Data;
│       │     
│       │     import java.math.BigDecimal;
│       │     import java.time.Instant;
│       │     
│       │     
│       │     @Data
│       │     @AllArgsConstructor
│       │     public class OrderListResponse {
│       │     
│       │         private Long orderId;
│       │         private String orderNumber;
│       │     
│       │         private String customerName;
│       │         private String staffName;
│       │     
│       │         private BigDecimal totalAmount;
│       │         private String status;
│       │         private String paymentStatus;
│       │     
│       │         private Instant createdAt;
│       │     }
│       │     
│       │     
│       │   ---- END ----
│       ├── ProductResponse.java
│       │   ---- CODE ----
│       │     package com.retailmanagement.dto.response;
│       │     
│       │     import lombok.Data;
│       │     
│       │     import java.math.BigDecimal;
│       │     import java.time.LocalDateTime;
│       │     
│       │     @Data
│       │     public class ProductResponse {
│       │         private Integer id;
│       │         private String name;
│       │         private String sku;
│       │         private String description;
│       │         private Boolean isVisible;
│       │         private String imageUrl;
│       │         private LocalDateTime createdAt;
│       │     
│       │         // ✅ Added for "Display current price in product list"
│       │         // We return the MIN current price among variants (common storefront behavior).
│       │         private BigDecimal minPrice;
│       │         private String currencyCode;
│       │     }
│       │     
│       │   ---- END ----
│       ├── UserResponse.java
│       │   ---- CODE ----
│       │     package com.retailmanagement.dto.response;
│       │     
│       │     import lombok.AllArgsConstructor;
│       │     import lombok.Builder;
│       │     import lombok.Data;
│       │     import lombok.NoArgsConstructor;
│       │     
│       │     import java.time.LocalDateTime;
│       │     
│       │     @Data
│       │     @NoArgsConstructor
│       │     @AllArgsConstructor
│       │     @Builder
│       │     public class UserResponse {
│       │         private Integer id;
│       │         private String username;
│       │         private String email;
│       │         private String role;
│       │         private Boolean isActive;
│       │         private LocalDateTime createdAt;
│       │         private LocalDateTime updatedAt;
│       │     }
│       │     
│       │   ---- END ----
│       └── VariantPriceResponse.java
│           ---- CODE ----
│             package com.retailmanagement.dto.response;
│             
│             import lombok.Data;
│             
│             import java.math.BigDecimal;
│             
│             @Data
│             public class VariantPriceResponse {
│             
│                 private Integer variantId;
│                 private Integer productId;
│                 private String variantName;
│                 private String sku;
│             
│                 private String currencyCode;
│                 private BigDecimal price;
│                 private BigDecimal costPrice;
│             
│                 // promo
│                 private String promotionCode;
│                 private BigDecimal finalPrice;
│             }
│             
│           ---- END ----
├── entity
│   ├── BaseEntity.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.Column;
│   │     import jakarta.persistence.EntityListeners;
│   │     import jakarta.persistence.MappedSuperclass;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.springframework.data.annotation.CreatedDate;
│   │     import org.springframework.data.annotation.LastModifiedDate;
│   │     import org.springframework.data.jpa.domain.support.AuditingEntityListener;
│   │     
│   │     import java.time.LocalDateTime;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @MappedSuperclass
│   │     @EntityListeners(AuditingEntityListener.class)
│   │     
│   │     public abstract class BaseEntity {
│   │         @CreatedDate
│   │         @Column(name = "CreatedAt", nullable = false, updatable = false)
│   │         private LocalDateTime createdAt;
│   │     
│   │         @LastModifiedDate
│   │         @Column(name = "UpdatedAt")
│   │         private LocalDateTime updatedAt;
│   │     }
│   │     
│   │   ---- END ----
│   ├── Category.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import jakarta.validation.constraints.NotNull;
│   │     import jakarta.validation.constraints.Size;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.ColumnDefault;
│   │     import org.hibernate.annotations.Nationalized;
│   │     
│   │     import java.time.Instant;
│   │     import java.util.LinkedHashSet;
│   │     import java.util.Set;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @Entity
│   │     @Table(name = "categories")
│   │     public class Category {
│   │     
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         @Column(name = "id", nullable = false)
│   │         private Integer id;
│   │     
│   │         @Size(max = 150)
│   │         @NotNull
│   │         @Nationalized
│   │         @Column(name = "name", nullable = false, length = 150)
│   │         private String name;
│   │     
│   │         @Size(max = 500)
│   │         @Nationalized
│   │         @Column(name = "description", length = 500)
│   │         private String description;
│   │     
│   │         @Size(max = 500)
│   │         @Nationalized
│   │         @Column(name = "image_url", length = 500)
│   │         private String imageUrl;
│   │     
│   │         @ManyToOne(fetch = FetchType.LAZY)
│   │         @JoinColumn(name = "parent_id")
│   │         private Category parent;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("0")
│   │         @Column(name = "display_order", nullable = false)
│   │         private Integer displayOrder;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("1")
│   │         @Column(name = "is_active", nullable = false)
│   │         private Boolean isActive = true;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "created_at", nullable = false)
│   │         private Instant createdAt;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "updated_at", nullable = false)
│   │         private Instant updatedAt;
│   │     
│   │         @OneToMany(mappedBy = "parent")
│   │         private Set<Category> categories = new LinkedHashSet<>();
│   │     
│   │         @OneToMany(mappedBy = "category")
│   │         private Set<ProductCategory> productCategories = new LinkedHashSet<>();
│   │     
│   │         @PrePersist
│   │         void prePersist() {
│   │             Instant now = Instant.now();
│   │             if (createdAt == null) createdAt = now;
│   │             if (updatedAt == null) updatedAt = now;
│   │             if (isActive == null) isActive = true;
│   │             if (displayOrder == null) displayOrder = 0;
│   │         }
│   │     
│   │         @PreUpdate
│   │         void preUpdate() {
│   │             updatedAt = Instant.now();
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   ├── Customer.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import lombok.*;
│   │     import org.hibernate.annotations.CreationTimestamp;
│   │     import org.hibernate.annotations.UpdateTimestamp;
│   │     
│   │     import java.math.BigDecimal;
│   │     import java.time.LocalDate;
│   │     import java.time.LocalDateTime;
│   │     
│   │     @Entity
│   │     @Table(name = "customers")
│   │     @Getter
│   │     @Setter
│   │     @NoArgsConstructor
│   │     @AllArgsConstructor
│   │     @Builder
│   │     public class Customer {
│   │     
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         @Column(name = "id")
│   │         private Integer id;
│   │     
│   │         @Column(name = "name", nullable = false, length = 150)
│   │         private String name;
│   │     
│   │         @Column(name = "email", length = 100)
│   │         private String email;
│   │     
│   │         @Column(name = "phone", length = 30)
│   │         private String phone;
│   │     
│   │         @Column(name = "date_of_birth")
│   │         private LocalDate dateOfBirth;
│   │     
│   │         @Enumerated(EnumType.STRING)
│   │         @Column(name = "customer_type", nullable = false, length = 20)
│   │         private CustomerType customerType = CustomerType.REGULAR;
│   │     
│   │         @Enumerated(EnumType.STRING)
│   │         @Column(name = "vip_tier", length = 30)
│   │         private VipTier vipTier; // NULL cho REGULAR, BRONZE+ cho VIP
│   │     
│   │         @Column(name = "segments_json", columnDefinition = "NVARCHAR(MAX)")
│   │         private String segmentsJson;
│   │     
│   │         @Column(name = "loyalty_points", nullable = false)
│   │         private Integer loyaltyPoints = 0;
│   │     
│   │         @Column(name = "total_spent", precision = 15, scale = 2)
│   │         private BigDecimal totalSpent = BigDecimal.ZERO;
│   │     
│   │         @Column(name = "last_order_at")
│   │         private LocalDateTime lastOrderAt;
│   │     
│   │         @Column(name = "address", length = 500)
│   │         private String address;
│   │     
│   │         @Column(name = "notes", columnDefinition = "NVARCHAR(MAX)")
│   │         private String notes;
│   │     
│   │         @Column(name = "is_active", nullable = false)
│   │         private Boolean isActive = true;
│   │     
│   │         @CreationTimestamp
│   │         @Column(name = "created_at", nullable = false, updatable = false)
│   │         private LocalDateTime createdAt;
│   │     
│   │         @UpdateTimestamp
│   │         @Column(name = "updated_at")
│   │         private LocalDateTime updatedAt;
│   │     }
│   │     
│   │   ---- END ----
│   ├── Customergroup.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     public class Customergroup {
│   │     }
│   │     
│   │   ---- END ----
│   ├── CustomerType.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import com.fasterxml.jackson.annotation.JsonCreator;
│   │     import lombok.Getter;
│   │     
│   │     @Getter
│   │     public enum CustomerType {
│   │         REGULAR("Khách hàng thường", 0),
│   │         VIP("Khách hàng VIP", 1);
│   │         private final String displayname;
│   │         private final int level;
│   │         CustomerType(String displayname, int level) {
│   │             this.displayname = displayname;
│   │             this.level = level;
│   │         }
│   │         public boolean isVip() {
│   │             return this == VIP;
│   │         }
│   │         public static CustomerType fromString(String value) {
│   │             if (value == null) {
│   │                 return REGULAR;
│   │             }
│   │             try {
│   │                 return CustomerType.valueOf(value.toUpperCase());
│   │             } catch (IllegalArgumentException e) {
│   │                 return REGULAR;
│   │             }
│   │         }
│   │         public static CustomerType fromDisplayName(String displayname) {
│   │             for (CustomerType type : CustomerType.values()) {
│   │                 if (type.displayname.equalsIgnoreCase(displayname)) {
│   │                     return type;
│   │                 }
│   │             }
│   │             return REGULAR;
│   │         }
│   │         @JsonCreator
│   │         public static CustomerType fromJson(String value) {
│   │             if (value == null) return REGULAR;
│   │             return CustomerType.valueOf(value.trim().toUpperCase());
│   │         }
│   │     
│   │     }
│   │     
│   │   ---- END ----
│   ├── Image.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import jakarta.validation.constraints.NotNull;
│   │     import jakarta.validation.constraints.Size;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.ColumnDefault;
│   │     import org.hibernate.annotations.Nationalized;
│   │     
│   │     import java.time.Instant;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @Entity
│   │     @Table(name = "images")
│   │     public class Image {
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         @Column(name = "id", nullable = false)
│   │         private Long id;
│   │     
│   │         @ManyToOne(fetch = FetchType.LAZY)
│   │         @JoinColumn(name = "product_id")
│   │         private Product product;
│   │     
│   │         @ManyToOne(fetch = FetchType.LAZY)
│   │         @JoinColumn(name = "variant_id")
│   │         private ProductVariant variant;
│   │     
│   │         @Size(max = 800)
│   │         @NotNull
│   │         @Nationalized
│   │         @Column(name = "url", nullable = false, length = 800)
│   │         private String url;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("0")
│   │         @Column(name = "is_primary", nullable = false)
│   │         private Boolean isPrimary = false;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("0")
│   │         @Column(name = "sort_order", nullable = false)
│   │         private Integer sortOrder;
│   │     
│   │         @Size(max = 200)
│   │         @Nationalized
│   │         @Column(name = "alt_text", length = 200)
│   │         private String altText;
│   │     
│   │         @Nationalized
│   │         @Lob
│   │         @Column(name = "meta_json")
│   │         private String metaJson;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "created_at", nullable = false)
│   │         private Instant createdAt;
│   │     
│   │     }
│   │   ---- END ----
│   ├── Order.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import jakarta.validation.constraints.NotNull;
│   │     import jakarta.validation.constraints.Size;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.ColumnDefault;
│   │     import org.hibernate.annotations.Nationalized;
│   │     import org.hibernate.annotations.OnDelete;
│   │     import org.hibernate.annotations.OnDeleteAction;
│   │     
│   │     import java.math.BigDecimal;
│   │     import java.time.Instant;
│   │     import java.util.LinkedHashSet;
│   │     import java.util.Set;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @Entity
│   │     @Table(name = "orders")
│   │     public class Order {
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         @Column(name = "id", nullable = false)
│   │         private Long id;
│   │     
│   │         @Size(max = 40)
│   │         @NotNull
│   │         @Nationalized
│   │         @ColumnDefault("concat(N'ORD-', CONVERT([char](8), sysdatetime(), 112), N'-', right(N'000000'+CONVERT([varchar](20), NEXT VALUE FOR [dbo].[order_seq]), 6))")
│   │         @Column(name = "order_number", nullable = false, length = 40)
│   │         private String orderNumber;
│   │     
│   │         @ManyToOne(fetch = FetchType.LAZY)
│   │         @OnDelete(action = OnDeleteAction.SET_NULL)
│   │         @JoinColumn(name = "customer_id")
│   │         private Customer customer;
│   │     
│   │         @ManyToOne(fetch = FetchType.LAZY)
│   │         @OnDelete(action = OnDeleteAction.SET_NULL)
│   │         @JoinColumn(name = "user_id")
│   │         private User user;
│   │     
│   │         @Size(max = 20)
│   │         @NotNull
│   │         @Nationalized
│   │         @ColumnDefault("'OFFLINE'")
│   │         @Column(name = "channel", nullable = false, length = 20)
│   │         private String channel;
│   │     
│   │         @Size(max = 30)
│   │         @NotNull
│   │         @Nationalized
│   │         @ColumnDefault("'PENDING'")
│   │         @Column(name = "status", nullable = false, length = 30)
│   │         private String status;
│   │     
│   │         @Size(max = 50)
│   │         @Nationalized
│   │         @Column(name = "payment_method", length = 50)
│   │         private String paymentMethod;
│   │     
│   │         @Size(max = 20)
│   │         @NotNull
│   │         @Nationalized
│   │         @ColumnDefault("'UNPAID'")
│   │         @Column(name = "payment_status", nullable = false, length = 20)
│   │         private String paymentStatus;
│   │     
│   │         @Size(max = 500)
│   │         @Nationalized
│   │         @Column(name = "shipping_address", length = 500)
│   │         private String shippingAddress;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("0")
│   │         @Column(name = "shipping_fee", nullable = false, precision = 12, scale = 2)
│   │         private BigDecimal shippingFee;
│   │     
│   │         @Size(max = 30)
│   │         @Nationalized
│   │         @Column(name = "shipping_status", length = 30)
│   │         private String shippingStatus;
│   │     
│   │         @Size(max = 100)
│   │         @Nationalized
│   │         @Column(name = "tracking_code", length = 100)
│   │         private String trackingCode;
│   │     
│   │         @Column(name = "paid_at")
│   │         private Instant paidAt;
│   │     
│   │         @Column(name = "shipped_at")
│   │         private Instant shippedAt;
│   │     
│   │         @Column(name = "delivered_at")
│   │         private Instant deliveredAt;
│   │     
│   │         @Column(name = "cancelled_at")
│   │         private Instant cancelledAt;
│   │     
│   │         @Column(name = "returned_at")
│   │         private Instant returnedAt;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("0")
│   │         @Column(name = "subtotal", nullable = false, precision = 15, scale = 2)
│   │         private BigDecimal subtotal;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("0")
│   │         @Column(name = "discount_total", nullable = false, precision = 15, scale = 2)
│   │         private BigDecimal discountTotal;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("0")
│   │         @Column(name = "tax_total", nullable = false, precision = 15, scale = 2)
│   │         private BigDecimal taxTotal;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("0")
│   │         @Column(name = "total_amount", nullable = false, precision = 15, scale = 2)
│   │         private BigDecimal totalAmount;
│   │     
│   │         @Size(max = 50)
│   │         @Nationalized
│   │         @Column(name = "applied_promotion_code", length = 50)
│   │         private String appliedPromotionCode;
│   │     
│   │         @Nationalized
│   │         @Lob
│   │         @Column(name = "applied_promotion_json")
│   │         private String appliedPromotionJson;
│   │     
│   │         @Nationalized
│   │         @Lob
│   │         @Column(name = "notes")
│   │         private String notes;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "created_at", nullable = false)
│   │         private Instant createdAt;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "updated_at", nullable = false)
│   │         private Instant updatedAt;
│   │     
│   │         @OneToMany(mappedBy = "order")
│   │         private Set<OrderItem> orderItems = new LinkedHashSet<>();
│   │     
│   │         @OneToMany(mappedBy = "order")
│   │         private Set<Payment> payments = new LinkedHashSet<>();
│   │     
│   │         @OneToMany(mappedBy = "order")
│   │         private Set<Return> returns = new LinkedHashSet<>();
│   │     
│   │     }
│   │   ---- END ----
│   ├── OrderItem.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import jakarta.validation.constraints.NotNull;
│   │     import jakarta.validation.constraints.Size;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.ColumnDefault;
│   │     import org.hibernate.annotations.Nationalized;
│   │     
│   │     import java.math.BigDecimal;
│   │     import java.time.Instant;
│   │     import java.util.LinkedHashSet;
│   │     import java.util.Set;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @Entity
│   │     @Table(name = "order_items")
│   │     public class OrderItem {
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         @Column(name = "id", nullable = false)
│   │         private Long id;
│   │     
│   │         @NotNull
│   │         @ManyToOne(fetch = FetchType.LAZY, optional = false)
│   │         @JoinColumn(name = "order_id", nullable = false)
│   │         private Order order;
│   │     
│   │         @ManyToOne(fetch = FetchType.LAZY)
│   │         @JoinColumn(name = "variant_id")
│   │         private ProductVariant variant;
│   │     
│   │         @ManyToOne(fetch = FetchType.LAZY)
│   │         @JoinColumn(name = "product_id")
│   │         private Product product;
│   │     
│   │         @Size(max = 200)
│   │         @NotNull
│   │         @Nationalized
│   │         @Column(name = "product_name", nullable = false, length = 200)
│   │         private String productName;
│   │     
│   │         @Size(max = 150)
│   │         @Nationalized
│   │         @Column(name = "variant_name", length = 150)
│   │         private String variantName;
│   │     
│   │         @Size(max = 100)
│   │         @Nationalized
│   │         @Column(name = "sku", length = 100)
│   │         private String sku;
│   │     
│   │         @NotNull
│   │         @Column(name = "quantity", nullable = false)
│   │         private Integer quantity;
│   │     
│   │         @NotNull
│   │         @Column(name = "unit_price", nullable = false, precision = 12, scale = 2)
│   │         private BigDecimal unitPrice;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("0")
│   │         @Column(name = "discount", nullable = false, precision = 12, scale = 2)
│   │         private BigDecimal discount;
│   │     
│   │         @NotNull
│   │         @Column(name = "line_total", nullable = false, precision = 15, scale = 2)
│   │         private BigDecimal lineTotal;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "created_at", nullable = false)
│   │         private Instant createdAt;
│   │     
│   │         @OneToMany(mappedBy = "orderItem")
│   │         private Set<Return> returns = new LinkedHashSet<>();
│   │     
│   │     }
│   │   ---- END ----
│   ├── Payment.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import jakarta.validation.constraints.NotNull;
│   │     import jakarta.validation.constraints.Size;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.ColumnDefault;
│   │     import org.hibernate.annotations.Nationalized;
│   │     import org.hibernate.annotations.OnDelete;
│   │     import org.hibernate.annotations.OnDeleteAction;
│   │     
│   │     import java.math.BigDecimal;
│   │     import java.time.Instant;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @Entity
│   │     @Table(name = "payments")
│   │     public class Payment {
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         @Column(name = "id", nullable = false)
│   │         private Long id;
│   │     
│   │         @NotNull
│   │         @ManyToOne(fetch = FetchType.LAZY, optional = false)
│   │         @OnDelete(action = OnDeleteAction.CASCADE)
│   │         @JoinColumn(name = "order_id", nullable = false)
│   │         private Order order;
│   │     
│   │         @NotNull
│   │         @Column(name = "amount", nullable = false, precision = 15, scale = 2)
│   │         private BigDecimal amount;
│   │     
│   │         @Size(max = 50)
│   │         @NotNull
│   │         @Nationalized
│   │         @Column(name = "method", nullable = false, length = 50)
│   │         private String method;
│   │     
│   │         @Size(max = 100)
│   │         @Nationalized
│   │         @Column(name = "transaction_ref", length = 100)
│   │         private String transactionRef;
│   │     
│   │         @Size(max = 20)
│   │         @NotNull
│   │         @Nationalized
│   │         @ColumnDefault("'PENDING'")
│   │         @Column(name = "status", nullable = false, length = 20)
│   │         private String status;
│   │     
│   │         @Column(name = "paid_at")
│   │         private Instant paidAt;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "created_at", nullable = false)
│   │         private Instant createdAt;
│   │     
│   │     }
│   │   ---- END ----
│   ├── PriceHistory.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import jakarta.validation.constraints.NotNull;
│   │     import jakarta.validation.constraints.Size;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.ColumnDefault;
│   │     import org.hibernate.annotations.Nationalized;
│   │     import org.hibernate.annotations.OnDelete;
│   │     import org.hibernate.annotations.OnDeleteAction;
│   │     
│   │     import java.math.BigDecimal;
│   │     import java.time.Instant;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @Entity
│   │     @Table(name = "price_history")
│   │     public class PriceHistory {
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         @Column(name = "id", nullable = false)
│   │         private Long id;
│   │     
│   │         @NotNull
│   │         @ManyToOne(fetch = FetchType.LAZY, optional = false)
│   │         @OnDelete(action = OnDeleteAction.CASCADE)
│   │         @JoinColumn(name = "variant_id", nullable = false)
│   │         private ProductVariant variant;
│   │     
│   │         @Size(max = 3)
│   │         @NotNull
│   │         @ColumnDefault("'VND'")
│   │         @Column(name = "currency_code", nullable = false, length = 3)
│   │         private String currencyCode;
│   │     
│   │         @NotNull
│   │         @Column(name = "price", nullable = false, precision = 12, scale = 2)
│   │         private BigDecimal price;
│   │     
│   │         @Column(name = "cost_price", precision = 12, scale = 2)
│   │         private BigDecimal costPrice;
│   │     
│   │         @Size(max = 200)
│   │         @Nationalized
│   │         @Column(name = "reason", length = 200)
│   │         private String reason;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "effective_from", nullable = false)
│   │         private Instant effectiveFrom;
│   │     
│   │         @Column(name = "effective_to")
│   │         private Instant effectiveTo;
│   │     
│   │         @ManyToOne(fetch = FetchType.LAZY)
│   │         @OnDelete(action = OnDeleteAction.SET_NULL)
│   │         @JoinColumn(name = "created_by")
│   │         private User createdBy;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "created_at", nullable = false)
│   │         private Instant createdAt;
│   │     
│   │     }
│   │   ---- END ----
│   ├── Product.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.Column;
│   │     import jakarta.persistence.Entity;
│   │     import jakarta.persistence.GeneratedValue;
│   │     import jakarta.persistence.GenerationType;
│   │     import jakarta.persistence.Id;
│   │     import jakarta.persistence.Table;
│   │     import lombok.Getter;
│   │     import lombok.NoArgsConstructor;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.CreationTimestamp;
│   │     import org.hibernate.annotations.UpdateTimestamp;
│   │     
│   │     import java.time.LocalDateTime;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @NoArgsConstructor
│   │     @Entity
│   │     @Table(name = "products")
│   │     public class Product {
│   │     
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         private Integer id;
│   │     
│   │         @Column(nullable = false, length = 200)
│   │         private String name;
│   │     
│   │         @Column(nullable = false, unique = true, length = 100)
│   │         private String sku;
│   │     
│   │         @Column(columnDefinition = "NVARCHAR(MAX)")
│   │         private String description;
│   │     
│   │         @Column(name = "is_visible", nullable = false)
│   │         private Boolean isVisible = true;
│   │     
│   │         @CreationTimestamp
│   │         @Column(name = "created_at", updatable = false)
│   │         private LocalDateTime createdAt;
│   │     
│   │         @UpdateTimestamp
│   │         @Column(name = "updated_at")
│   │         private LocalDateTime updatedAt;
│   │     }
│   │     
│   │   ---- END ----
│   ├── ProductCategory.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import jakarta.validation.constraints.NotNull;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.ColumnDefault;
│   │     
│   │     import java.time.Instant;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @Entity
│   │     @Table(name = "product_categories")
│   │     public class ProductCategory {
│   │         @EmbeddedId
│   │         private ProductCategoryId id;
│   │     
│   │         @MapsId("categoryId")
│   │         @ManyToOne(fetch = FetchType.LAZY, optional = false)
│   │         @JoinColumn(name = "category_id", nullable = false)
│   │         private Category category;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("0")
│   │         @Column(name = "is_primary", nullable = false)
│   │         private Boolean isPrimary = false;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "created_at", nullable = false)
│   │         private Instant createdAt;
│   │     
│   │     }
│   │   ---- END ----
│   ├── ProductCategoryId.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.Column;
│   │     import jakarta.persistence.Embeddable;
│   │     import lombok.*;
│   │     
│   │     import java.io.Serializable;
│   │     
│   │     @Data
│   │     @NoArgsConstructor
│   │     @AllArgsConstructor
│   │     @Embeddable
│   │     public class ProductCategoryId implements Serializable {
│   │         private static final long serialVersionUID = 6105819806365181834L;
│   │     
│   │         @Column(name = "product_id")
│   │         private Integer productId;
│   │     
│   │         @Column(name = "category_id")
│   │         private Integer categoryId;
│   │     
│   │     
│   │     }
│   │   ---- END ----
│   ├── ProductTag.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import jakarta.validation.constraints.NotNull;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.ColumnDefault;
│   │     
│   │     import java.time.Instant;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @Entity
│   │     @Table(name = "product_tags")
│   │     public class ProductTag {
│   │         @EmbeddedId
│   │         private ProductTagId id;
│   │     
│   │         @MapsId("productId")
│   │         @ManyToOne(fetch = FetchType.LAZY, optional = false)
│   │         @JoinColumn(name = "product_id", nullable = false)
│   │         private Product product;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "created_at", nullable = false)
│   │         private Instant createdAt;
│   │     
│   │     }
│   │   ---- END ----
│   ├── ProductTagId.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.Column;
│   │     import jakarta.persistence.Embeddable;
│   │     import jakarta.validation.constraints.NotNull;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.hibernate.Hibernate;
│   │     
│   │     import java.io.Serializable;
│   │     import java.util.Objects;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @Embeddable
│   │     public class ProductTagId implements Serializable {
│   │         private static final long serialVersionUID = -4861170464523510247L;
│   │         @NotNull
│   │         @Column(name = "product_id", nullable = false)
│   │         private Integer productId;
│   │     
│   │         @NotNull
│   │         @Column(name = "tag_id", nullable = false)
│   │         private Integer tagId;
│   │     
│   │         @Override
│   │         public boolean equals(Object o) {
│   │             if (this == o) return true;
│   │             if (o == null || Hibernate.getClass(this) != Hibernate.getClass(o)) return false;
│   │             ProductTagId entity = (ProductTagId) o;
│   │             return Objects.equals(this.productId, entity.productId) &&
│   │                     Objects.equals(this.tagId, entity.tagId);
│   │         }
│   │     
│   │         @Override
│   │         public int hashCode() {
│   │             return Objects.hash(productId, tagId);
│   │         }
│   │     
│   │     }
│   │   ---- END ----
│   ├── ProductVariant.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import jakarta.validation.constraints.NotNull;
│   │     import jakarta.validation.constraints.Size;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.ColumnDefault;
│   │     import org.hibernate.annotations.Nationalized;
│   │     import org.hibernate.annotations.OnDelete;
│   │     import org.hibernate.annotations.OnDeleteAction;
│   │     
│   │     import java.math.BigDecimal;
│   │     import java.time.Instant;
│   │     import java.util.LinkedHashSet;
│   │     import java.util.Set;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @Entity
│   │     @Table(name = "product_variants")
│   │     public class ProductVariant {
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         @Column(name = "id", nullable = false)
│   │         private Integer id;
│   │     
│   │         @NotNull
│   │         @ManyToOne(fetch = FetchType.LAZY, optional = false)
│   │         @OnDelete(action = OnDeleteAction.CASCADE)
│   │         @JoinColumn(name = "product_id", nullable = false)
│   │         private Product product;
│   │     
│   │         @Size(max = 150)
│   │         @NotNull
│   │         @Nationalized
│   │         @Column(name = "variant_name", nullable = false, length = 150)
│   │         private String variantName;
│   │     
│   │         @Size(max = 100)
│   │         @NotNull
│   │         @Nationalized
│   │         @Column(name = "sku", nullable = false, length = 100)
│   │         private String sku;
│   │     
│   │         @Size(max = 100)
│   │         @Nationalized
│   │         @Column(name = "barcode", length = 100)
│   │         private String barcode;
│   │     
│   │         @Size(max = 3)
│   │         @NotNull
│   │         @ColumnDefault("'VND'")
│   │         @Column(name = "currency_code", nullable = false, length = 3)
│   │         private String currencyCode;
│   │     
│   │         @NotNull
│   │         @Column(name = "price", nullable = false, precision = 12, scale = 2)
│   │         private BigDecimal price;
│   │     
│   │         @Column(name = "cost_price", precision = 12, scale = 2)
│   │         private BigDecimal costPrice;
│   │     
│   │         @Nationalized
│   │         @Lob
│   │         @Column(name = "price_tiers_json")
│   │         private String priceTiersJson;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("0")
│   │         @Column(name = "stock_quantity", nullable = false)
│   │         private Integer stockQuantity;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("0")
│   │         @Column(name = "reserved_qty", nullable = false)
│   │         private Integer reservedQty;
│   │     
│   │         @Nationalized
│   │         @Lob
│   │         @Column(name = "attributes_json")
│   │         private String attributesJson;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("1")
│   │         @Column(name = "is_active", nullable = false)
│   │         private Boolean isActive = false;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "created_at", nullable = false)
│   │         private Instant createdAt;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "updated_at", nullable = false)
│   │         private Instant updatedAt;
│   │     
│   │         @Column(name = "deleted_at")
│   │         private Instant deletedAt;
│   │     
│   │         @OneToMany(mappedBy = "variant")
│   │         private Set<Image> images = new LinkedHashSet<>();
│   │     
│   │         @OneToMany(mappedBy = "variant")
│   │         private Set<OrderItem> orderItems = new LinkedHashSet<>();
│   │     
│   │         @OneToMany(mappedBy = "variant")
│   │         private Set<PriceHistory> priceHistories = new LinkedHashSet<>();
│   │     
│   │         @OneToMany(mappedBy = "variant")
│   │         private Set<StockTransaction> stockTransactions = new LinkedHashSet<>();
│   │     
│   │     }
│   │   ---- END ----
│   ├── Promotion.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import lombok.*;
│   │     
│   │     import java.math.BigDecimal;
│   │     import java.time.LocalDateTime;
│   │     
│   │     @Entity
│   │     @Table(name = "promotions")
│   │     @Data
│   │     @Builder
│   │     @NoArgsConstructor
│   │     @AllArgsConstructor
│   │     public class Promotion {
│   │     
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         private Integer id;
│   │     
│   │         @Column(nullable = false, unique = true, length = 50)
│   │         private String code;
│   │     
│   │         @Column(nullable = false, length = 150)
│   │         private String name;
│   │     
│   │         @Column(length = 500)
│   │         private String description;
│   │     
│   │         @Column(name = "discount_type", nullable = false, length = 20)
│   │         private String discountType; // PERCENT / AMOUNT
│   │     
│   │         @Column(name = "discount_value", nullable = false, precision = 12, scale = 2)
│   │         private BigDecimal discountValue;
│   │     
│   │         @Column(name = "min_order_amount", precision = 15, scale = 2)
│   │         private BigDecimal minOrderAmount;
│   │     
│   │         @Column(name = "applicability_json", columnDefinition = "NVARCHAR(MAX)")
│   │         private String applicabilityJson;
│   │     
│   │         @Column(name = "rules_json", columnDefinition = "NVARCHAR(MAX)")
│   │         private String rulesJson;
│   │     
│   │         @Builder.Default
│   │         @Column(nullable = false)
│   │         private Integer priority = 0;
│   │     
│   │         @Builder.Default
│   │         @Column(nullable = false)
│   │         private Boolean stackable = false;
│   │     
│   │         @Column(name = "start_date", nullable = false)
│   │         private LocalDateTime startDate;
│   │     
│   │         @Column(name = "end_date", nullable = false)
│   │         private LocalDateTime endDate;
│   │     
│   │         @Builder.Default
│   │         @Column(name = "is_active", nullable = false)
│   │         private Boolean isActive = true;
│   │     
│   │         @Column(name = "created_by")
│   │         private Integer createdBy;
│   │     
│   │         @Column(name = "created_at", nullable = false)
│   │         private LocalDateTime createdAt;
│   │     }
│   │     
│   │   ---- END ----
│   ├── Return.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import jakarta.validation.constraints.NotNull;
│   │     import jakarta.validation.constraints.Size;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.ColumnDefault;
│   │     import org.hibernate.annotations.Nationalized;
│   │     
│   │     import java.math.BigDecimal;
│   │     import java.time.Instant;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @Entity
│   │     @Table(name = "returns")
│   │     public class Return {
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         @Column(name = "id", nullable = false)
│   │         private Long id;
│   │     
│   │         @NotNull
│   │         @ManyToOne(fetch = FetchType.LAZY, optional = false)
│   │         @JoinColumn(name = "order_id", nullable = false)
│   │         private Order order;
│   │     
│   │         @NotNull
│   │         @Column(name = "quantity", nullable = false)
│   │         private Integer quantity;
│   │     
│   │         @Size(max = 500)
│   │         @Nationalized
│   │         @Column(name = "reason", length = 500)
│   │         private String reason;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("0")
│   │         @Column(name = "refund_amount", nullable = false, precision = 15, scale = 2)
│   │         private BigDecimal refundAmount;
│   │     
│   │         @Size(max = 50)
│   │         @Nationalized
│   │         @Column(name = "refund_method", length = 50)
│   │         private String refundMethod;
│   │     
│   │         @Size(max = 20)
│   │         @NotNull
│   │         @Nationalized
│   │         @ColumnDefault("'PENDING'")
│   │         @Column(name = "refund_status", nullable = false, length = 20)
│   │         private String refundStatus;
│   │     
│   │         @Column(name = "refunded_at")
│   │         private Instant refundedAt;
│   │     
│   │         @Size(max = 20)
│   │         @NotNull
│   │         @Nationalized
│   │         @ColumnDefault("'PENDING'")
│   │         @Column(name = "status", nullable = false, length = 20)
│   │         private String status;
│   │     
│   │         @Nationalized
│   │         @Lob
│   │         @Column(name = "note")
│   │         private String note;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "created_at", nullable = false)
│   │         private Instant createdAt;
│   │     
│   │         @NotNull
│   │         @ManyToOne(fetch = FetchType.LAZY, optional = false)
│   │         @JoinColumn(name = "order_item_id", nullable = false)
│   │         private OrderItem orderItem;
│   │     
│   │     }
│   │   ---- END ----
│   ├── Role.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     public enum Role {
│   │         ADMIN, SALES, INVENTORY, CUSTOMER
│   │     }
│   │     
│   │   ---- END ----
│   ├── StockTransaction.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import jakarta.validation.constraints.NotNull;
│   │     import jakarta.validation.constraints.Size;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.ColumnDefault;
│   │     import org.hibernate.annotations.Nationalized;
│   │     import org.hibernate.annotations.OnDelete;
│   │     import org.hibernate.annotations.OnDeleteAction;
│   │     
│   │     import java.time.Instant;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @Entity
│   │     @Table(name = "stock_transactions")
│   │     public class StockTransaction {
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         @Column(name = "id", nullable = false)
│   │         private Long id;
│   │     
│   │         @NotNull
│   │         @ManyToOne(fetch = FetchType.LAZY, optional = false)
│   │         @OnDelete(action = OnDeleteAction.CASCADE)
│   │         @JoinColumn(name = "variant_id", nullable = false)
│   │         private ProductVariant variant;
│   │     
│   │         @NotNull
│   │         @Column(name = "quantity", nullable = false)
│   │         private Integer quantity;
│   │     
│   │         @Size(max = 30)
│   │         @NotNull
│   │         @Nationalized
│   │         @Column(name = "type", nullable = false, length = 30)
│   │         private String type;
│   │     
│   │         @Size(max = 50)
│   │         @Nationalized
│   │         @Column(name = "reference_type", length = 50)
│   │         private String referenceType;
│   │     
│   │         @Column(name = "reference_id")
│   │         private Long referenceId;
│   │     
│   │         @Size(max = 500)
│   │         @Nationalized
│   │         @Column(name = "note", length = 500)
│   │         private String note;
│   │     
│   │         @ManyToOne(fetch = FetchType.LAZY)
│   │         @OnDelete(action = OnDeleteAction.SET_NULL)
│   │         @JoinColumn(name = "created_by")
│   │         private User createdBy;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "created_at", nullable = false)
│   │         private Instant createdAt;
│   │     
│   │     }
│   │   ---- END ----
│   ├── SystemSetting.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import java.time.LocalDateTime;
│   │     
│   │     @Entity
│   │     @Table(name = "system_settings")
│   │     public class SystemSetting {
│   │         @Id
│   │         @Column(name = "setting_key", length = 50)
│   │         private String key;
│   │     
│   │         @Column(name = "setting_value", nullable = false, length = 100)
│   │         private String value;
│   │     
│   │         @Column(name = "updated_at", nullable = false)
│   │         private LocalDateTime updatedAt;
│   │     
│   │         public String getKey() { return key; }
│   │         public void setKey(String key) { this.key = key; }
│   │         public String getValue() { return value; }
│   │         public void setValue(String value) { this.value = value; }
│   │         public LocalDateTime getUpdatedAt() { return updatedAt; }
│   │         public void setUpdatedAt(LocalDateTime updatedAt) { this.updatedAt = updatedAt; }
│   │     }
│   │     
│   │   ---- END ----
│   ├── Tag.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import jakarta.validation.constraints.NotNull;
│   │     import jakarta.validation.constraints.Size;
│   │     import lombok.Getter;
│   │     import lombok.Setter;
│   │     import org.hibernate.annotations.ColumnDefault;
│   │     import org.hibernate.annotations.Nationalized;
│   │     
│   │     import java.time.Instant;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @Entity
│   │     @Table(name = "tags")
│   │     public class Tag {
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         @Column(name = "id", nullable = false)
│   │         private Integer id;
│   │     
│   │         @Size(max = 80)
│   │         @NotNull
│   │         @Nationalized
│   │         @Column(name = "name", nullable = false, length = 80)
│   │         private String name;
│   │     
│   │         @Size(max = 30)
│   │         @NotNull
│   │         @Nationalized
│   │         @ColumnDefault("'GENERAL'")
│   │         @Column(name = "tag_type", nullable = false, length = 30)
│   │         private String tagType;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("1")
│   │         @Column(name = "is_active", nullable = false)
│   │         private Boolean isActive = false;
│   │     
│   │         @NotNull
│   │         @ColumnDefault("sysdatetime()")
│   │         @Column(name = "created_at", nullable = false)
│   │         private Instant createdAt;
│   │     
│   │     }
│   │   ---- END ----
│   ├── User.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.entity;
│   │     
│   │     import jakarta.persistence.*;
│   │     import lombok.*;
│   │     
│   │     import java.time.LocalDateTime;
│   │     
│   │     @Getter
│   │     @Setter
│   │     @NoArgsConstructor
│   │     @AllArgsConstructor
│   │     @Builder
│   │     @Entity
│   │     @Table(name = "users", schema = "dbo")
│   │     public class User {
│   │     
│   │         @Id
│   │         @GeneratedValue(strategy = GenerationType.IDENTITY)
│   │         private Integer id;
│   │     
│   │         @Column(nullable = false, unique = true, length = 50)
│   │         private String username;
│   │     
│   │         @Column(nullable = false, unique = true, length = 100)
│   │         private String email;
│   │     
│   │         @Column(name = "password_hash", nullable = false, length = 255)
│   │         private String passwordHash;
│   │     
│   │         /**
│   │          * Role hợp lệ: ADMIN, SALES, INVENTORY, CUSTOMER
│   │          */
│   │         @Column(nullable = false, length = 30)
│   │         private String role;
│   │     
│   │         @Column(name = "is_active", nullable = false)
│   │         private Boolean isActive;
│   │     
│   │         @Column(name = "created_at", nullable = false)
│   │         private LocalDateTime createdAt;
│   │     
│   │         @Column(name = "updated_at", nullable = false)
│   │         private LocalDateTime updatedAt;
│   │     
│   │         @PrePersist
│   │         public void prePersist() {
│   │             LocalDateTime now = LocalDateTime.now();
│   │             if (createdAt == null) createdAt = now;
│   │             if (updatedAt == null) updatedAt = now;
│   │             if (isActive == null) isActive = true;
│   │     
│   │             // mặc định theo schema
│   │             if (role == null || role.isBlank()) role = "CUSTOMER";
│   │         }
│   │     
│   │         @PreUpdate
│   │         public void preUpdate() {
│   │             updatedAt = LocalDateTime.now();
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   └── VipTier.java
│       ---- CODE ----
│         package com.retailmanagement.entity;
│         
│         
│         import lombok.Getter;
│         
│         @Getter
│         public enum VipTier {
│             BRONZE("BRONZE", 100, 499, 1.05),      // 100-499 điểm, giảm 5%
│             SILVER("SILVER", 500, 999, 1.10),       // 500-999 điểm, giảm 10%
│             GOLD("GOLD", 1000, 2499, 1.15),      // 1000-2499 điểm, giảm 15%
│             PLATINUM("PLATINUM", 2500, 4999, 1.20), // 2500-4999 điểm, giảm 20%
│             DIAMOND("DIAMOND", 5000, Integer.MAX_VALUE, 1.25); // 5000+ điểm, giảm 25%
│         
│             private final String displayName;
│             private final Integer minPoints;
│             private final Integer maxPoints;
│             private final Double discountMultiplier;
│         
│             VipTier(String displayName, Integer minPoints, Integer maxPoints, Double discountMultiplier) {
│                 this.displayName = displayName;
│                 this.minPoints = minPoints;
│                 this.maxPoints = maxPoints;
│                 this.discountMultiplier = discountMultiplier;
│             }
│         
│             // Tự động xác định tier dựa trên điểm
│             public static VipTier fromPoints(Integer points) {
│                 if (points == null || points < 100) {
│                     return null; // Khách thường
│                 }
│         
│                 for (VipTier tier : values()) {
│                     if (points >= tier.minPoints && points <= tier.maxPoints) {
│                         return tier;
│                     }
│                 }
│         
│                 return DIAMOND; // Mặc định cao nhất
│             }
│         
│             // Kiểm tra có thể nâng hạng không
│             public VipTier getNextTier() {
│                 VipTier[] tiers = values();
│                 int currentIndex = this.ordinal();
│                 if (currentIndex < tiers.length - 1) {
│                     return tiers[currentIndex + 1];
│                 }
│                 return null; // Đã max tier
│             }
│         
│             // Điểm cần để lên hạng tiếp theo
│             public Integer getPointsToNextTier() {
│                 VipTier next = getNextTier();
│                 return next != null ? next.minPoints : null;
│             }
│         }
│       ---- END ----
├── exception
│   ├── ErrorResponse.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.exception;
│   │     
│   │     import lombok.AllArgsConstructor;
│   │     import lombok.Data;
│   │     import lombok.NoArgsConstructor;
│   │     import java.time.LocalDateTime;
│   │     
│   │     @Data
│   │     @NoArgsConstructor
│   │     @AllArgsConstructor
│   │     public class ErrorResponse {
│   │         private int status;
│   │         private String message;
│   │         private LocalDateTime timestamp;
│   │     }
│   │     
│   │   ---- END ----
│   └── GlobalExceptionHandler.java
│       ---- CODE ----
│         package com.retailmanagement.exception;
│         
│         import com.retailmanagement.dto.response.ApiResponse;
│         import org.springframework.http.HttpStatus;
│         import org.springframework.http.ResponseEntity;
│         import org.springframework.validation.FieldError;
│         import org.springframework.web.bind.MethodArgumentNotValidException;
│         import org.springframework.web.bind.annotation.ExceptionHandler;
│         import org.springframework.web.bind.annotation.RestControllerAdvice;
│         
│         import java.io.IOException;
│         import java.util.HashMap;
│         import java.util.Map;
│         
│         @RestControllerAdvice
│         public class GlobalExceptionHandler {
│         
│             @ExceptionHandler(MethodArgumentNotValidException.class)
│             public ResponseEntity<ApiResponse<Map<String, String>>> handleValidationExceptions(MethodArgumentNotValidException ex) {
│                 Map<String, String> errors = new HashMap<>();
│                 ex.getBindingResult().getAllErrors().forEach(error -> {
│                     String fieldName = ((FieldError) error).getField();
│                     String errorMessage = error.getDefaultMessage();
│                     errors.put(fieldName, errorMessage);
│                 });
│         
│                 return ResponseEntity.status(HttpStatus.BAD_REQUEST)
│                         .body(ApiResponse.error("Dữ liệu không hợp lệ", errors));
│             }
│         
│             @ExceptionHandler(IOException.class)
│             public ResponseEntity<ApiResponse<Object>> handleIo(IOException ex) {
│                 return ResponseEntity.status(HttpStatus.BAD_REQUEST)
│                         .body(ApiResponse.error("Lỗi upload: " + ex.getMessage()));
│             }
│         
│             @ExceptionHandler(IllegalArgumentException.class)
│             public ResponseEntity<ApiResponse<Object>> handleIllegalArgument(IllegalArgumentException ex) {
│                 return ResponseEntity.status(HttpStatus.BAD_REQUEST)
│                         .body(ApiResponse.error(ex.getMessage()));
│             }
│         
│             @ExceptionHandler(RuntimeException.class)
│             public ResponseEntity<ApiResponse<Object>> handleRuntimeException(RuntimeException ex) {
│                 return ResponseEntity.status(HttpStatus.BAD_REQUEST)
│                         .body(ApiResponse.error(ex.getMessage()));
│             }
│         
│             @ExceptionHandler(Exception.class)
│             public ResponseEntity<ApiResponse<Object>> handleGeneralException(Exception ex) {
│                 return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
│                         .body(ApiResponse.error("Lỗi hệ thống: " + ex.getMessage()));
│             }
│         }
│         
│       ---- END ----
├── repository
│   ├── CategoryRepository.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.repository;
│   │     
│   │     import com.retailmanagement.entity.Category;
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     
│   │     import java.util.List;
│   │     
│   │     public interface CategoryRepository extends JpaRepository<Category, Integer> {
│   │         List<Category> findByIsActiveTrueOrderByDisplayOrderAscNameAsc();
│   │         List<Category> findAllByOrderByDisplayOrderAscNameAsc();
│   │     }
│   │     
│   │   ---- END ----
│   ├── CustomRes.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.repository;
│   │     
│   │     import com.retailmanagement.entity.Customer;
│   │     import com.retailmanagement.entity.CustomerType;
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     import org.springframework.stereotype.Repository;
│   │     
│   │     import java.util.List;
│   │     import java.util.Optional;
│   │     @Repository
│   │     public interface CustomRes extends JpaRepository<Customer, Integer> {
│   │         Optional<Customer> findByEmail(String Email);
│   │         Optional<Customer> findByPhone(String phone);
│   │         List<Customer> findAll();
│   │         List<Customer> findByCustomerType(CustomerType type);
│   │     }
│   │     
│   │   ---- END ----
│   ├── ImageRepository.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.repository;
│   │     
│   │     import com.retailmanagement.entity.Image;
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     import org.springframework.stereotype.Repository;
│   │     import java.util.Optional;
│   │     
│   │     @Repository
│   │     public interface ImageRepository extends JpaRepository<Image, Long> {
│   │         Optional<Image> findFirstByProductIdAndIsPrimaryTrue(Integer productId);
│   │     }
│   │   ---- END ----
│   ├── OrderItemRepository.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.repository;
│   │     
│   │     import com.retailmanagement.entity.OrderItem;
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     
│   │     public interface OrderItemRepository extends JpaRepository<OrderItem, Long> {
│   │     }
│   │     
│   │     
│   │   ---- END ----
│   ├── OrderRepository.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.repository;
│   │     
│   │     import com.retailmanagement.entity.Order;
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     
│   │     import java.time.Instant;
│   │     import java.util.List;
│   │     
│   │     public interface OrderRepository extends JpaRepository<Order, Long> {
│   │     
│   │         List<Order> findByStatusOrderByCreatedAtDesc(String status);
│   │     
│   │         List<Order> findByStatusInOrderByCreatedAtDesc(List<String> statuses);
│   │     
│   │         long countByCreatedAtBetween(Instant start, Instant end);
│   │     }
│   │     
│   │     
│   │   ---- END ----
│   ├── PriceHistoryRepository.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.repository;
│   │     
│   │     import com.retailmanagement.entity.PriceHistory;
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     
│   │     import java.util.List;
│   │     import java.util.Optional;
│   │     
│   │     public interface PriceHistoryRepository extends JpaRepository<PriceHistory, Long> {
│   │         List<PriceHistory> findByVariant_IdOrderByEffectiveFromDesc(Integer variantId);
│   │         Optional<PriceHistory> findFirstByVariant_IdAndEffectiveToIsNullOrderByEffectiveFromDesc(Integer variantId);
│   │     }
│   │     
│   │   ---- END ----
│   ├── ProductCategoryRepository.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.repository;
│   │     
│   │     import com.retailmanagement.entity.ProductCategory;
│   │     import com.retailmanagement.entity.ProductCategoryId;
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     import org.springframework.stereotype.Repository;
│   │     
│   │     @Repository
│   │     public interface ProductCategoryRepository extends JpaRepository<ProductCategory, ProductCategoryId> {
│   │     }
│   │   ---- END ----
│   ├── ProductRepository.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.repository;
│   │     
│   │     import com.retailmanagement.entity.Product;
│   │     import org.springframework.data.domain.Page;
│   │     import org.springframework.data.domain.Pageable;
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     import org.springframework.data.jpa.repository.Query;
│   │     import org.springframework.data.repository.query.Param;
│   │     
│   │     public interface ProductRepository extends JpaRepository<Product, Integer> {
│   │     
│   │         @Query(
│   │             value =
│   │                 "SELECT p.* FROM products p " +
│   │                 "INNER JOIN product_categories pc ON p.id = pc.product_id " +
│   │                 "WHERE pc.category_id = :categoryId " +
│   │                 "ORDER BY p.created_at DESC",
│   │             countQuery =
│   │                 "SELECT count(*) FROM products p " +
│   │                 "INNER JOIN product_categories pc ON p.id = pc.product_id " +
│   │                 "WHERE pc.category_id = :categoryId",
│   │             nativeQuery = true
│   │         )
│   │         Page<Product> findByCategoryId(@Param("categoryId") Integer categoryId, Pageable pageable);
│   │     }
│   │     
│   │   ---- END ----
│   ├── ProductVariantRepository.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.repository;
│   │     
│   │     import com.retailmanagement.entity.ProductVariant;
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     
│   │     import java.util.List;
│   │     
│   │     public interface ProductVariantRepository extends JpaRepository<ProductVariant, Integer> {
│   │         List<ProductVariant> findByProduct_Id(Integer productId);
│   │     }
│   │     
│   │   ---- END ----
│   ├── PromotionRepository.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.repository;
│   │     
│   │     import com.retailmanagement.entity.Promotion;
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     
│   │     import java.time.LocalDateTime;
│   │     import java.util.List;
│   │     import java.util.Optional;
│   │     
│   │     public interface PromotionRepository extends JpaRepository<Promotion, Integer> {
│   │         Optional<Promotion> findByCode(String code);
│   │     
│   │         List<Promotion> findByIsActiveTrueAndStartDateLessThanEqualAndEndDateGreaterThanEqual(
│   │                 LocalDateTime at1, LocalDateTime at2
│   │         );
│   │     
│   │         List<Promotion> findByIsActiveTrueAndStartDateLessThanEqualAndEndDateGreaterThanEqualAndIdNot(
│   │                 LocalDateTime at1, LocalDateTime at2, Integer idNot
│   │         );
│   │     }
│   │     
│   │   ---- END ----
│   ├── StockTransactionRepository.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.repository;
│   │     
│   │     import com.retailmanagement.entity.StockTransaction;
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     
│   │     public interface StockTransactionRepository extends JpaRepository<StockTransaction, Long> {
│   │     }
│   │     
│   │   ---- END ----
│   ├── SystemSettingRepository.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.repository;
│   │     
│   │     import com.retailmanagement.entity.SystemSetting;
│   │     import org.springframework.data.jpa.repository.JpaRepository;
│   │     
│   │     public interface SystemSettingRepository extends JpaRepository<SystemSetting, String> {}
│   │     
│   │   ---- END ----
│   └── UserRepository.java
│       ---- CODE ----
│         package com.retailmanagement.repository;
│         
│         import com.retailmanagement.entity.User;
│         import org.springframework.data.jpa.repository.JpaRepository;
│         
│         import java.util.Optional;
│         
│         public interface UserRepository extends JpaRepository<User, Integer> {
│         
│             boolean existsByUsername(String username);
│             boolean existsByEmail(String email);
│         
│             boolean existsByUsernameAndIdNot(String username, Integer id);
│             boolean existsByEmailAndIdNot(String email, Integer id);
│         
│             Optional<User> findByUsername(String username);
│             Optional<User> findByEmail(String email);
│         
│             // login bằng username hoặc email
│             Optional<User> findByUsernameOrEmail(String username, String email);
│         }
│         
│       ---- END ----
├── RetailmanagementApplication.java
│   ---- CODE ----
│     package com.retailmanagement;
│     
│     import org.springframework.boot.SpringApplication;
│     import org.springframework.boot.autoconfigure.SpringBootApplication;
│     
│     @SpringBootApplication
│     public class RetailmanagementApplication {
│     
│         public static void main(String[] args) {
│             SpringApplication.run(RetailmanagementApplication.class, args);
│             System.out.println("running...");
│         }
│     
│     }
│     
│   ---- END ----
├── security
│   ├── CustomUserDetails.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.security;
│   │     
│   │     import com.retailmanagement.entity.User;
│   │     import lombok.Getter;
│   │     import org.springframework.security.core.GrantedAuthority;
│   │     import org.springframework.security.core.userdetails.UserDetails;
│   │     
│   │     import java.util.Collection;
│   │     import java.util.List;
│   │     
│   │     @Getter
│   │     public class CustomUserDetails implements UserDetails {
│   │     
│   │         private final Integer userId;
│   │         private final String username;
│   │         private final String password;
│   │         private final String role;
│   │         private final boolean enabled;
│   │         private final Collection<? extends GrantedAuthority> authorities;
│   │     
│   │         public CustomUserDetails(User user) {
│   │             this.userId = user.getId();
│   │             this.username = user.getUsername();
│   │             this.password = user.getPasswordHash();
│   │             this.role = user.getRole();
│   │             this.enabled = Boolean.TRUE.equals(user.getIsActive());
│   │             this.authorities = List.of(
│   │                     () -> "ROLE_" + user.getRole()
│   │             );
│   │         }
│   │     
│   │         @Override
│   │         public boolean isAccountNonExpired() {
│   │             return true;
│   │         }
│   │     
│   │         @Override
│   │         public boolean isAccountNonLocked() {
│   │             return enabled;
│   │         }
│   │     
│   │         @Override
│   │         public boolean isCredentialsNonExpired() {
│   │             return true;
│   │         }
│   │     
│   │         @Override
│   │         public boolean isEnabled() {
│   │             return enabled;
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   ├── CustomUserDetailsService.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.security;
│   │     
│   │     import com.retailmanagement.entity.User;
│   │     import com.retailmanagement.repository.UserRepository;
│   │     import lombok.RequiredArgsConstructor;
│   │     import org.springframework.security.core.authority.SimpleGrantedAuthority;
│   │     import org.springframework.security.core.userdetails.*;
│   │     import org.springframework.stereotype.Service;
│   │     
│   │     import java.util.List;
│   │     
│   │     @Service
│   │     @RequiredArgsConstructor
│   │     public class CustomUserDetailsService implements UserDetailsService {
│   │     
│   │         private final UserRepository userRepository;
│   │     
│   │     
│   │         @Override
│   │         public UserDetails loadUserByUsername(String username)
│   │                 throws UsernameNotFoundException {
│   │     
│   │             User user = userRepository.findByUsername(username)
│   │                     .orElseThrow(() -> new UsernameNotFoundException("User không tồn tại"));
│   │     
│   │             if (Boolean.FALSE.equals(user.getIsActive())) {
│   │                 throw new UsernameNotFoundException("Tài khoản đã bị khóa");
│   │             }
│   │     
│   │             return new CustomUserDetails(user);
│   │         }
│   │     
│   │     }
│   │     
│   │   ---- END ----
│   ├── JwtAuthenticationFilter.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.security;
│   │     
│   │     import jakarta.servlet.FilterChain;
│   │     import jakarta.servlet.ServletException;
│   │     import jakarta.servlet.http.HttpServletRequest;
│   │     import jakarta.servlet.http.HttpServletResponse;
│   │     import lombok.RequiredArgsConstructor;
│   │     import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
│   │     import org.springframework.security.core.context.SecurityContextHolder;
│   │     import org.springframework.security.core.userdetails.UserDetails;
│   │     import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
│   │     import org.springframework.stereotype.Component;
│   │     import org.springframework.web.filter.OncePerRequestFilter;
│   │     
│   │     import java.io.IOException;
│   │     
│   │     @Component
│   │     @RequiredArgsConstructor
│   │     public class JwtAuthenticationFilter extends OncePerRequestFilter {
│   │     
│   │         private final JwtService jwtService;
│   │         private final CustomUserDetailsService userDetailsService;
│   │     
│   │         @Override
│   │         protected void doFilterInternal(
│   │                 HttpServletRequest request,
│   │                 HttpServletResponse response,
│   │                 FilterChain filterChain
│   │         ) throws ServletException, IOException {
│   │     
│   │             String authHeader = request.getHeader("Authorization");
│   │             if (authHeader == null || !authHeader.startsWith("Bearer ")) {
│   │                 filterChain.doFilter(request, response);
│   │                 return;
│   │             }
│   │     
│   │             String token = authHeader.substring(7);
│   │     
│   │             if (!jwtService.isTokenValid(token)) {
│   │                 filterChain.doFilter(request, response);
│   │                 return;
│   │             }
│   │     
│   │             String username = jwtService.extractUsername(token);
│   │     
│   │             if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {
│   │                 UserDetails userDetails = userDetailsService.loadUserByUsername(username);
│   │     
│   │                 UsernamePasswordAuthenticationToken auth = new UsernamePasswordAuthenticationToken(
│   │                         userDetails,
│   │                         null,
│   │                         userDetails.getAuthorities()
│   │                 );
│   │                 auth.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
│   │     
│   │                 SecurityContextHolder.getContext().setAuthentication(auth);
│   │             }
│   │     
│   │             filterChain.doFilter(request, response);
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   └── JwtService.java
│       ---- CODE ----
│         package com.retailmanagement.security;
│         
│         import com.retailmanagement.config.JwtProperties;
│         import com.retailmanagement.entity.User;
│         import io.jsonwebtoken.Claims;
│         import io.jsonwebtoken.Jwts;
│         import io.jsonwebtoken.security.Keys;
│         import lombok.RequiredArgsConstructor;
│         import org.springframework.stereotype.Service;
│         
│         import java.nio.charset.StandardCharsets;
│         import java.security.Key;
│         import java.util.Date;
│         
│         @Service
│         @RequiredArgsConstructor
│         public class JwtService {
│         
│             private final JwtProperties jwtProperties;
│         
│             private Key getSigningKey() {
│                 return Keys.hmacShaKeyFor(jwtProperties.getSecret().getBytes(StandardCharsets.UTF_8));
│             }
│         
│             public String generateToken(User user) {
│                 Date now = new Date();
│                 Date expiry = new Date(now.getTime() + jwtProperties.getExpiration());
│         
│                 return Jwts.builder()
│                         .subject(user.getUsername())                 // subject = username
│                         .claim("userId", user.getId())
│                         .claim("email", user.getEmail())
│                         .claim("role", user.getRole())
│                         .issuedAt(now)
│                         .expiration(expiry)
│                         .signWith(getSigningKey())
│                         .compact();
│             }
│         
│             public Claims parseClaims(String token) {
│                 return Jwts.parser()
│                         .verifyWith((javax.crypto.SecretKey) getSigningKey())
│                         .build()
│                         .parseSignedClaims(token)
│                         .getPayload();
│             }
│         
│             public String extractUsername(String token) {
│                 return parseClaims(token).getSubject();
│             }
│         
│             public boolean isTokenValid(String token) {
│                 try {
│                     Claims c = parseClaims(token);
│                     return c.getExpiration() != null && c.getExpiration().after(new Date());
│                 } catch (Exception e) {
│                     return false;
│                 }
│             }
│         
│             public long getExpirationMillis() {
│                 return jwtProperties.getExpiration();
│             }
│         }
│         
│       ---- END ----
├── service
│   ├── AuthService.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.service;
│   │     
│   │     import com.retailmanagement.dto.request.LoginRequest;
│   │     import com.retailmanagement.dto.request.RegisterRequest;
│   │     import com.retailmanagement.dto.response.AuthResponse;
│   │     import com.retailmanagement.dto.response.UserResponse;
│   │     import com.retailmanagement.entity.Customer;
│   │     import com.retailmanagement.entity.CustomerType;
│   │     import com.retailmanagement.entity.User;
│   │     import com.retailmanagement.repository.CustomRes;
│   │     import com.retailmanagement.repository.UserRepository;
│   │     import com.retailmanagement.security.JwtService;
│   │     import jakarta.transaction.Transactional;
│   │     import lombok.RequiredArgsConstructor;
│   │     import org.modelmapper.ModelMapper;
│   │     import org.springframework.security.authentication.AuthenticationManager;
│   │     import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
│   │     import org.springframework.security.core.Authentication;
│   │     import org.springframework.security.crypto.password.PasswordEncoder;
│   │     import org.springframework.stereotype.Service;
│   │     
│   │     import java.math.BigDecimal;
│   │     import java.util.Optional;
│   │     
│   │     @Service
│   │     @RequiredArgsConstructor
│   │     public class AuthService {
│   │     
│   │         private final UserRepository userRepository;
│   │         private final CustomRes customerRepository; // ✅ added
│   │         private final PasswordEncoder passwordEncoder;
│   │         private final JwtService jwtService;
│   │         private final ModelMapper modelMapper;
│   │         private final AuthenticationManager authenticationManager;
│   │     
│   │         // ✅ Requirement #3: customer registration must also insert into `customers`
│   │         // Ensure atomicity: either both user+customer are saved or none.
│   │         @Transactional
│   │         public AuthResponse register(RegisterRequest req) {
│   │             if (userRepository.existsByUsername(req.getUsername())) {
│   │                 throw new RuntimeException("Username đã tồn tại");
│   │             }
│   │             if (userRepository.existsByEmail(req.getEmail())) {
│   │                 throw new RuntimeException("Email đã tồn tại");
│   │             }
│   │     
│   │             // 1) Create USER
│   │             User user = User.builder()
│   │                     .username(req.getUsername())
│   │                     .email(req.getEmail())
│   │                     .passwordHash(passwordEncoder.encode(req.getPassword()))
│   │                     .role("CUSTOMER")
│   │                     .isActive(true)
│   │                     .build();
│   │     
│   │             user = userRepository.save(user);
│   │     
│   │             // 2) Create/ensure CUSTOMER with same email, is_active=true
│   │             Optional<Customer> existingCus = customerRepository.findByEmail(req.getEmail());
│   │             if (existingCus.isEmpty()) {
│   │                 Customer customer = Customer.builder()
│   │                         .name(req.getUsername())            // default name from username
│   │                         .email(req.getEmail())
│   │                         .phone(null)
│   │                         .dateOfBirth(null)
│   │                         .customerType(CustomerType.REGULAR)
│   │                         .vipTier(null)
│   │                         .segmentsJson(null)
│   │                         .loyaltyPoints(0)
│   │                         .totalSpent(BigDecimal.ZERO)
│   │                         .address(null)
│   │                         .notes(null)
│   │                         .isActive(true)
│   │                         .build();
│   │     
│   │                 customerRepository.save(customer);
│   │             } else {
│   │                 // If already exists (rare, but safe), ensure active & data consistent
│   │                 Customer customer = existingCus.get();
│   │                 customer.setIsActive(true);
│   │                 if (customer.getName() == null || customer.getName().isBlank()) {
│   │                     customer.setName(req.getUsername());
│   │                 }
│   │                 // Keep email the same (requirement). If somehow null, set it.
│   │                 if (customer.getEmail() == null || customer.getEmail().isBlank()) {
│   │                     customer.setEmail(req.getEmail());
│   │                 }
│   │                 customerRepository.save(customer);
│   │             }
│   │     
│   │             // 3) Return auth response as before
│   │             String token = jwtService.generateToken(user);
│   │             UserResponse userRes = modelMapper.map(user, UserResponse.class);
│   │     
│   │             return AuthResponse.builder()
│   │                     .token(token)
│   │                     .expiresIn(jwtService.getExpirationMillis())
│   │                     .user(userRes)
│   │                     .build();
│   │         }
│   │     
│   │         public AuthResponse login(LoginRequest req) {
│   │             User user = userRepository.findByUsernameOrEmail(req.getIdentifier(), req.getIdentifier())
│   │                     .orElseThrow(() -> new RuntimeException("Sai tài khoản hoặc mật khẩu"));
│   │     
│   │             if (Boolean.FALSE.equals(user.getIsActive())) {
│   │                 throw new RuntimeException("Tài khoản đã bị khóa");
│   │             }
│   │     
│   │             Authentication auth = authenticationManager.authenticate(
│   │                     new UsernamePasswordAuthenticationToken(user.getUsername(), req.getPassword())
│   │             );
│   │     
│   │             if (!auth.isAuthenticated()) {
│   │                 throw new RuntimeException("Sai tài khoản hoặc mật khẩu");
│   │             }
│   │     
│   │             String token = jwtService.generateToken(user);
│   │             UserResponse userRes = modelMapper.map(user, UserResponse.class);
│   │     
│   │             return AuthResponse.builder()
│   │                     .token(token)
│   │                     .expiresIn(jwtService.getExpirationMillis())
│   │                     .user(userRes)
│   │                     .build();
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   ├── CustomerService.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.service;
│   │     
│   │     
│   │     import com.retailmanagement.dto.request.CustomerRequest;
│   │     import com.retailmanagement.dto.response.CustomerResponse;
│   │     import com.retailmanagement.entity.Customer;
│   │     import com.retailmanagement.entity.CustomerType;
│   │     import com.retailmanagement.entity.VipTier;
│   │     import com.retailmanagement.repository.CustomRes;
│   │     import jakarta.transaction.Transactional;
│   │     import lombok.RequiredArgsConstructor;
│   │     import org.springframework.beans.factory.annotation.Autowired;
│   │     
│   │     import java.math.BigDecimal;
│   │     import java.util.List;
│   │     import java.util.stream.Collectors;
│   │     
│   │     @org.springframework.stereotype.Service
│   │     @RequiredArgsConstructor
│   │     public class CustomerService {
│   │         @Autowired
│   │         CustomRes customRes;
│   │     
│   │         @Transactional
│   │         public CustomerResponse create(CustomerRequest customerRequest) {
│   │             if ( customRes.findByEmail(customerRequest.getEmail()).isPresent()) {
│   │                 throw new RuntimeException("Email đã tồn tại trong hệ thống");
│   │             }
│   │             if (customRes.findByPhone(customerRequest.getPhone()).isPresent()) {
│   │                 throw new RuntimeException("Số điện thoại đã tồn tại trong hệ thống");
│   │             }
│   │             CustomerType type = (customerRequest.getCustomerType() != null)
│   │                     ? customerRequest.getCustomerType()
│   │                     : CustomerType.REGULAR;
│   │             Customer customer = Customer.builder()
│   │                     .name(customerRequest.getFullName())                    // ✅ name (không phải fullName)
│   │                     .email(customerRequest.getEmail())
│   │                     .phone(customerRequest.getPhone())
│   │                     .dateOfBirth(customerRequest.getBirthDate())      // ✅ dateOfBirth (không phải birthDate)
│   │                     .address(customerRequest.getAddress())              // ✅ address
│   │                     .notes(customerRequest.getNotes())                  // ✅ notes (không phải note)
│   │                     .customerType(type)         // ✅ Mặc định REGULAR
│   │                     .vipTier(null)
│   │                     .totalSpent(BigDecimal.ZERO)// ✅ NULL cho khách thường
│   │                     .loyaltyPoints(0)                          // ✅ Bắt đầu = 0
│   │                     .isActive(true)
│   │                     .build();
│   │     
│   │             Customer saved = customRes.save(customer);
│   │             return mapToResponse(saved);
│   │         }
│   │     
│   │         private CustomerResponse mapToResponse(Customer customer) {
│   │             VipTier tier = customer.getVipTier();
│   │             return CustomerResponse.builder()
│   │                     .id(customer.getId())
│   │                     .name(customer.getName())
│   │                     .email(customer.getEmail())
│   │                     .phone(customer.getPhone())
│   │                     .dateOfBirth(customer.getDateOfBirth())
│   │                     .customerType(customer.getCustomerType())
│   │                     .customerTypeDisplay(customer.getCustomerType().getDisplayname())
│   │     
│   │                     .vipTier(tier)
│   │                     .vipTierDisplay(tier != null ? tier.getDisplayName() : null)
│   │     
│   │                     .loyaltyPoints(customer.getLoyaltyPoints())
│   │                     .pointsToNextTier(tier != null ? tier.getPointsToNextTier() : 100) // ví dụ: cần 100 để lên BRONZE
│   │                     .discountRate(tier != null ? tier.getDiscountMultiplier() : 1.0)   // khách thường = 1.0 (không giảm)
│   │     
│   │                     .totalSpent(customer.getTotalSpent())
│   │                     .lastOrderAt(customer.getLastOrderAt())
│   │                     .address(customer.getAddress())
│   │                     .notes(customer.getNotes())
│   │                     .segmentsJson(customer.getSegmentsJson())
│   │                     .isActive(customer.getIsActive())
│   │                     .createdAt(customer.getCreatedAt())
│   │                     .updatedAt(customer.getUpdatedAt())
│   │                     .build();
│   │         }
│   │         public List<CustomerResponse> findAll() {
│   │             return customRes.findAll().stream().map(this::mapToResponse).collect(Collectors.toList());
│   │         }
│   │         public List<CustomerResponse> findbyCustomerType(CustomerType type) {
│   │             return customRes.findByCustomerType(type).stream()
│   │                     .map(this::mapToResponse).collect(Collectors.toList());
│   │         }
│   │         public void deleteById(int id) {
│   │            Customer customer = customRes.findById(id).orElseThrow();
│   │            customer.setIsActive(false);
│   │            customRes.save(customer);
│   │         }
│   │         public CustomerResponse updateById(Integer id, CustomerRequest customerRequest) {
│   │             Customer customer = customRes.findById(id).orElseThrow(()->(new RuntimeException("Không tìm thấy Khách hàng với id: " + id)));
│   │             if(customerRequest.getFullName()!=null){
│   │                 customer.setName(customerRequest.getFullName());
│   │             }
│   │             String oldemail = customer.getEmail();
│   │             if(customerRequest.getEmail()!=null && !customerRequest.getEmail().equals(oldemail)){
│   │                 if(customRes.findByEmail(customerRequest.getEmail()).isPresent()){
│   │                         throw new RuntimeException("Email này đã tồn tại trong hệ thống");
│   │                 }
│   │                 customer.setEmail(customerRequest.getEmail());
│   │             }
│   │             String oldphone = customer.getPhone();
│   │             if(customerRequest.getPhone()!=null && !customerRequest.getPhone().equals(oldphone)){
│   │                 if(customRes.findByPhone(customerRequest.getPhone()).isPresent()){
│   │                     throw new RuntimeException("Số điện thoại này đã tồn tại trong hệ thống");
│   │                 }
│   │                 customer.setPhone(customerRequest.getPhone());
│   │             }
│   │             if(customerRequest.getBirthDate()!=null){
│   │                 customer.setDateOfBirth(customerRequest.getBirthDate());
│   │             }
│   │             if (customerRequest.getAddress() != null) {
│   │                 customer.setAddress(customerRequest.getAddress());
│   │             }   
│   │             if (customerRequest.getNotes() != null) {
│   │                 customer.setNotes(customerRequest.getNotes());
│   │             }
│   │             Customer update = customRes.save(customer);
│   │             return mapToResponse(update);
│   │             }
│   │     }
│   │     
│   │     
│   │   ---- END ----
│   ├── OrderQueryService.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.service;
│   │     
│   │     import com.retailmanagement.dto.response.OrderListResponse;
│   │     import com.retailmanagement.entity.Order;
│   │     import com.retailmanagement.repository.OrderRepository;
│   │     import lombok.RequiredArgsConstructor;
│   │     import org.springframework.stereotype.Service;
│   │     
│   │     import java.util.List;
│   │     
│   │     @Service
│   │     @RequiredArgsConstructor
│   │     public class OrderQueryService {
│   │     
│   │         private final OrderRepository orderRepository;
│   │     
│   │         public List<OrderListResponse> getNewOrders() {
│   │             return mapToResponse(
│   │                     orderRepository.findByStatusOrderByCreatedAtDesc("PENDING")
│   │             );
│   │         }
│   │     
│   │         public List<OrderListResponse> getProcessingOrders() {
│   │             return mapToResponse(
│   │                     orderRepository.findByStatusInOrderByCreatedAtDesc(
│   │                             List.of("PAID", "SHIPPING")
│   │                     )
│   │             );
│   │         }
│   │     
│   │         private List<OrderListResponse> mapToResponse(List<Order> orders) {
│   │             return orders.stream()
│   │                     .map(o -> new OrderListResponse(
│   │                             o.getId(),
│   │                             o.getOrderNumber(),
│   │                             o.getCustomer() != null ? o.getCustomer().getName() : null,
│   │                             o.getUser() != null ? o.getUser().getUsername() : null,
│   │                             o.getTotalAmount(),
│   │                             o.getStatus(),
│   │                             o.getPaymentStatus(),
│   │                             o.getCreatedAt()
│   │                     ))
│   │                     .toList();
│   │         }
│   │     }
│   │     
│   │     
│   │   ---- END ----
│   ├── OrderService.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.service;
│   │     
│   │     import com.retailmanagement.dto.request.CreateOrderItemRequest;
│   │     import com.retailmanagement.dto.request.CreateOrderRequest;
│   │     import com.retailmanagement.dto.request.UpdateOrderRequest;
│   │     import com.retailmanagement.dto.response.CreateOrderResponse;
│   │     import com.retailmanagement.dto.response.OrderDetailResponse;
│   │     import com.retailmanagement.entity.*;
│   │     import com.retailmanagement.repository.*;
│   │     import jakarta.transaction.Transactional;
│   │     import lombok.RequiredArgsConstructor;
│   │     import org.springframework.stereotype.Service;
│   │     
│   │     import java.math.BigDecimal;
│   │     import java.time.*;
│   │     import java.time.format.DateTimeFormatter;
│   │     import java.util.ArrayList;
│   │     import java.util.List;
│   │     import java.util.UUID;
│   │     
│   │     
│   │     @Service
│   │     @RequiredArgsConstructor
│   │     @Transactional
│   │     public class OrderService {
│   │     
│   │         private final OrderRepository orderRepository;
│   │         private final OrderItemRepository orderItemRepository;
│   │         private final ProductVariantRepository variantRepository;
│   │         private final StockTransactionRepository stockTransactionRepository;
│   │         private final CustomRes customerRepository;
│   │         private final UserRepository userRepository;
│   │     
│   │         private String generateOrderNumber() {
│   │     
│   │             LocalDate today = LocalDate.now();
│   │             LocalDateTime startOfDay = today.atStartOfDay();
│   │             LocalDateTime endOfDay = today.atTime(23, 59, 59);
│   │     
│   │             Instant start = startOfDay.atZone(ZoneId.systemDefault()).toInstant();
│   │             Instant end = endOfDay.atZone(ZoneId.systemDefault()).toInstant();
│   │     
│   │             long countToday = orderRepository.countByCreatedAtBetween(start, end);
│   │     
│   │             String datePart = today.format(DateTimeFormatter.BASIC_ISO_DATE);
│   │             String sequencePart = String.format("%06d", countToday + 1);
│   │     
│   │             return "ORD-" + datePart + "-" + sequencePart;
│   │         }
│   │     
│   │     
│   │         public CreateOrderResponse createOrder(CreateOrderRequest request, Integer userId) {
│   │     
│   │             // ===== LẤY CUSTOMER & USER =====
│   │             Customer customer = customerRepository.findById(request.getCustomerId())
│   │                     .orElseThrow(() -> new RuntimeException("Customer not found"));
│   │     
│   │             User user = userRepository.findById(userId)
│   │                     .orElseThrow(() -> new RuntimeException("User not found"));
│   │     
│   │             // ===== TẠO ORDER (SET ĐỦ @NotNull) =====
│   │             Order order = new Order();
│   │             order.setCustomer(customer);
│   │             order.setUser(user);
│   │             order.setChannel(request.getChannel());
│   │             order.setPaymentMethod(request.getPaymentMethod());
│   │             order.setStatus("PENDING");
│   │             order.setPaymentStatus("UNPAID");
│   │             order.setNotes(request.getNotes());
│   │     
│   │             order.setSubtotal(BigDecimal.ZERO);
│   │             order.setDiscountTotal(BigDecimal.ZERO);
│   │             order.setTaxTotal(BigDecimal.ZERO);
│   │             order.setShippingFee(BigDecimal.ZERO);
│   │             order.setTotalAmount(BigDecimal.ZERO);
│   │     
│   │             order.setOrderNumber(generateOrderNumber());
│   │             order.setCreatedAt(Instant.now());
│   │             order.setUpdatedAt(Instant.now());
│   │     
│   │             order = orderRepository.save(order);
│   │     
│   │             // ===== XỬ LÝ ITEMS =====
│   │             BigDecimal subtotal = BigDecimal.ZERO;
│   │             List<CreateOrderResponse.Item> responseItems = new ArrayList<>();
│   │     
│   │             for (CreateOrderItemRequest itemReq : request.getItems()) {
│   │     
│   │                 ProductVariant variant = variantRepository.findById(itemReq.getVariantId())
│   │                         .orElseThrow(() -> new RuntimeException("Variant not found"));
│   │     
│   │                 int available = variant.getStockQuantity() - variant.getReservedQty();
│   │                 if (available < itemReq.getQuantity()) {
│   │                     throw new RuntimeException("Not enough stock");
│   │                 }
│   │     
│   │                 BigDecimal lineTotal =
│   │                         variant.getPrice().multiply(BigDecimal.valueOf(itemReq.getQuantity()));
│   │     
│   │                 // ----- ORDER ITEM -----
│   │                 OrderItem item = new OrderItem();
│   │                 item.setOrder(order);
│   │                 item.setVariant(variant);
│   │                 item.setProduct(variant.getProduct());
│   │                 item.setProductName(variant.getProduct().getName());
│   │                 item.setVariantName(variant.getVariantName());
│   │                 item.setSku(variant.getSku());
│   │                 item.setQuantity(itemReq.getQuantity());
│   │                 item.setUnitPrice(variant.getPrice());
│   │                 item.setLineTotal(lineTotal);
│   │     
│   │                 // FIX @NotNull
│   │                 item.setDiscount(BigDecimal.ZERO);
│   │                 item.setCreatedAt(Instant.now());
│   │     
│   │                 orderItemRepository.save(item);
│   │     
│   │                 subtotal = subtotal.add(lineTotal);
│   │     
│   │                 // ----- RESERVE TỒN KHO -----
│   │                 variant.setReservedQty(variant.getReservedQty() + itemReq.getQuantity());
│   │                 variantRepository.save(variant);
│   │     
│   │                 StockTransaction st = new StockTransaction();
│   │                 st.setVariant(variant);
│   │                 st.setQuantity(itemReq.getQuantity());
│   │                 st.setType("RESERVE");
│   │                 st.setReferenceType("orders");
│   │                 st.setReferenceId(order.getId());
│   │                 st.setCreatedBy(user);
│   │                 st.setCreatedAt(Instant.now());
│   │     
│   │                 stockTransactionRepository.save(st);
│   │     
│   │                 // ----- MAP RESPONSE ITEM (PHẲNG) -----
│   │                 responseItems.add(new CreateOrderResponse.Item(
│   │                         item.getProductName(),
│   │                         item.getVariantName(),
│   │                         item.getSku(),
│   │                         item.getQuantity(),
│   │                         item.getUnitPrice(),
│   │                         item.getDiscount(),
│   │                         item.getLineTotal()
│   │                 ));
│   │             }
│   │     
│   │             // ===== CẬP NHẬT TOTAL =====
│   │             order.setSubtotal(subtotal);
│   │             order.setTotalAmount(subtotal);
│   │             order.setUpdatedAt(Instant.now());
│   │     
│   │             orderRepository.save(order);
│   │     
│   │             // ===== TRẢ RESPONSE ĐẦY ĐỦ (PHẲNG) =====
│   │             return new CreateOrderResponse(
│   │                     order.getId(),
│   │                     order.getOrderNumber(),
│   │                     order.getStatus(),
│   │                     order.getPaymentStatus(),
│   │     
│   │                     customer.getId(),
│   │                     customer.getName(),
│   │     
│   │                     user.getId(),
│   │                     user.getUsername(),
│   │     
│   │                     order.getSubtotal(),
│   │                     order.getDiscountTotal(),
│   │                     order.getTaxTotal(),
│   │                     order.getShippingFee(),
│   │                     order.getTotalAmount(),
│   │     
│   │                     order.getCreatedAt(),
│   │                     responseItems
│   │             );
│   │         }
│   │     
│   │         public void updateOrder(Long orderId, UpdateOrderRequest request) {
│   │     
│   │             Order order = orderRepository.findById(orderId)
│   │                     .orElseThrow(() -> new RuntimeException("Order not found"));
│   │     
│   │             if (!"PENDING".equals(order.getStatus())) {
│   │                 throw new RuntimeException("Chỉ được chỉnh sửa đơn PENDING");
│   │             }
│   │     
│   │             order.setPaymentMethod(request.getPaymentMethod());
│   │             order.setNotes(request.getNotes());
│   │             order.setUpdatedAt(Instant.now());
│   │     
│   │             orderRepository.save(order);
│   │         }
│   │     
│   │         /* =========================
│   │            CANCEL ORDER + RELEASE STOCK
│   │            ========================= */
│   │         public void cancelOrder(Long orderId, Integer userId) {
│   │     
│   │             Order order = orderRepository.findById(orderId)
│   │                     .orElseThrow(() -> new RuntimeException("Order not found"));
│   │     
│   │             if (!"PENDING".equals(order.getStatus())) {
│   │                 throw new RuntimeException("Chỉ được hủy đơn PENDING");
│   │             }
│   │     
│   │             for (OrderItem item : order.getOrderItems()) {
│   │     
│   │                 ProductVariant variant = item.getVariant();
│   │                 variant.setReservedQty(
│   │                         variant.getReservedQty() - item.getQuantity()
│   │                 );
│   │                 variantRepository.save(variant);
│   │     
│   │                 StockTransaction st = new StockTransaction();
│   │                 st.setVariant(variant);
│   │                 st.setQuantity(item.getQuantity());
│   │                 st.setType("RELEASE");
│   │                 st.setReferenceType("orders");
│   │                 st.setReferenceId(order.getId());
│   │                 st.setCreatedBy(order.getUser());
│   │                 st.setCreatedAt(Instant.now());
│   │     
│   │                 stockTransactionRepository.save(st);
│   │             }
│   │     
│   │             order.setStatus("CANCELLED");
│   │             order.setCancelledAt(Instant.now());
│   │             order.setUpdatedAt(Instant.now());
│   │     
│   │             orderRepository.save(order);
│   │         }
│   │     
│   │         /* =========================
│   │            DELETE ORDER
│   │            ========================= */
│   │         public void deleteOrder(Long orderId) {
│   │     
│   │             Order order = orderRepository.findById(orderId)
│   │                     .orElseThrow(() -> new RuntimeException("Order not found"));
│   │     
│   │             if (!"PENDING".equals(order.getStatus())) {
│   │                 throw new RuntimeException("Chỉ được xóa đơn PENDING");
│   │             }
│   │     
│   │             orderItemRepository.deleteAll(order.getOrderItems());
│   │             orderRepository.delete(order);
│   │         }
│   │     
│   │         /* =========================
│   │            RECALC TOTAL
│   │            ========================= */
│   │         private void recalcOrderTotal(Order order) {
│   │     
│   │             BigDecimal subtotal = order.getOrderItems().stream()
│   │                     .map(OrderItem::getLineTotal)
│   │                     .reduce(BigDecimal.ZERO, BigDecimal::add);
│   │     
│   │             order.setSubtotal(subtotal);
│   │             order.setTotalAmount(
│   │                     subtotal
│   │                             .subtract(order.getDiscountTotal())
│   │                             .add(order.getTaxTotal())
│   │                             .add(order.getShippingFee())
│   │             );
│   │         }
│   │     
│   │         /* =========================
│   │            ORDER DETAIL
│   │            ========================= */
│   │         public OrderDetailResponse getOrderDetail(Long orderId) {
│   │     
│   │             Order order = orderRepository.findById(orderId)
│   │                     .orElseThrow(() -> new RuntimeException("Order not found"));
│   │     
│   │             List<CreateOrderResponse.Item> items =
│   │                     order.getOrderItems().stream()
│   │                             .map(i -> new CreateOrderResponse.Item(
│   │                                     i.getProductName(),
│   │                                     i.getVariantName(),
│   │                                     i.getSku(),
│   │                                     i.getQuantity(),
│   │                                     i.getUnitPrice(),
│   │                                     i.getDiscount(),
│   │                                     i.getLineTotal()
│   │                             ))
│   │                             .toList();
│   │     
│   │             return new OrderDetailResponse(
│   │                     order.getId(),
│   │                     order.getOrderNumber(),
│   │                     order.getStatus(),
│   │                     order.getPaymentStatus(),
│   │     
│   │                     order.getCustomer().getId(),
│   │                     order.getCustomer().getName(),
│   │     
│   │                     order.getUser().getId(),
│   │                     order.getUser().getUsername(),
│   │     
│   │                     order.getSubtotal(),
│   │                     order.getDiscountTotal(),
│   │                     order.getTaxTotal(),
│   │                     order.getShippingFee(),
│   │                     order.getTotalAmount(),
│   │     
│   │                     order.getCreatedAt(),
│   │                     items
│   │             );
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   ├── PricingService.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.service;
│   │     
│   │     import com.retailmanagement.dto.request.UpsertPriceRequest;
│   │     import com.retailmanagement.dto.response.VariantPriceResponse;
│   │     import com.retailmanagement.entity.PriceHistory;
│   │     import com.retailmanagement.entity.ProductVariant;
│   │     import com.retailmanagement.entity.Promotion;
│   │     import com.retailmanagement.entity.User;
│   │     import com.retailmanagement.repository.PriceHistoryRepository;
│   │     import com.retailmanagement.repository.ProductVariantRepository;
│   │     import com.retailmanagement.repository.UserRepository;
│   │     import org.springframework.stereotype.Service;
│   │     import org.springframework.transaction.annotation.Transactional;
│   │     
│   │     import java.math.BigDecimal;
│   │     import java.time.Instant;
│   │     import java.time.LocalDateTime;
│   │     import java.util.List;
│   │     import java.util.NoSuchElementException;
│   │     
│   │     @Service
│   │     public class PricingService {
│   │     
│   │         private final ProductVariantRepository variantRepo;
│   │         private final PriceHistoryRepository priceHistoryRepo;
│   │         private final SettingService settingService;
│   │         private final PromotionService promotionService;
│   │         private final UserRepository userRepository;
│   │     
│   │         public PricingService(ProductVariantRepository variantRepo,
│   │                               PriceHistoryRepository priceHistoryRepo,
│   │                               SettingService settingService,
│   │                               PromotionService promotionService, UserRepository userRepository) {
│   │             this.variantRepo = variantRepo;
│   │             this.priceHistoryRepo = priceHistoryRepo;
│   │             this.settingService = settingService;
│   │             this.promotionService = promotionService;
│   │             this.userRepository = userRepository;
│   │         }
│   │     
│   │         // 1) Tạo/đổi giá (và tạo history)
│   │         @Transactional
│   │         public PriceHistory setVariantPrice(Integer variantId, UpsertPriceRequest req, Integer userId) {
│   │             ProductVariant v = variantRepo.findById(variantId)
│   │                     .orElseThrow(() -> new NoSuchElementException("Variant not found"));
│   │     
│   │             User user = userRepository.findById(userId)
│   │                     .orElseThrow(() -> new RuntimeException("User not found"));
│   │     
│   │             if (req.getPrice() == null || req.getPrice().compareTo(BigDecimal.ZERO) < 0) {
│   │                 throw new IllegalArgumentException("price phải >= 0");
│   │             }
│   │     
│   │             String currency = (req.getCurrencyCode() == null || req.getCurrencyCode().isBlank())
│   │                     ? settingService.getDefaultCurrency()
│   │                     : req.getCurrencyCode().trim().toUpperCase();
│   │     
│   │             Instant now = Instant.now();
│   │     
│   │             // close current history
│   │             priceHistoryRepo.findFirstByVariant_IdAndEffectiveToIsNullOrderByEffectiveFromDesc(variantId)
│   │                     .ifPresent(cur -> {
│   │                         cur.setEffectiveTo(now);
│   │                         priceHistoryRepo.save(cur);
│   │                     });
│   │     
│   │             // create new history
│   │             PriceHistory ph = new PriceHistory();
│   │             ph.setVariant(v);
│   │             ph.setCurrencyCode(currency);
│   │             ph.setPrice(req.getPrice());
│   │             ph.setCostPrice(req.getCostPrice());
│   │             ph.setReason(req.getReason() == null ? "MANUAL" : req.getReason());
│   │             ph.setEffectiveFrom(now);
│   │             ph.setEffectiveTo(null);
│   │             ph.setCreatedBy(user);
│   │             ph.setCreatedAt(now);
│   │             priceHistoryRepo.save(ph);
│   │     
│   │             // update current price on variant
│   │             v.setCurrencyCode(currency);
│   │             v.setPrice(req.getPrice());
│   │             v.setCostPrice(req.getCostPrice());
│   │             v.setUpdatedAt(now);
│   │             variantRepo.save(v);
│   │     
│   │             return ph;
│   │         }
│   │     
│   │         // 2) Danh sách giá theo sản phẩm (current)
│   │         public List<VariantPriceResponse> listCurrentPricesByProduct(Integer productId) {
│   │             List<ProductVariant> variants = variantRepo.findByProduct_Id(productId);
│   │             LocalDateTime now = LocalDateTime.now();
│   │     
│   │             return variants.stream().map(v -> {
│   │                 VariantPriceResponse r = new VariantPriceResponse();
│   │                 r.setVariantId(v.getId());
│   │                 r.setProductId(v.getProduct().getId());
│   │                 r.setVariantName(v.getVariantName());
│   │                 r.setSku(v.getSku());
│   │                 r.setCurrencyCode(v.getCurrencyCode());
│   │                 r.setPrice(v.getPrice());
│   │                 r.setCostPrice(v.getCostPrice());
│   │     
│   │                 Promotion best = promotionService.findBestPromotionForVariant(v, now);
│   │                 if (best != null) {
│   │                     r.setPromotionCode(best.getCode());
│   │                     r.setFinalPrice(promotionService.applyDiscount(v.getPrice(), best.getDiscountType(), best.getDiscountValue()));
│   │                 } else {
│   │                     r.setFinalPrice(v.getPrice());
│   │                 }
│   │                 return r;
│   │             }).toList();
│   │         }
│   │     
│   │         // 3) Chỉnh sửa giá: chỉ cho phép chỉnh sửa record mới nhất (effective_to = null)
│   │         @Transactional
│   │         public PriceHistory updateLatestHistory(Long priceHistoryId, UpsertPriceRequest req) {
│   │             PriceHistory ph = priceHistoryRepo.findById(priceHistoryId)
│   │                     .orElseThrow(() -> new NoSuchElementException("Price history not found"));
│   │     
│   │             if (ph.getEffectiveTo() != null) {
│   │                 throw new IllegalArgumentException("Chỉ được sửa bản ghi giá hiện tại (effective_to = null)");
│   │             }
│   │     
│   │             if (req.getPrice() == null || req.getPrice().compareTo(BigDecimal.ZERO) < 0) {
│   │                 throw new IllegalArgumentException("price phải >= 0");
│   │             }
│   │     
│   │             String currency = (req.getCurrencyCode() == null || req.getCurrencyCode().isBlank())
│   │                     ? ph.getCurrencyCode()
│   │                     : req.getCurrencyCode().trim().toUpperCase();
│   │     
│   │             ph.setCurrencyCode(currency);
│   │             ph.setPrice(req.getPrice());
│   │             ph.setCostPrice(req.getCostPrice());
│   │             ph.setReason(req.getReason() == null ? ph.getReason() : req.getReason());
│   │             priceHistoryRepo.save(ph);
│   │     
│   │             // sync variant current price
│   │             ProductVariant v = ph.getVariant();
│   │             v.setCurrencyCode(currency);
│   │             v.setPrice(req.getPrice());
│   │             v.setCostPrice(req.getCostPrice());
│   │             v.setUpdatedAt(Instant.now());
│   │             variantRepo.save(v);
│   │     
│   │             return ph;
│   │         }
│   │     
│   │         // 4) Xóa giá: chỉ cho phép xóa bản ghi mới nhất và rollback về bản trước
│   │         @Transactional
│   │         public void deleteLatestAndRollback(Long priceHistoryId) {
│   │             PriceHistory current = priceHistoryRepo.findById(priceHistoryId)
│   │                     .orElseThrow(() -> new NoSuchElementException("Price history not found"));
│   │     
│   │             if (current.getEffectiveTo() != null) {
│   │                 throw new IllegalArgumentException("Chỉ được xóa bản ghi giá hiện tại (effective_to = null)");
│   │             }
│   │     
│   │             Integer variantId = current.getVariant().getId();
│   │     
│   │             priceHistoryRepo.delete(current);
│   │     
│   │             // rollback: lấy bản mới nhất còn lại
│   │             List<PriceHistory> histories = priceHistoryRepo.findByVariant_IdOrderByEffectiveFromDesc(variantId);
│   │             if (histories.isEmpty()) {
│   │                 throw new IllegalStateException("Không còn lịch sử giá để rollback");
│   │             }
│   │     
│   │             PriceHistory latest = histories.get(0);
│   │             latest.setEffectiveTo(null);
│   │             priceHistoryRepo.save(latest);
│   │     
│   │             ProductVariant v = latest.getVariant();
│   │             v.setCurrencyCode(latest.getCurrencyCode());
│   │             v.setPrice(latest.getPrice());
│   │             v.setCostPrice(latest.getCostPrice());
│   │             v.setUpdatedAt(Instant.now());
│   │             variantRepo.save(v);
│   │         }
│   │     
│   │         // 5) Giá hiện tại sau khuyến mãi theo variant
│   │         public VariantPriceResponse getEffectivePrice(Integer variantId) {
│   │             ProductVariant v = variantRepo.findById(variantId)
│   │                     .orElseThrow(() -> new NoSuchElementException("Variant not found"));
│   │     
│   │             LocalDateTime now = LocalDateTime.now();
│   │             Promotion best = promotionService.findBestPromotionForVariant(v, now);
│   │     
│   │             VariantPriceResponse r = new VariantPriceResponse();
│   │             r.setVariantId(v.getId());
│   │             r.setProductId(v.getProduct().getId());
│   │             r.setVariantName(v.getVariantName());
│   │             r.setSku(v.getSku());
│   │             r.setCurrencyCode(v.getCurrencyCode());
│   │             r.setPrice(v.getPrice());
│   │             r.setCostPrice(v.getCostPrice());
│   │     
│   │             if (best != null) {
│   │                 r.setPromotionCode(best.getCode());
│   │                 r.setFinalPrice(promotionService.applyDiscount(v.getPrice(), best.getDiscountType(), best.getDiscountValue()));
│   │             } else {
│   │                 r.setFinalPrice(v.getPrice());
│   │             }
│   │             return r;
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   ├── ProductService.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.service;
│   │     
│   │     import com.retailmanagement.dto.request.ProductRequest;
│   │     import com.retailmanagement.dto.response.ProductResponse;
│   │     import com.retailmanagement.entity.Category;
│   │     import com.retailmanagement.entity.Image;
│   │     import com.retailmanagement.entity.Product;
│   │     import com.retailmanagement.entity.ProductCategory;
│   │     import com.retailmanagement.entity.ProductCategoryId;
│   │     import com.retailmanagement.entity.ProductVariant;
│   │     import com.retailmanagement.repository.CategoryRepository;
│   │     import com.retailmanagement.repository.ImageRepository;
│   │     import com.retailmanagement.repository.ProductCategoryRepository;
│   │     import com.retailmanagement.repository.ProductRepository;
│   │     import com.retailmanagement.repository.ProductVariantRepository;
│   │     import lombok.RequiredArgsConstructor;
│   │     import org.springframework.data.domain.Page;
│   │     import org.springframework.data.domain.PageRequest;
│   │     import org.springframework.data.domain.Pageable;
│   │     import org.springframework.data.domain.Sort;
│   │     import org.springframework.stereotype.Service;
│   │     import org.springframework.transaction.annotation.Transactional;
│   │     import org.springframework.web.multipart.MultipartFile;
│   │     
│   │     import java.io.IOException;
│   │     import java.math.BigDecimal;
│   │     import java.nio.file.Files;
│   │     import java.nio.file.Path;
│   │     import java.nio.file.Paths;
│   │     import java.nio.file.StandardCopyOption;
│   │     import java.time.Instant;
│   │     import java.util.Comparator;
│   │     import java.util.List;
│   │     import java.util.Optional;
│   │     import java.util.UUID;
│   │     
│   │     @Service
│   │     @RequiredArgsConstructor
│   │     public class ProductService {
│   │     
│   │         private final ProductRepository productRepository;
│   │         private final CategoryRepository categoryRepository;
│   │         private final ImageRepository imageRepository;
│   │         private final ProductCategoryRepository productCategoryRepository;
│   │     
│   │         // ✅ Added for computing min price in product list
│   │         private final ProductVariantRepository productVariantRepository;
│   │     
│   │         private static final String UPLOAD_DIR = "uploads";
│   │     
│   │         @Transactional
│   │         public Product createProduct(ProductRequest request) throws IOException {
│   │             Product product = new Product();
│   │             product.setName(request.getName());
│   │             product.setSku(request.getSku());
│   │             product.setDescription(request.getDescription());
│   │             product.setIsVisible(request.getIsVisible() != null ? request.getIsVisible() : true);
│   │     
│   │             Product savedProduct = productRepository.save(product);
│   │     
│   │             if (request.getCategoryId() != null) {
│   │                 Category category = categoryRepository.findById(request.getCategoryId())
│   │                         .orElseThrow(() -> new RuntimeException("Category not found"));
│   │     
│   │                 ProductCategory pc = new ProductCategory();
│   │                 pc.setId(new ProductCategoryId(savedProduct.getId(), category.getId()));
│   │                 pc.setCategory(category);
│   │                 pc.setIsPrimary(true);
│   │                 pc.setCreatedAt(Instant.now());
│   │     
│   │                 productCategoryRepository.save(pc);
│   │             }
│   │     
│   │             MultipartFile imgFile = request.getImageFile();
│   │             if (imgFile != null && !imgFile.isEmpty()) {
│   │                 String fileName = saveFileToDisk(imgFile);
│   │     
│   │                 Image image = new Image();
│   │                 image.setProduct(savedProduct);
│   │                 image.setUrl("/uploads/" + fileName);
│   │                 image.setIsPrimary(true);
│   │                 image.setSortOrder(1);
│   │                 image.setCreatedAt(Instant.now());
│   │     
│   │                 imageRepository.save(image);
│   │             }
│   │     
│   │             return savedProduct;
│   │         }
│   │     
│   │         public Page<ProductResponse> getProducts(int page, Integer categoryId) {
│   │             Page<Product> productPage;
│   │     
│   │             // ✅ Keep fixed 20/page as required
│   │             if (categoryId != null) {
│   │                 Pageable pageable = PageRequest.of(page, 20); // ordering handled by native query ORDER BY
│   │                 productPage = productRepository.findByCategoryId(categoryId, pageable);
│   │             } else {
│   │                 Pageable pageable = PageRequest.of(page, 20, Sort.by(Sort.Direction.DESC, "createdAt"));
│   │                 productPage = productRepository.findAll(pageable);
│   │             }
│   │     
│   │             return productPage.map(this::toProductResponse);
│   │         }
│   │     
│   │         private ProductResponse toProductResponse(Product product) {
│   │             ProductResponse dto = new ProductResponse();
│   │             dto.setId(product.getId());
│   │             dto.setName(product.getName());
│   │             dto.setSku(product.getSku());
│   │             dto.setDescription(product.getDescription());
│   │             dto.setIsVisible(product.getIsVisible());
│   │             dto.setCreatedAt(product.getCreatedAt());
│   │     
│   │             imageRepository.findFirstByProductIdAndIsPrimaryTrue(product.getId())
│   │                     .ifPresent(img -> dto.setImageUrl(img.getUrl()));
│   │     
│   │             // ✅ "Display current price in product list"
│   │             // Choose min current price among variants (if you want "primary variant" instead, we can switch logic)
│   │             List<ProductVariant> variants = productVariantRepository.findByProduct_Id(product.getId());
│   │             Optional<ProductVariant> minVariantOpt = variants.stream()
│   │                     .filter(v -> v.getPrice() != null)
│   │                     .min(Comparator.comparing(ProductVariant::getPrice));
│   │     
│   │             if (minVariantOpt.isPresent()) {
│   │                 ProductVariant v = minVariantOpt.get();
│   │                 dto.setMinPrice(v.getPrice());
│   │                 dto.setCurrencyCode(v.getCurrencyCode());
│   │             } else {
│   │                 dto.setMinPrice(null);
│   │                 dto.setCurrencyCode(null);
│   │             }
│   │     
│   │             return dto;
│   │         }
│   │     
│   │         private String saveFileToDisk(MultipartFile file) throws IOException {
│   │             Path uploadPath = Paths.get(UPLOAD_DIR);
│   │             if (!Files.exists(uploadPath)) {
│   │                 Files.createDirectories(uploadPath);
│   │             }
│   │     
│   │             String original = file.getOriginalFilename();
│   │             String safeOriginal = (original == null) ? "file" : original.replaceAll("[\\\\/]+", "_");
│   │             String fileName = UUID.randomUUID() + "_" + safeOriginal;
│   │     
│   │             Files.copy(file.getInputStream(), uploadPath.resolve(fileName), StandardCopyOption.REPLACE_EXISTING);
│   │             return fileName;
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   ├── PromotionService.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.service;
│   │     
│   │     import com.fasterxml.jackson.databind.ObjectMapper;
│   │     import com.retailmanagement.dto.request.PromotionRequest;
│   │     import com.retailmanagement.entity.ProductVariant;
│   │     import com.retailmanagement.entity.Promotion;
│   │     import com.retailmanagement.repository.ProductVariantRepository;
│   │     import com.retailmanagement.repository.PromotionRepository;
│   │     import org.springframework.stereotype.Service;
│   │     import org.springframework.transaction.annotation.Transactional;
│   │     
│   │     import java.math.BigDecimal;
│   │     import java.time.LocalDateTime;
│   │     import java.util.*;
│   │     import java.util.stream.Collectors;
│   │     
│   │     @Service
│   │     public class PromotionService {
│   │     
│   │         private final PromotionRepository promoRepo;
│   │         private final ProductVariantRepository variantRepo;
│   │         private final ObjectMapper objectMapper = new ObjectMapper();
│   │     
│   │         public PromotionService(PromotionRepository promoRepo, ProductVariantRepository variantRepo) {
│   │             this.promoRepo = promoRepo;
│   │             this.variantRepo = variantRepo;
│   │         }
│   │     
│   │         // JSON format: {"scope":"ALL"} or {"product_ids":[1,2]} or {"variant_ids":[10,11]}
│   │         public static class Applicability {
│   │             public String scope;
│   │             public List<Integer> product_ids;
│   │             public List<Integer> variant_ids;
│   │         }
│   │     
│   │         private String buildApplicabilityJson(PromotionRequest req) {
│   │             try {
│   │                 Applicability a = new Applicability();
│   │                 String scope = (req.getScope() == null) ? "ALL" : req.getScope().trim().toUpperCase();
│   │                 a.scope = scope;
│   │                 a.product_ids = req.getProductIds();
│   │                 a.variant_ids = req.getVariantIds();
│   │                 return objectMapper.writeValueAsString(a);
│   │             } catch (Exception e) {
│   │                 throw new IllegalArgumentException("applicabilityJson không hợp lệ");
│   │             }
│   │         }
│   │     
│   │         private Applicability parseApplicability(String json) {
│   │             try {
│   │                 if (json == null || json.isBlank()) {
│   │                     Applicability a = new Applicability();
│   │                     a.scope = "ALL";
│   │                     return a;
│   │                 }
│   │                 return objectMapper.readValue(json, Applicability.class);
│   │             } catch (Exception e) {
│   │                 Applicability a = new Applicability();
│   │                 a.scope = "ALL";
│   │                 return a;
│   │             }
│   │         }
│   │     
│   │         private boolean dateOverlap(LocalDateTime s1, LocalDateTime e1, LocalDateTime s2, LocalDateTime e2) {
│   │             return !s1.isAfter(e2) && !e1.isBefore(s2);
│   │         }
│   │     
│   │         private boolean applicabilityOverlap(Applicability a, Applicability b, Integer newVariantId, Integer newProductId) {
│   │             String sa = (a.scope == null) ? "ALL" : a.scope.toUpperCase();
│   │             String sb = (b.scope == null) ? "ALL" : b.scope.toUpperCase();
│   │     
│   │             if ("ALL".equals(sa) || "ALL".equals(sb)) return true;
│   │     
│   │             Set<Integer> aProducts = a.product_ids == null ? Set.of() : new HashSet<>(a.product_ids);
│   │             Set<Integer> bProducts = b.product_ids == null ? Set.of() : new HashSet<>(b.product_ids);
│   │     
│   │             Set<Integer> aVariants = a.variant_ids == null ? Set.of() : new HashSet<>(a.variant_ids);
│   │             Set<Integer> bVariants = b.variant_ids == null ? Set.of() : new HashSet<>(b.variant_ids);
│   │     
│   │             // PRODUCT vs PRODUCT
│   │             if (!aProducts.isEmpty() && !bProducts.isEmpty()) {
│   │                 return !Collections.disjoint(aProducts, bProducts);
│   │             }
│   │     
│   │             // VARIANT vs VARIANT
│   │             if (!aVariants.isEmpty() && !bVariants.isEmpty()) {
│   │                 return !Collections.disjoint(aVariants, bVariants);
│   │             }
│   │     
│   │             // PRODUCT vs VARIANT => map variant->product
│   │             if (!aProducts.isEmpty() && !bVariants.isEmpty()) {
│   │                 List<ProductVariant> vs = variantRepo.findAllById(bVariants);
│   │                 Set<Integer> bVariantProducts = vs.stream().map(v -> v.getProduct().getId()).collect(Collectors.toSet());
│   │                 return !Collections.disjoint(aProducts, bVariantProducts);
│   │             }
│   │     
│   │             if (!bProducts.isEmpty() && !aVariants.isEmpty()) {
│   │                 List<ProductVariant> vs = variantRepo.findAllById(aVariants);
│   │                 Set<Integer> aVariantProducts = vs.stream().map(v -> v.getProduct().getId()).collect(Collectors.toSet());
│   │                 return !Collections.disjoint(bProducts, aVariantProducts);
│   │             }
│   │     
│   │             return false;
│   │         }
│   │     
│   │         private void assertNoDuplicatePromotion(Promotion draft, Integer ignoreId) {
│   │             LocalDateTime s = draft.getStartDate();
│   │             LocalDateTime e = draft.getEndDate();
│   │     
│   │             List<Promotion> candidates = (ignoreId == null)
│   │                     ? promoRepo.findByIsActiveTrueAndStartDateLessThanEqualAndEndDateGreaterThanEqual(e, s)
│   │                     : promoRepo.findByIsActiveTrueAndStartDateLessThanEqualAndEndDateGreaterThanEqualAndIdNot(e, s, ignoreId);
│   │     
│   │             Applicability newApp = parseApplicability(draft.getApplicabilityJson());
│   │     
│   │             List<String> conflicts = new ArrayList<>();
│   │             for (Promotion p : candidates) {
│   │                 if (!dateOverlap(p.getStartDate(), p.getEndDate(), s, e)) continue;
│   │     
│   │                 Applicability oldApp = parseApplicability(p.getApplicabilityJson());
│   │                 if (applicabilityOverlap(newApp, oldApp, null, null)) {
│   │                     conflicts.add(p.getCode());
│   │                 }
│   │             }
│   │     
│   │             if (!conflicts.isEmpty()) {
│   │                 throw new IllegalArgumentException("Trùng khuyến mãi theo thời gian/phạm vi với: " + String.join(", ", conflicts));
│   │             }
│   │         }
│   │     
│   │         @Transactional
│   │         public Promotion create(PromotionRequest req, Integer createdBy) {
│   │             if (req.getCode() == null || req.getCode().isBlank()) throw new IllegalArgumentException("code không được rỗng");
│   │             if (req.getName() == null || req.getName().isBlank()) throw new IllegalArgumentException("name không được rỗng");
│   │             if (req.getStartDate() == null || req.getEndDate() == null) throw new IllegalArgumentException("startDate/endDate bắt buộc");
│   │             if (!req.getStartDate().isBefore(req.getEndDate())) throw new IllegalArgumentException("startDate phải < endDate");
│   │     
│   │             promoRepo.findByCode(req.getCode().trim().toUpperCase()).ifPresent(x -> {
│   │                 throw new IllegalArgumentException("Promo code đã tồn tại");
│   │             });
│   │     
│   │             Promotion p = new Promotion();
│   │             p.setCode(req.getCode().trim().toUpperCase());
│   │             p.setName(req.getName().trim());
│   │             p.setDescription(req.getDescription());
│   │             p.setDiscountType(req.getDiscountType() == null ? "PERCENT" : req.getDiscountType().trim().toUpperCase());
│   │             p.setDiscountValue(req.getDiscountValue());
│   │             p.setStartDate(req.getStartDate());
│   │             p.setEndDate(req.getEndDate());
│   │             p.setPriority(req.getPriority() == null ? 0 : req.getPriority());
│   │             p.setStackable(req.getStackable() != null && req.getStackable());
│   │             p.setIsActive(req.getIsActive() == null || req.getIsActive());
│   │             p.setApplicabilityJson(buildApplicabilityJson(req));
│   │             p.setCreatedBy(createdBy);
│   │             p.setCreatedAt(LocalDateTime.now());
│   │     
│   │             assertNoDuplicatePromotion(p, null);
│   │     
│   │             return promoRepo.save(p);
│   │         }
│   │     
│   │         public List<Promotion> list(Boolean activeOnly) {
│   │             List<Promotion> all = promoRepo.findAll();
│   │             if (activeOnly != null && activeOnly) {
│   │                 return all.stream().filter(Promotion::getIsActive).toList();
│   │             }
│   │             return all;
│   │         }
│   │     
│   │         @Transactional
│   │         public Promotion update(Integer id, PromotionRequest req) {
│   │             Promotion p = promoRepo.findById(id).orElseThrow(() -> new NoSuchElementException("Promotion not found"));
│   │     
│   │             if (req.getName() != null) p.setName(req.getName().trim());
│   │             if (req.getDescription() != null) p.setDescription(req.getDescription());
│   │             if (req.getDiscountType() != null) p.setDiscountType(req.getDiscountType().trim().toUpperCase());
│   │             if (req.getDiscountValue() != null) p.setDiscountValue(req.getDiscountValue());
│   │             if (req.getStartDate() != null) p.setStartDate(req.getStartDate());
│   │             if (req.getEndDate() != null) p.setEndDate(req.getEndDate());
│   │             if (req.getPriority() != null) p.setPriority(req.getPriority());
│   │             if (req.getStackable() != null) p.setStackable(req.getStackable());
│   │             if (req.getIsActive() != null) p.setIsActive(req.getIsActive());
│   │     
│   │             // cập nhật phạm vi áp dụng nếu có gửi scope/productIds/variantIds
│   │             if (req.getScope() != null || req.getProductIds() != null || req.getVariantIds() != null) {
│   │                 p.setApplicabilityJson(buildApplicabilityJson(req));
│   │             }
│   │     
│   │             if (!p.getStartDate().isBefore(p.getEndDate())) throw new IllegalArgumentException("startDate phải < endDate");
│   │             assertNoDuplicatePromotion(p, p.getId());
│   │     
│   │             return promoRepo.save(p);
│   │         }
│   │     
│   │         @Transactional
│   │         public void delete(Integer id) {
│   │             Promotion p = promoRepo.findById(id).orElseThrow(() -> new NoSuchElementException("Promotion not found"));
│   │             // soft delete theo schema: is_active
│   │             p.setIsActive(false);
│   │             promoRepo.save(p);
│   │         }
│   │     
│   │         public Promotion findBestPromotionForVariant(ProductVariant v, LocalDateTime at) {
│   │             List<Promotion> active = promoRepo
│   │                     .findByIsActiveTrueAndStartDateLessThanEqualAndEndDateGreaterThanEqual(at, at);
│   │     
│   │             BigDecimal base = v.getPrice();
│   │             Promotion best = null;
│   │             BigDecimal bestFinal = base;
│   │     
│   │             for (Promotion p : active) {
│   │                 Applicability app = parseApplicability(p.getApplicabilityJson());
│   │                 if (!isApplicable(app, v)) continue;
│   │     
│   │                 BigDecimal finalPrice = applyDiscount(base, p.getDiscountType(), p.getDiscountValue());
│   │                 if (finalPrice.compareTo(bestFinal) < 0) {
│   │                     bestFinal = finalPrice;
│   │                     best = p;
│   │                 } else if (finalPrice.compareTo(bestFinal) == 0 && best != null) {
│   │                     if (p.getPriority() > best.getPriority()) best = p;
│   │                 }
│   │             }
│   │             return best;
│   │         }
│   │     
│   │         public boolean isApplicable(Applicability app, ProductVariant v) {
│   │             String scope = (app.scope == null) ? "ALL" : app.scope.toUpperCase();
│   │             if ("ALL".equals(scope)) return true;
│   │     
│   │             Integer productId = v.getProduct().getId();
│   │             Integer variantId = v.getId();
│   │     
│   │             if (app.product_ids != null && app.product_ids.contains(productId)) return true;
│   │             if (app.variant_ids != null && app.variant_ids.contains(variantId)) return true;
│   │     
│   │             return false;
│   │         }
│   │     
│   │         public BigDecimal applyDiscount(BigDecimal base, String type, BigDecimal value) {
│   │             if (base == null) return BigDecimal.ZERO;
│   │             if (value == null) return base;
│   │     
│   │             String t = (type == null) ? "PERCENT" : type.toUpperCase();
│   │             if ("AMOUNT".equals(t)) {
│   │                 BigDecimal r = base.subtract(value);
│   │                 return r.compareTo(BigDecimal.ZERO) < 0 ? BigDecimal.ZERO : r;
│   │             }
│   │     
│   │             // PERCENT
│   │             BigDecimal pct = value;
│   │             if (pct.compareTo(BigDecimal.ZERO) < 0) pct = BigDecimal.ZERO;
│   │             if (pct.compareTo(new BigDecimal("100")) > 0) pct = new BigDecimal("100");
│   │     
│   │             BigDecimal discount = base.multiply(pct).divide(new BigDecimal("100"));
│   │             BigDecimal r = base.subtract(discount);
│   │             return r.compareTo(BigDecimal.ZERO) < 0 ? BigDecimal.ZERO : r;
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   ├── SettingService.java
│   │   ---- CODE ----
│   │     package com.retailmanagement.service;
│   │     
│   │     import com.retailmanagement.entity.SystemSetting;
│   │     import com.retailmanagement.repository.SystemSettingRepository;
│   │     import org.springframework.stereotype.Service;
│   │     import org.springframework.transaction.annotation.Transactional;
│   │     
│   │     import java.time.LocalDateTime;
│   │     
│   │     @Service
│   │     public class SettingService {
│   │         public static final String DEFAULT_CURRENCY_KEY = "DEFAULT_CURRENCY";
│   │     
│   │         private final SystemSettingRepository repo;
│   │     
│   │         public SettingService(SystemSettingRepository repo) {
│   │             this.repo = repo;
│   │         }
│   │     
│   │         public String getDefaultCurrency() {
│   │             return repo.findById(DEFAULT_CURRENCY_KEY)
│   │                     .map(SystemSetting::getValue)
│   │                     .orElse("VND");
│   │         }
│   │     
│   │         @Transactional
│   │         public String setDefaultCurrency(String code) {
│   │             if (code == null || code.trim().length() != 3) {
│   │                 throw new IllegalArgumentException("currencyCode phải là mã 3 ký tự (VD: VND, USD)");
│   │             }
│   │             String normalized = code.trim().toUpperCase();
│   │     
│   │             SystemSetting s = repo.findById(DEFAULT_CURRENCY_KEY).orElseGet(SystemSetting::new);
│   │             s.setKey(DEFAULT_CURRENCY_KEY);
│   │             s.setValue(normalized);
│   │             s.setUpdatedAt(LocalDateTime.now());
│   │             repo.save(s);
│   │     
│   │             return normalized;
│   │         }
│   │     }
│   │     
│   │   ---- END ----
│   └── UserService.java
│       ---- CODE ----
│         package com.retailmanagement.service;
│         
│         import com.retailmanagement.audit.Audit;
│         import com.retailmanagement.audit.AuditAction;
│         import com.retailmanagement.dto.request.CreateUserRequest;
│         import com.retailmanagement.dto.request.UpdateUserRequest;
│         import com.retailmanagement.dto.response.UserResponse;
│         import com.retailmanagement.entity.User;
│         import com.retailmanagement.repository.UserRepository;
│         import jakarta.transaction.Transactional;
│         import lombok.RequiredArgsConstructor;
│         import org.springframework.security.crypto.password.PasswordEncoder;
│         import org.springframework.stereotype.Service;
│         
│         import java.util.List;
│         
│         @Service
│         @RequiredArgsConstructor
│         public class UserService {
│         
│             private final UserRepository userRepository;
│             private final PasswordEncoder passwordEncoder;
│         
│             @Audit(
│                     module = "USER",
│                     action = AuditAction.CREATE,
│                     targetType = "User"
│             )
│             @Transactional
│             public UserResponse createUser(CreateUserRequest request) {
│                 if (userRepository.existsByUsername(request.getUsername())) {
│                     throw new RuntimeException("Username đã tồn tại trong hệ thống");
│                 }
│                 if (userRepository.existsByEmail(request.getEmail())) {
│                     throw new RuntimeException("Email đã tồn tại trong hệ thống");
│                 }
│         
│                 User user = User.builder()
│                         .username(request.getUsername())
│                         .email(request.getEmail())
│                         .passwordHash(passwordEncoder.encode(request.getPassword()))
│                         .role(request.getRole())
│                         .build();
│         
│                 return toResponse(userRepository.save(user));
│             }
│         
│             public List<UserResponse> findAll() {
│                 return userRepository.findAll().stream().map(this::toResponse).toList();
│             }
│         
│             @Audit(
│                     module = "USER",
│                     action = AuditAction.UPDATE,
│                     targetType = "User"
│             )
│             @Transactional
│             public UserResponse updateUser(UpdateUserRequest request, Integer id) {
│                 User user = userRepository.findById(id)
│                         .orElseThrow(() -> new RuntimeException("User không tồn tại"));
│         
│                 if (userRepository.existsByUsernameAndIdNot(request.getUsername(), id)) {
│                     throw new RuntimeException("Username đã tồn tại trong hệ thống");
│                 }
│                 if (userRepository.existsByEmailAndIdNot(request.getEmail(), id)) {
│                     throw new RuntimeException("Email đã tồn tại trong hệ thống");
│                 }
│         
│                 user.setUsername(request.getUsername());
│                 user.setEmail(request.getEmail());
│                 user.setRole(request.getRole());
│         
│                 return toResponse(userRepository.save(user));
│             }
│         
│             @Audit(
│                     module = "USER",
│                     action = AuditAction.DELETE,
│                     targetType = "User"
│             )
│             @Transactional
│             public UserResponse deleteUser(Integer id) {
│                 User user = userRepository.findById(id)
│                         .orElseThrow(() -> new RuntimeException("User không tồn tại"));
│         
│                 user.setIsActive(false);
│                 userRepository.save(user);
│         
│                 return toResponse(user);
│             }
│         
│             private UserResponse toResponse(User user) {
│                 return UserResponse.builder()
│                         .id(user.getId())
│                         .username(user.getUsername())
│                         .email(user.getEmail())
│                         .role(user.getRole())
│                         .isActive(user.getIsActive())
│                         .createdAt(user.getCreatedAt())
│                         .updatedAt(user.getUpdatedAt())
│                         .build();
│             }
│         }
│         
│       ---- END ----
└── util
    ├── IpUtil.java
    │   ---- CODE ----
    │     package com.retailmanagement.util;
    │     
    │     import jakarta.servlet.http.HttpServletRequest;
    │     
    │     public class IpUtil {
    │     
    │         //Lấy ip của user
    │         public static String getClientIp(HttpServletRequest request) {
    │             // X-Forwared-For để lấy ip của client
    │             // Nếu ko có nó chỉ lấy ip trung gian
    │             String ip = request.getHeader("X-Forwarded-For");
    │     
    │             // Kiểm tra xem ip có bị null hay rỗng
    │             if (ip != null && !ip.isEmpty()) {
    │                 // split để lấy ip thật của client
    │                 // Các ip sau "," là các ip trung gian
    │                 return ip.split(",")[0];
    │             }
    │     
    │             // Fallback nếu không có ip
    │             return request.getRemoteAddr();
    │         }
    │     }
    │     
    │   ---- END ----
    └── SecurityUtil.java
        ---- CODE ----
          package com.retailmanagement.util;
          
          import com.retailmanagement.entity.User;
          import com.retailmanagement.security.CustomUserDetails;
          import org.springframework.security.authentication.AnonymousAuthenticationToken;
          import org.springframework.security.core.Authentication;
          import org.springframework.security.core.context.SecurityContextHolder;
          
          public class SecurityUtil {
          
              // Lấy user khi thao tác (ví dụ: khi create, update, delete)
              public static Integer getCurrentUserId() {
                  Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
          
                  // Kiểm tra xem người dùng login chưa
                  if(authentication == null || !authentication.isAuthenticated() || authentication instanceof AnonymousAuthenticationToken) {
                      return  null;
                  }
          
                  // Lấy danh tính user
                  Object principal = authentication.getPrincipal();
          
                  // Kiểm tra kiểu dữ liệu principal có phải là CustomUserDetails
                  // và tự động ép kiểu dữ liệu sang CustomUserDetails
                  if(principal instanceof CustomUserDetails userDetails) {
                      return  userDetails.getUserId();
                  }
          
                  return null;
              }
          
          }
          
        ---- END ----
